
<!DOCTYPE html>
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module Basics</title>
<meta name="description" content="Documentation of Coq module Basics" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
</head>

<body>
<h1 class="title">Module Basics</h1>
<div class="coq">
<br/>
<span class="kwd">From</span> <span class="id">Stdlib</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Classes.RelationClasses</span>.<br/>
<span class="kwd">From</span> <span class="id">Stdlib</span> <span class="kwd">Require</span> <span class="id">Morphisms</span> <span class="id">Program.Basics</span>.<br/>
<br/>
<span class="kwd">From</span> <span class="id">Staged</span> <span class="kwd">Require</span> <span class="kwd">Export</span> <span class="id">HeapF</span>.<br/>
<span class="kwd">From</span> <span class="id">Staged</span> <span class="kwd">Require</span> <span class="kwd">Export</span> <span class="id">LibFmap</span>.<br/>
<span class="kwd">From</span> <span class="id">Staged</span> <span class="kwd">Require</span> <span class="kwd">Export</span> <span class="id">EvenMoreTactics</span>.<br/>
<br/>
<span class="id">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">string_scope</span>.<br/>
<span class="id">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">Z_scope</span>.<br/>
<span class="id">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">list_scope</span>.<br/>
<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Coq.Program.Equality</span>.<br/>
<span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Coq.Logic.FunctionalExtensionality</span>.<br/>
<br/>
<span class="kwd">Set</span> <span class="kwd">Implicit</span> <span class="kwd">Arguments</span>.<br/>
<br/>
<h1> Programs </h1>
<span class="kwd">Definition</span> <span class="id">var</span> : <span class="kwd">Type</span> := <span class="id">string</span>.<br/>
<span class="kwd">Notation</span> <span class="id">var_eq</span> := <span class="id">String.string_dec</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">loc</span> := <span class="id">nat</span>.<br/>
<br/>
<span class="kwd">Inductive</span> <span class="id">val</span> :=<br/>
&nbsp;&nbsp;| <span class="id">vunit</span> : <span class="id">val</span><br/>
&nbsp;&nbsp;| <span class="id">vint</span> : <span class="id">Z</span> -&gt; <span class="id">val</span><br/>
&nbsp;&nbsp;| <span class="id">vfun</span> : <span class="id">var</span> -&gt; <span class="id">expr</span> -&gt; <span class="id">val</span><br/>
&nbsp;&nbsp;| <span class="id">vfix</span> : <span class="id">var</span> -&gt; <span class="id">var</span> -&gt; <span class="id">expr</span> -&gt; <span class="id">val</span><br/>
&nbsp;&nbsp;| <span class="id">vloc</span> : <span class="id">loc</span> -&gt; <span class="id">val</span><br/>
&nbsp;&nbsp;| <span class="id">vtup</span> : <span class="id">val</span> -&gt; <span class="id">val</span> -&gt; <span class="id">val</span><br/>
&nbsp;&nbsp;| <span class="id">vstr</span> : <span class="id">string</span> -&gt; <span class="id">val</span><br/>
&nbsp;&nbsp;| <span class="id">vbool</span> : <span class="id">bool</span> -&gt; <span class="id">val</span><br/>
&nbsp;&nbsp;| <span class="id">vlist</span> : <span class="id">list</span> <span class="id">val</span> -&gt; <span class="id">val</span><br/>
&nbsp;&nbsp;| <span class="id">vfptr</span> : <span class="id">var</span> -&gt; <span class="id">val</span><br/>
<div class="doc">A deeply-embedded function pointer, referring to a <span class="bracket"><span class="id">ufun</span></span> in the environment. </div>
<br/>
<span class="kwd">with</span> <span class="id">expr</span> : <span class="kwd">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id">pvar</span> (<span class="id">x</span>: <span class="id">var</span>)<br/>
&nbsp;&nbsp;| <span class="id">pval</span> (<span class="id">v</span>: <span class="id">val</span>)<br/>
&nbsp;&nbsp;| <span class="id">plet</span> (<span class="id">x</span>: <span class="id">var</span>) (<span class="id">e1</span> <span class="id">e2</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">pfix</span> (<span class="id">xf</span>: <span class="id">var</span>) (<span class="id">x</span>: <span class="id">var</span>) (<span class="id">e</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">pfun</span> (<span class="id">x</span>: <span class="id">var</span>) (<span class="id">e</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">padd</span> (<span class="id">e1</span> <span class="id">e2</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">pfst</span> (<span class="id">e</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">psnd</span> (<span class="id">e</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">pminus</span> (<span class="id">e1</span> <span class="id">e2</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">passert</span> (<span class="id">v</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">pref</span> (<span class="id">v</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">pderef</span> (<span class="id">v</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">passign</span> (<span class="id">e1</span>: <span class="id">expr</span>) (<span class="id">e2</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">pif</span> (<span class="id">v</span>: <span class="id">expr</span>) (<span class="id">e1</span>: <span class="id">expr</span>) (<span class="id">e2</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">papp</span> (<span class="id">e1</span>: <span class="id">expr</span>) (<span class="id">e2</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">pshift</span> (<span class="id">eb</span>: <span class="id">var</span> -&gt; <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">preset</span> (<span class="id">e</span>: <span class="id">expr</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">vadd</span> (<span class="id">v1</span> <span class="id">v2</span> : <span class="id">val</span>) : <span class="id">val</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">v1</span>, <span class="id">v2</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">vint</span> <span class="id">i1</span>, <span class="id">vint</span> <span class="id">i2</span> =&gt; <span class="id">vint</span> (<span class="id">i1</span> + <span class="id">i2</span>)<br/>
&nbsp;&nbsp;| _, _ =&gt; <span class="id">vunit</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">viop</span> <span class="id">f</span> <span class="id">a</span> <span class="id">b</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">a</span>, <span class="id">b</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">vint</span> <span class="id">a1</span>, <span class="id">vint</span> <span class="id">b1</span> =&gt; <span class="id">f</span> <span class="id">a1</span> <span class="id">b1</span><br/>
&nbsp;&nbsp;| _, _ =&gt; <span class="id">vunit</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">vbop</span> <span class="id">f</span> <span class="id">a</span> <span class="id">b</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">a</span>, <span class="id">b</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">vbool</span> <span class="id">a1</span>, <span class="id">vbool</span> <span class="id">b1</span> =&gt; <span class="id">f</span> <span class="id">a1</span> <span class="id">b1</span><br/>
&nbsp;&nbsp;| _, _ =&gt; <span class="id">vunit</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">virel</span> <span class="id">f</span> <span class="id">a</span> <span class="id">b</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">a</span>, <span class="id">b</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">vint</span> <span class="id">a1</span>, <span class="id">vint</span> <span class="id">b1</span> =&gt; <span class="id">f</span> <span class="id">a1</span> <span class="id">b1</span><br/>
&nbsp;&nbsp;| _, _ =&gt; <span class="id">False</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">vgt</span> <span class="id">a</span> <span class="id">b</span> := <span class="id">virel</span> (<span class="kwd">fun</span> <span class="id">x</span> <span class="id">y</span> =&gt; <span class="id">x</span> &gt; <span class="id">y</span>) <span class="id">a</span> <span class="id">b</span>.<br/>
<span class="kwd">Definition</span> <span class="id">vlt</span> <span class="id">a</span> <span class="id">b</span> := <span class="id">virel</span> (<span class="kwd">fun</span> <span class="id">x</span> <span class="id">y</span> =&gt; <span class="id">x</span> &lt; <span class="id">y</span>) <span class="id">a</span> <span class="id">b</span>.<br/>
<span class="kwd">Definition</span> <span class="id">vge</span> <span class="id">a</span> <span class="id">b</span> := <span class="id">virel</span> (<span class="kwd">fun</span> <span class="id">x</span> <span class="id">y</span> =&gt; <span class="id">x</span> &gt;= <span class="id">y</span>) <span class="id">a</span> <span class="id">b</span>.<br/>
<span class="kwd">Definition</span> <span class="id">vle</span> <span class="id">a</span> <span class="id">b</span> := <span class="id">virel</span> (<span class="kwd">fun</span> <span class="id">x</span> <span class="id">y</span> =&gt; <span class="id">x</span> &lt;= <span class="id">y</span>) <span class="id">a</span> <span class="id">b</span>.<br/>
<span class="kwd">Definition</span> <span class="id">veq</span> <span class="id">a</span> <span class="id">b</span> := <span class="id">virel</span> (<span class="kwd">fun</span> <span class="id">x</span> <span class="id">y</span> =&gt; <span class="id">x</span> = <span class="id">y</span>) <span class="id">a</span> <span class="id">b</span>.<br/>
<span class="kwd">Definition</span> <span class="id">vneq</span> <span class="id">a</span> <span class="id">b</span> := <span class="id">virel</span> (<span class="kwd">fun</span> <span class="id">x</span> <span class="id">y</span> =&gt; <span class="id">x</span> &lt;&gt; <span class="id">y</span>) <span class="id">a</span> <span class="id">b</span>.<br/>
<span class="kwd">Definition</span> <span class="id">vsub</span> <span class="id">a</span> <span class="id">b</span> := <span class="id">viop</span> (<span class="kwd">fun</span> <span class="id">x</span> <span class="id">y</span> =&gt; <span class="id">vint</span> (<span class="id">x</span> - <span class="id">y</span>)) <span class="id">a</span> <span class="id">b</span>.<br/>
<br/>
<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">vand</span> (<span class="id">a</span> <span class="id">b</span>:<span class="id">val</span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">a</span>, <span class="id">b</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">vbool</span> <span class="id">true</span>, _ =&gt; <span class="id">b</span><br/>
&nbsp;&nbsp;| <span class="id">vbool</span> <span class="id">false</span>, _ =&gt; <span class="id">vbool</span> <span class="id">false</span><br/>
&nbsp;&nbsp;| _, <span class="id">vbool</span> <span class="id">false</span> =&gt; <span class="id">vbool</span> <span class="id">false</span><br/>
&nbsp;&nbsp;| _, <span class="id">vbool</span> <span class="id">true</span> =&gt; <span class="id">a</span><br/>
&nbsp;&nbsp;| _, _ =&gt; <span class="id">vunit</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
#[<span class="id">global</span>]<br/>
<span class="kwd">Instance</span> <span class="id">Inhab_val</span> : <span class="id">Inhab</span> <span class="id">val</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">vunit</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Coercion</span> <span class="id">vint</span> : <span class="id">Z</span> &gt;-&gt; <span class="id">val</span>.<br/>
<span class="kwd">Coercion</span> <span class="id">vbool</span> : <span class="id">bool</span> &gt;-&gt; <span class="id">val</span>.<br/>
<br/>
<span class="kwd">Fixpoint</span> <span class="id">subst</span> (<span class="id">y</span>:<span class="id">var</span>) (<span class="id">v</span>:<span class="id">val</span>) (<span class="id">e</span>:<span class="id">expr</span>) : <span class="id">expr</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">aux</span> <span class="id">t</span> := <span class="id">subst</span> <span class="id">y</span> <span class="id">v</span> <span class="id">t</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">if_y_eq</span> <span class="id">x</span> <span class="id">t1</span> <span class="id">t2</span> := <span class="kwd">if</span> <span class="id">var_eq</span> <span class="id">x</span> <span class="id">y</span> <span class="kwd">then</span> <span class="id">t1</span> <span class="kwd">else</span> <span class="id">t2</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">pval</span> <span class="id">v</span> =&gt; <span class="id">pval</span> <span class="id">v</span><br/>
&nbsp;&nbsp;| <span class="id">padd</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">padd</span> (<span class="id">aux</span> <span class="id">e1</span>) (<span class="id">aux</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;| <span class="id">pminus</span> <span class="id">x</span> <span class="id">z</span> =&gt; <span class="id">pminus</span> <span class="id">x</span> <span class="id">z</span><br/>
&nbsp;&nbsp;| <span class="id">pfst</span> <span class="id">x</span> =&gt; <span class="id">pfst</span> <span class="id">x</span><br/>
&nbsp;&nbsp;| <span class="id">psnd</span> <span class="id">x</span> =&gt; <span class="id">psnd</span> <span class="id">x</span><br/>
&nbsp;&nbsp;| <span class="id">pvar</span> <span class="id">x</span> =&gt; <span class="id">if_y_eq</span> <span class="id">x</span> (<span class="id">pval</span> <span class="id">v</span>) <span class="id">e</span><br/>
&nbsp;&nbsp;| <span class="id">passert</span> <span class="id">b</span> =&gt; <span class="id">passert</span> (<span class="id">aux</span> <span class="id">b</span>)<br/>
&nbsp;&nbsp;| <span class="id">pderef</span> <span class="id">r</span> =&gt; <span class="id">pderef</span> (<span class="id">aux</span> <span class="id">r</span>)<br/>
&nbsp;&nbsp;| <span class="id">passign</span> <span class="id">x</span> <span class="id">z</span> =&gt; <span class="id">passign</span> (<span class="id">aux</span> <span class="id">x</span>) (<span class="id">aux</span> <span class="id">z</span>)<br/>
&nbsp;&nbsp;| <span class="id">pref</span> <span class="id">v</span> =&gt; <span class="id">pref</span> (<span class="id">aux</span> <span class="id">v</span>)<br/>
&nbsp;&nbsp;| <span class="id">pfun</span> <span class="id">x</span> <span class="id">t1</span> =&gt; <span class="id">pfun</span> <span class="id">x</span> (<span class="id">if_y_eq</span> <span class="id">x</span> <span class="id">t1</span> (<span class="id">aux</span> <span class="id">t1</span>))<br/>
&nbsp;&nbsp;| <span class="id">pfix</span> <span class="id">f</span> <span class="id">x</span> <span class="id">t1</span> =&gt; <span class="id">pfix</span> <span class="id">f</span> <span class="id">x</span> (<span class="id">if_y_eq</span> <span class="id">f</span> <span class="id">t1</span> (<span class="id">if_y_eq</span> <span class="id">x</span> <span class="id">t1</span> (<span class="id">aux</span> <span class="id">t1</span>)))<br/>
&nbsp;&nbsp;| <span class="id">papp</span> <span class="id">e1</span> <span class="id">e2</span> =&gt; <span class="id">papp</span> (<span class="id">aux</span> <span class="id">e1</span>) (<span class="id">aux</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;| <span class="id">plet</span> <span class="id">x</span> <span class="id">t1</span> <span class="id">t2</span> =&gt; <span class="id">plet</span> <span class="id">x</span> (<span class="id">aux</span> <span class="id">t1</span>) (<span class="id">if_y_eq</span> <span class="id">x</span> <span class="id">t2</span> (<span class="id">aux</span> <span class="id">t2</span>))<br/>
&nbsp;&nbsp;| <span class="id">pif</span> <span class="id">t0</span> <span class="id">t1</span> <span class="id">t2</span> =&gt; <span class="id">pif</span> (<span class="id">aux</span> <span class="id">t0</span>) (<span class="id">aux</span> <span class="id">t1</span>) (<span class="id">aux</span> <span class="id">t2</span>)<br/>
&nbsp;&nbsp;| <span class="id">pshift</span> <span class="id">e</span> =&gt; <span class="id">pshift</span> (<span class="kwd">fun</span> <span class="id">k</span> =&gt; <span class="id">aux</span> (<span class="id">e</span> <span class="id">k</span>))<br/>
&nbsp;&nbsp;| <span class="id">preset</span> <span class="id">e</span> =&gt; <span class="id">preset</span> (<span class="id">aux</span> <span class="id">e</span>)<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Module</span> <span class="id">Val</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">value</span> := <span class="id">val</span>.<br/>
<span class="kwd">End</span> <span class="id">Val</span>.<br/>
<br/>
<span class="kwd">Module</span> <span class="kwd">Export</span> <span class="id">Heap</span> := <span class="id">HeapF.HeapSetup</span> <span class="id">Val</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">empty_heap</span> : <span class="id">heap</span> := <span class="id">Fmap.empty</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">postcond</span> := <span class="id">val</span> -&gt; <span class="id">hprop</span>.<br/>
<br/>
<h1> Staged formulae </h1>
<span class="kwd">Inductive</span> <span class="id">flow</span> : <span class="kwd">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id">req</span> : <span class="id">hprop</span> -&gt; <span class="id">flow</span> -&gt; <span class="id">flow</span><br/>
&nbsp;&nbsp;| <span class="id">ens</span> : <span class="id">postcond</span> -&gt; <span class="id">flow</span><br/>
&nbsp;&nbsp;| <span class="id">bind</span> : <span class="id">flow</span> -&gt; (<span class="id">val</span> -&gt; <span class="id">flow</span>) -&gt; <span class="id">flow</span><br/>
&nbsp;&nbsp;| <span class="id">fex</span> : <span class="kwd">forall</span> (<span class="id">A</span>:<span class="kwd">Type</span>), (<span class="id">A</span> -&gt; <span class="id">flow</span>) -&gt; <span class="id">flow</span><br/>
&nbsp;&nbsp;| <span class="id">fall</span> : <span class="kwd">forall</span> (<span class="id">A</span>:<span class="kwd">Type</span>), (<span class="id">A</span> -&gt; <span class="id">flow</span>) -&gt; <span class="id">flow</span><br/>
&nbsp;&nbsp;| <span class="id">unk</span> : <span class="id">var</span> -&gt; <span class="id">val</span> -&gt; <span class="id">flow</span><br/>
&nbsp;&nbsp;| <span class="id">intersect</span> : <span class="id">flow</span> -&gt; <span class="id">flow</span> -&gt; <span class="id">flow</span><br/>
&nbsp;&nbsp;| <span class="id">disj</span> : <span class="id">flow</span> -&gt; <span class="id">flow</span> -&gt; <span class="id">flow</span><br/>
<div class="doc">The following are new: </div>
&nbsp;&nbsp;| <span class="id">shc</span> : <span class="id">var</span> -&gt; <span class="id">flow</span> -&gt; (<span class="id">val</span> -&gt; <span class="id">flow</span>) -&gt; <span class="id">flow</span><br/>
<div class="doc"><span class="bracket"><span class="id">sh</span> <span class="id">k</span> <span class="id">fb</span> <span class="id">vr</span></span> is a shift with body <span class="bracket"><span class="id">fb</span></span> and <i>result</i> <span class="bracket"><span class="id">vr</span></span>. </div>
<div class="doc"><span class="bracket"><span class="id">k</span></span> names the continuation delimited by an enclosing <span class="bracket"><span class="id">rs</span></span>, and may occur in <span class="bracket"><span class="id">fb</span></span> as an <span class="bracket"><span class="id">unk</span></span> or <span class="bracket"><span class="id">vfptr</span></span>. </div>
<div class="doc"><span class="bracket"><span class="id">vr</span></span> is the <i>result</i> of the shift, which is the value a shift appears to evaluate to when a continuation is taken. <span class="bracket"><span class="id">vr</span></span> will be equal to the value that the continuation will be resumed with, and can be depended on in anything sequenced after a <span class="bracket"><span class="id">sh</span></span>. </div>
<div class="doc"><span class="bracket"><span class="id">shc</span> <span class="id">k</span> <span class="id">fb</span> <span class="id">vr</span> <span class="id">fc</span></span> is a <span class="bracket"><span class="id">sh</span></span> in CPS form, or the syntactic counterpart of <span class="bracket"><span class="id">shft</span></span>. It carries a continuation whose argument is the equivalent of <span class="bracket"><span class="id">sh</span></span>'s <span class="bracket"><span class="id">r</span></span>. This continuation has a mixed first-/higher-order representation and has a <span class="bracket"><span class="id">rs</span></span> as its topmost form. </div>
<div class="doc">Examples:
<ul>
<li>
 the formula <span class="bracket"><span class="id">Sh</span>#(<span class="id">k</span>. <span class="id">fb</span>, <span class="id">vr</span>, <span class="id">Rs</span>(<span class="id">fc</span>, <span class="id">r</span>))</span> is represented as
  <span class="bracket"><span class="id">shc</span> <span class="string">"k"</span> <span class="id">fb</span> <span class="id">vr</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; <span class="id">rs</span> <span class="id">fc</span> <span class="id">r</span>)]<br/>
- <span class="id">the</span> <span class="id">continuation</span> [(<span class="id">λ</span> <span class="id">vr</span>. &lt; <span class="id">fc</span> &gt;)] <span class="id">is</span> <span class="id">represented</span> <span class="kwd">as</span><br/>
&nbsp;&nbsp;<span class="id">a</span> <span class="id">tuple</span> [(<span class="id">vr</span>, <span class="kwd">fun</span> <span class="id">r</span> =&gt; <span class="id">rs</span> <span class="id">fc</span> <span class="id">r</span>)]. *)<br/>
&nbsp;&nbsp;| <span class="id">rs</span> : <span class="id">flow</span> -&gt; <span class="id">flow</span><br/>
<div class="doc"><span class="bracket"><span class="id">rs</span> <span class="id">f</span> <span class="id">vr</span></span> is a reset with body <span class="bracket"><span class="id">f</span></span> and return value <span class="bracket"><span class="id">vr</span></span>. </li>
</ul>
</div>
&nbsp;&nbsp;| <span class="id">defun</span> : <span class="id">var</span> -&gt; (<span class="id">val</span> -&gt; <span class="id">flow</span>) -&gt; <span class="id">flow</span><br/>
&nbsp;&nbsp;| <span class="id">discard</span> : <span class="id">var</span> -&gt; <span class="id">flow</span><br/>
<div class="doc"><span class="bracket"><span class="id">defun</span> <span class="id">x</span> <span class="id">uf</span></span> is equivalent to <span class="bracket"><span class="id">ens_</span> (<span class="id">x</span>=(<span class="id">λ</span> <span class="id">x</span> <span class="id">r</span>. <span class="id">uf</span> <span class="id">x</span> <span class="id">r</span>))</span>, where <span class="bracket"><span class="id">x</span></span> can reside in the environment (which regular <span class="bracket"><span class="id">ens_</span></span> cannot access).
  Should defun be scoped? We don't think so, because the resulting continuation is first-class and does not have a well-defined lifetime. </div>
&nbsp;&nbsp;.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">seq</span> (<span class="id">f1</span> <span class="id">f2</span>:<span class="id">flow</span>) := <span class="id">bind</span> <span class="id">f1</span> (<span class="kwd">fun</span> _ =&gt; <span class="id">f2</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">sh</span> <span class="id">k</span> <span class="id">fb</span> := <span class="id">shc</span> <span class="id">k</span> <span class="id">fb</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; \[<span class="id">r</span> = <span class="id">v</span>])).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">ens_</span> <span class="id">H</span> := <span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; \[<span class="id">r</span> = <span class="id">vunit</span>] \* <span class="id">H</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">empty</span> := <span class="id">ens_</span> \[<span class="id">True</span>].<br/>
<br/>
<span class="kwd">Notation</span> <span class="id">req_</span> <span class="id">H</span> := (<span class="id">req</span> <span class="id">H</span> <span class="id">empty</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">ufun</span> := <span class="id">val</span> -&gt; <span class="id">flow</span>.<br/>
<br/>
#[<span class="id">global</span>]<br/>
<span class="kwd">Instance</span> <span class="id">Inhab_ufun</span> : <span class="id">Inhab</span> <span class="id">ufun</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="kwd">fun</span> (<span class="id">v</span>:<span class="id">val</span>) =&gt; <span class="id">ens_</span> \[]).<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Definition</span> <span class="id">senv</span> := <span class="id">Fmap.fmap</span> <span class="id">var</span> <span class="id">ufun</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">empty_env</span> : <span class="id">senv</span> := <span class="id">Fmap.empty</span>.<br/>
<br/>
<span class="kwd">Inductive</span> <span class="id">result</span> : <span class="kwd">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id">norm</span> : <span class="id">val</span> -&gt; <span class="id">result</span><br/>
&nbsp;&nbsp;| <span class="id">shft</span> : <span class="id">var</span> -&gt; <span class="id">flow</span> -&gt; (<span class="id">val</span> -&gt; <span class="id">flow</span>) -&gt; <span class="id">result</span>.<br/>
<div class="doc">See <span class="bracket"><span class="id">shc</span></span> for what the arguments mean. </div>
<br/>
<span class="id">Declare</span> <span class="kwd">Scope</span> <span class="id">flow_scope</span>.<br/>
<span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">flow_scope</span>.<br/>
<br/>
<span class="kwd">Infix</span> <span class="string">";;"</span> := <span class="id">seq</span> (<span class="kwd">at</span> <span class="id">level</span> 38, <span class="id">right</span> <span class="id">associativity</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<span class="kwd">Notation</span> <span class="string">"'let' x '=' f1 'in' f2"</span> :=<br/>
&nbsp;&nbsp;(<span class="id">bind</span> <span class="id">f1</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">f2</span>))<br/>
&nbsp;&nbsp;(<span class="kwd">at</span> <span class="id">level</span> 38, <span class="id">x</span> <span class="id">binder</span>, <span class="id">right</span> <span class="id">associativity</span>, <span class="id">only</span> <span class="id">printing</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<br/>
<br/>
<span class="kwd">Notation</span> <span class="string">"'∃' x1 .. xn , H"</span> :=<br/>
&nbsp;&nbsp;(<span class="id">fex</span> (<span class="kwd">fun</span> <span class="id">x1</span> =&gt; .. (<span class="id">fex</span> (<span class="kwd">fun</span> <span class="id">xn</span> =&gt; <span class="id">H</span>)) ..))<br/>
&nbsp;&nbsp;(<span class="kwd">at</span> <span class="id">level</span> 39, <span class="id">x1</span> <span class="id">binder</span>, <span class="id">H</span> <span class="kwd">at</span> <span class="id">level</span> 50, <span class="id">right</span> <span class="id">associativity</span>,<br/>
&nbsp;&nbsp;&nbsp;<span class="id">format</span> <span class="string">"'[' '∃' '/ '  x1  ..  xn , '/ '  H ']'"</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<span class="kwd">Notation</span> <span class="string">"'∀' x1 .. xn , H"</span> :=<br/>
&nbsp;&nbsp;(<span class="id">fall</span> (<span class="kwd">fun</span> <span class="id">x1</span> =&gt; .. (<span class="id">fall</span> (<span class="kwd">fun</span> <span class="id">xn</span> =&gt; <span class="id">H</span>)) ..))<br/>
&nbsp;&nbsp;(<span class="kwd">at</span> <span class="id">level</span> 39, <span class="id">x1</span> <span class="id">binder</span>, <span class="id">H</span> <span class="kwd">at</span> <span class="id">level</span> 50, <span class="id">right</span> <span class="id">associativity</span>,<br/>
&nbsp;&nbsp;&nbsp;<span class="id">format</span> <span class="string">"'[' '∀' '/ '  x1  ..  xn , '/ '  H ']'"</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<span class="kwd">Notation</span> <span class="string">"f '$' '(' x ',' r ')'"</span> := (<span class="id">unk</span> <span class="id">f</span> <span class="id">x</span> <span class="id">r</span>)<br/>
&nbsp;&nbsp;(<span class="kwd">at</span> <span class="id">level</span> 80, <span class="id">format</span> <span class="string">"f '$' '(' x ','  r ')'"</span>, <span class="id">only</span> <span class="id">printing</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<br/>
<br/>
<span class="kwd">Notation</span> <span class="string">"'sh' '(' k '.' fb '),' vr"</span> := (<span class="id">sh</span> <span class="id">k</span> <span class="id">fb</span> <span class="id">vr</span>)<br/>
&nbsp;&nbsp;(<span class="kwd">at</span> <span class="id">level</span> 80, <span class="id">format</span> <span class="string">"'sh'  '(' k '.'  fb '),'  vr"</span>, <span class="id">only</span> <span class="id">printing</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<br/>
<span class="kwd">Notation</span> <span class="string">"'ens' r '.' Q"</span> := (<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; <span class="id">Q</span>))<br/>
&nbsp;&nbsp;(<span class="kwd">at</span> <span class="id">level</span> 80, <span class="id">format</span> <span class="string">"'ens'  r '.'  Q"</span> , <span class="id">only</span> <span class="id">printing</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">s</span> : <span class="id">senv</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">h</span> : <span class="id">heap</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">H</span> : <span class="id">hprop</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">Q</span> : <span class="id">postcond</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">u</span> : <span class="id">ufun</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">f</span> : <span class="id">flow</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">fk</span> : <span class="id">val</span> -&gt; <span class="id">flow</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">x</span> <span class="id">y</span> <span class="id">z</span> <span class="id">k</span> : <span class="id">var</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">a</span> <span class="id">v</span> <span class="id">r</span> : <span class="id">val</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">R</span> : <span class="id">result</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">e</span> : <span class="id">expr</span>.<br/>
<br/>
<h1> Interpretation of a staged formula </h1>
<span class="kwd">Inductive</span> <span class="id">satisfies</span> : <span class="id">senv</span> -&gt; <span class="id">senv</span> -&gt; <span class="id">heap</span> -&gt; <span class="id">heap</span> -&gt; <span class="id">result</span> -&gt; <span class="id">flow</span> -&gt; <span class="kwd">Prop</span> :=<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_req</span> : <span class="kwd">forall</span> (<span class="id">s1</span> <span class="id">s2</span>:<span class="id">senv</span>) <span class="id">H</span> (<span class="id">h1</span> <span class="id">h2</span>:<span class="id">heap</span>) <span class="id">R</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> (<span class="id">hp</span> <span class="id">hr</span>:<span class="id">heap</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">H</span> <span class="id">hp</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h1</span> = <span class="id">Fmap.union</span> <span class="id">hr</span> <span class="id">hp</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Fmap.disjoint</span> <span class="id">hr</span> <span class="id">hp</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">hr</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">req</span> <span class="id">H</span> <span class="id">f</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_ens</span> : <span class="kwd">forall</span> <span class="id">s1</span> <span class="id">Q</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">exists</span> <span class="id">v</span> <span class="id">h3</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">R</span> = <span class="id">norm</span> <span class="id">v</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Q</span> <span class="id">v</span> <span class="id">h3</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h2</span> = <span class="id">Fmap.union</span> <span class="id">h1</span> <span class="id">h3</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Fmap.disjoint</span> <span class="id">h1</span> <span class="id">h3</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s1</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens</span> <span class="id">Q</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_bind</span> : <span class="kwd">forall</span> <span class="id">s3</span> <span class="id">h3</span> <span class="id">v</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">f1</span> (<span class="id">f2</span>:<span class="id">val</span>-&gt;<span class="id">flow</span>) <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s3</span> <span class="id">h1</span> <span class="id">h3</span> (<span class="id">norm</span> <span class="id">v</span>) <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s3</span> <span class="id">s2</span> <span class="id">h3</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">f2</span> <span class="id">v</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">bind</span> <span class="id">f1</span> <span class="id">f2</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_fex</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">A</span>:<span class="kwd">Type</span>) (<span class="id">f</span>:<span class="id">A</span>-&gt;<span class="id">flow</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H</span>: <span class="kwd">exists</span> <span class="id">b</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">f</span> <span class="id">b</span>)) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (@<span class="id">fex</span> <span class="id">A</span> <span class="id">f</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_fall</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">A</span>:<span class="kwd">Type</span>) (<span class="id">f</span>:<span class="id">A</span>-&gt;<span class="id">flow</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H</span>: <span class="kwd">forall</span> <span class="id">b</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">f</span> <span class="id">b</span>)) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (@<span class="id">fall</span> <span class="id">A</span> <span class="id">f</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_unk</span> : <span class="kwd">forall</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">xf</span> <span class="id">uf</span> <span class="id">a</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Fmap.read</span> <span class="id">s1</span> <span class="id">xf</span> = <span class="id">uf</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">uf</span> <span class="id">a</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">unk</span> <span class="id">xf</span> <span class="id">a</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_intersect</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span> <span class="id">f2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H1</span>: <span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H2</span>: <span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f2</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">intersect</span> <span class="id">f1</span> <span class="id">f2</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_disj_l</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span> <span class="id">f2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H</span>: <span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">disj</span> <span class="id">f1</span> <span class="id">f2</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_disj_r</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span> <span class="id">f2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H</span>: <span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f2</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">disj</span> <span class="id">f1</span> <span class="id">f2</span>)<br/>
<br/>
<div class="doc">The new rules for shift/reset are as follows. </div>
<br/>
&nbsp;&nbsp;| <span class="id">s_shc</span> : <span class="kwd">forall</span> <span class="id">s1</span> <span class="id">h1</span> <span class="id">fb</span> <span class="id">fk</span> <span class="id">k</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;~ <span class="id">Fmap.indom</span> <span class="id">s1</span> <span class="id">k</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s1</span> <span class="id">h1</span> <span class="id">h1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">shft</span> <span class="id">k</span> <span class="id">fb</span> <span class="id">fk</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">shc</span> <span class="id">k</span> <span class="id">fb</span> <span class="id">fk</span>)<br/>
<br/>
<div class="doc">A <span class="bracket"><span class="id">sh</span></span> on its own reduces to a <span class="bracket"><span class="id">shft</span></span> containing an identity continuation. </div>
<br/>
<div class="doc"><span class="bracket"><span class="id">shc</span></span> corresponds directly to <span class="bracket"><span class="id">shft</span></span>. </div>
<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_bind_sh</span> : <span class="kwd">forall</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">f1</span> (<span class="id">f2</span>:<span class="id">val</span>-&gt;<span class="id">flow</span>) <span class="id">fk</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">fb</span> <span class="id">k</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">shft</span> <span class="id">k</span> <span class="id">fb</span> <span class="id">fk</span>) <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">shft</span> <span class="id">k</span> <span class="id">fb</span> (<span class="kwd">fun</span> <span class="id">r1</span> =&gt; <span class="id">bind</span> (<span class="id">fk</span> <span class="id">r1</span>) <span class="id">f2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">bind</span> <span class="id">f1</span> <span class="id">f2</span>)<br/>
<br/>
<div class="doc">This rule extends the continuation in a <span class="bracket"><span class="id">shft</span></span> on the left side of a <span class="bracket"><span class="id">seq</span></span>. Notably, it moves whatever comes next <i>under the reset</i>, preserving shift-freedom by constructon. </div>
<br/>
&nbsp;&nbsp;| <span class="id">s_rs_sh</span> : <span class="kwd">forall</span> <span class="id">k</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">fr</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">rf</span> <span class="id">s3</span> <span class="id">h3</span> <span class="id">fb</span> <span class="id">fk</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s3</span> <span class="id">h1</span> <span class="id">h3</span> (<span class="id">shft</span> <span class="id">k</span> <span class="id">fb</span> <span class="id">fk</span>) <span class="id">fr</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> (<span class="id">Fmap.update</span> <span class="id">s3</span> <span class="id">k</span> (<span class="kwd">fun</span> <span class="id">a</span> =&gt; <span class="id">rs</span> (<span class="id">fk</span> <span class="id">a</span>))) <span class="id">s2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h3</span> <span class="id">h2</span> <span class="id">rf</span> (<span class="id">rs</span> <span class="id">fb</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">rf</span> (<span class="id">rs</span> <span class="id">fr</span>)<br/>
<br/>
<div class="doc">This rule applies when the body of a <span class="bracket"><span class="id">rs</span></span> <i>evaluates to</i> a <span class="bracket"><span class="id">shft</span></span> (not when a <span class="bracket"><span class="id">sh</span></span> is directly inside a <span class="bracket"><span class="id">rs</span></span>; that happens in reduction). The continuation carried by the <span class="bracket"><span class="id">shft</span></span> is known, so it is bound in (the environment of) the <span class="bracket"><span class="id">sh</span></span>ift body before that is run. </div>
<div class="doc">The two resets in the semantics are accounted for: one is around the shift body, and one is already the topmost form in the continuation. </div>
<div class="doc">Note: because staged formulae are turned into values (via <span class="bracket"><span class="id">shft</span></span> and being added to the <span class="bracket"><span class="id">senv</span></span>), rewriting can no longer be done to weaken them. Environment entailment was an attempt at solving this problem; the Proper instances might have to be tweaked to allow rewriting too. Another possible solution is a syntactic entailment relation in the relevant rules to allow weakening. </div>
<br/>
&nbsp;&nbsp;| <span class="id">s_rs_val</span> : <span class="kwd">forall</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">v</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">v</span>) <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">v</span>) (<span class="id">rs</span> <span class="id">f</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_defun</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">x</span> <span class="id">uf</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;~ <span class="id">Fmap.indom</span> <span class="id">s1</span> <span class="id">x</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">s2</span> = <span class="id">Fmap.update</span> <span class="id">s1</span> <span class="id">x</span> <span class="id">uf</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h1</span> (<span class="id">norm</span> <span class="id">vunit</span>) (<span class="id">defun</span> <span class="id">x</span> <span class="id">uf</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_discard</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h</span> (<span class="id">f</span>:<span class="id">var</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">s2</span> = <span class="id">Fmap.remove</span> <span class="id">s1</span> <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h</span> <span class="id">h</span> (<span class="id">norm</span> <span class="id">vunit</span>) (<span class="id">discard</span> <span class="id">f</span>)<br/>
<br/>
&nbsp;&nbsp;.<br/>
<br/>
<span class="kwd">Notation</span> <span class="string">"s1 ',' s2 ','  h1 ','  h2 ','  r  '|=' f"</span> :=<br/>
&nbsp;&nbsp;(<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">r</span> <span class="id">f</span>) (<span class="kwd">at</span> <span class="id">level</span> 30, <span class="id">only</span> <span class="id">printing</span>).<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">s_sh</span> : <span class="kwd">forall</span> <span class="id">s1</span> <span class="id">h1</span> <span class="id">fb</span> <span class="id">k</span>,<br/>
&nbsp;&nbsp;~ <span class="id">Fmap.indom</span> <span class="id">s1</span> <span class="id">k</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s1</span> <span class="id">h1</span> <span class="id">h1</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">shft</span> <span class="id">k</span> <span class="id">fb</span> (<span class="kwd">fun</span> <span class="id">r1</span> =&gt; <span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; \[<span class="id">r</span> = <span class="id">r1</span>])))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">sh</span> <span class="id">k</span> <span class="id">fb</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">sh</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">applys</span>* <span class="id">s_shc</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Ltac</span> <span class="id">heaps</span> :=<br/>
&nbsp;&nbsp;<span class="id">lazymatch</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">H</span>: <span class="kwd">exists</span> _, _ |- _ =&gt; <span class="id">destr</span> <span class="id">H</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| <span class="id">H</span>: _ /\ _ |- _ =&gt; <span class="id">destr</span> <span class="id">H</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| <span class="id">H</span>: <span class="id">norm</span> _ = <span class="id">norm</span> _ |- _ =&gt; <span class="id">injects</span> <span class="id">H</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| <span class="id">H</span>: (_ ~~&gt; _) _ |- _ =&gt; <span class="id">hinv</span> <span class="id">H</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| <span class="id">H</span>: \[_] _ |- _ =&gt; <span class="id">hinv</span> <span class="id">H</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| <span class="id">H</span>: (_ \* _) _ |- _ =&gt; <span class="id">hinv</span> <span class="id">H</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| <span class="id">H</span>: <span class="id">hexists</span> (_) _ |- _ =&gt; <span class="id">hinv</span> <span class="id">H</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| |- (_ ~~&gt; _) _ =&gt; <span class="id">hintro</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| |- (_ \* _) _ =&gt; <span class="id">hintro</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| |- \[_] _ =&gt; <span class="id">hintro</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| |- _ /\ _ =&gt; <span class="id">splits</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| |- <span class="kwd">exists</span> _, _ =&gt; <span class="id">eexists</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| _ =&gt; <span class="id">subst</span>; <span class="id">rew_fmap</span> *<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">s_seq</span> : <span class="kwd">forall</span> <span class="id">s3</span> <span class="id">h3</span> <span class="id">r1</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s3</span> <span class="id">h1</span> <span class="id">h3</span> (<span class="id">norm</span> <span class="id">r1</span>) <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s3</span> <span class="id">s2</span> <span class="id">h3</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">seq</span> <span class="id">f1</span> <span class="id">f2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">seq</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">applys</span>* <span class="id">s_bind</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Notation</span> <span class="id">s_seq_sh</span> := <span class="id">s_bind_sh</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">s_ens_</span> : <span class="kwd">forall</span> <span class="id">H</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">s1</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">exists</span> <span class="id">h3</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">H</span> <span class="id">h3</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h2</span> = <span class="id">Fmap.union</span> <span class="id">h1</span> <span class="id">h3</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Fmap.disjoint</span> <span class="id">h1</span> <span class="id">h3</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s1</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">vunit</span>) (<span class="id">ens_</span> <span class="id">H</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">ens_</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">applys</span>* <span class="id">s_ens</span>.<br/>
&nbsp;&nbsp;<span class="id">heaps</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">A specialization of <span class="bracket"><span class="id">equal_f</span></span> for exposing the equalities in continuations after inversion. </div>
<br/>
<br/>
<br/>
<h1> Entailment </h1>
<span class="kwd">Definition</span> <span class="id">entails</span> (<span class="id">f1</span> <span class="id">f2</span>:<span class="id">flow</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span> -&gt; <span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f2</span>.<br/>
<br/>
<span class="kwd">Infix</span> <span class="string">"⊑"</span> := <span class="id">entails</span> (<span class="kwd">at</span> <span class="id">level</span> 90, <span class="id">right</span> <span class="id">associativity</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<span class="kwd">Inductive</span> <span class="id">gentails_under</span> : <span class="id">senv</span> -&gt; <span class="id">nat</span> -&gt; <span class="id">flow</span> -&gt; <span class="id">flow</span> -&gt; <span class="kwd">Prop</span> :=<br/>
<br/>
&nbsp;&nbsp;| <span class="id">geu_base</span> : <span class="kwd">forall</span> <span class="id">s1</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">v</span>) <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">v</span>) <span class="id">f2</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">gentails_under</span> <span class="id">s1</span> <span class="id">O</span> <span class="id">f1</span> <span class="id">f2</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">geu_shift</span> : <span class="kwd">forall</span> <span class="id">s1</span> <span class="id">n</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">k</span> <span class="id">fb</span> <span class="id">fk</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">shft</span> <span class="id">k</span> <span class="id">fb</span> <span class="id">fk</span>) <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">fb1</span> <span class="id">fk1</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">shft</span> <span class="id">k</span> <span class="id">fb1</span> <span class="id">fk1</span>) <span class="id">f2</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">gentails_under</span> <span class="id">s1</span> <span class="id">n</span> <span class="id">fb</span> <span class="id">fb1</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">v</span>, <span class="id">gentails_under</span> <span class="id">s1</span> <span class="id">n</span> (<span class="id">fk</span> <span class="id">v</span>) (<span class="id">fk1</span> <span class="id">v</span>)) -&gt;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">gentails_under</span> <span class="id">s1</span> (<span class="id">S</span> <span class="id">n</span>) <span class="id">f1</span> <span class="id">f2</span>.<br/>
<br/>
<span class="kwd">Notation</span> <span class="string">"env '⊢' f1 '⊆' f2"</span> :=<br/>
&nbsp;&nbsp;(<span class="id">gentails_under</span> <span class="id">env</span> _ <span class="id">f1</span> <span class="id">f2</span>) (<span class="kwd">at</span> <span class="id">level</span> 90, <span class="id">only</span> <span class="id">printing</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<br/>
<span class="kwd">Inductive</span> <span class="id">gentails</span> : <span class="id">nat</span> -&gt; <span class="id">flow</span> -&gt; <span class="id">flow</span> -&gt; <span class="kwd">Prop</span> :=<br/>
<br/>
&nbsp;&nbsp;| <span class="id">ge_base</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">v</span>) <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">v</span>) <span class="id">f2</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">gentails</span> <span class="id">O</span> <span class="id">f1</span> <span class="id">f2</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">ge_shift</span> : <span class="kwd">forall</span> <span class="id">n</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">k</span> <span class="id">fb</span> <span class="id">fk</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">shft</span> <span class="id">k</span> <span class="id">fb</span> <span class="id">fk</span>) <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">fb1</span> <span class="id">fk1</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">shft</span> <span class="id">k</span> <span class="id">fb1</span> <span class="id">fk1</span>) <span class="id">f2</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">gentails</span> <span class="id">n</span> <span class="id">fb</span> <span class="id">fb1</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">v</span>, <span class="id">gentails</span> <span class="id">n</span> (<span class="id">fk</span> <span class="id">v</span>) (<span class="id">fk1</span> <span class="id">v</span>)) -&gt;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">gentails</span> (<span class="id">S</span> <span class="id">n</span>) <span class="id">f1</span> <span class="id">f2</span>.<br/>
<br/>
<span class="kwd">Notation</span> <span class="string">"f1 '⊆' n f2"</span> :=<br/>
&nbsp;&nbsp;(<span class="id">gentails</span> <span class="id">n</span> <span class="id">f1</span> <span class="id">f2</span>) (<span class="kwd">at</span> <span class="id">level</span> 90, <span class="id">only</span> <span class="id">printing</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">entails_gentails</span>: <span class="kwd">forall</span> <span class="id">n</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f1</span> <span class="id">f2</span> -&gt; <span class="id">gentails</span> <span class="id">n</span> <span class="id">f1</span> <span class="id">f2</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">n</span>. <span class="id">induction</span> <span class="id">n</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;{ <span class="id">applys</span>* <span class="id">ge_base</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">applys</span> <span class="id">ge_shift</span>. <span class="id">jauto</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Definition</span> <span class="id">entails_under</span> <span class="id">s1</span> <span class="id">f1</span> <span class="id">f2</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">s2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span> -&gt; <span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f2</span>.<br/>
<br/>
<span class="kwd">Notation</span> <span class="string">"env '⊢' f1 '⊑' f2"</span> :=<br/>
&nbsp;&nbsp;(<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f1</span> <span class="id">f2</span>) (<span class="kwd">at</span> <span class="id">level</span> 90, <span class="id">only</span> <span class="id">printing</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">entails_under_gentails_under</span>: <span class="kwd">forall</span> <span class="id">n</span> <span class="id">s1</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">s1</span> <span class="id">f1</span> <span class="id">f2</span> -&gt; <span class="id">gentails_under</span> <span class="id">s1</span> <span class="id">n</span> <span class="id">f1</span> <span class="id">f2</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">n</span>. <span class="id">induction</span> <span class="id">n</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;{ <span class="id">applys</span>* <span class="id">geu_base</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">applys</span> <span class="id">geu_shift</span>. <span class="id">jauto</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Definition</span> <span class="id">bientails</span> (<span class="id">f1</span> <span class="id">f2</span>:<span class="id">flow</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">s1</span> <span class="id">s2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span> &lt;-&gt; <span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f2</span>.<br/>
<br/>
<span class="kwd">Instance</span> <span class="id">entails_refl</span> : <span class="id">Reflexive</span> <span class="id">entails</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Reflexive</span>, <span class="id">entails</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">exact</span> <span class="id">H</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">entails_trans</span> : <span class="id">Transitive</span> <span class="id">entails</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Transitive</span>, <span class="id">entails</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">entails_preorder</span> : <span class="id">PreOrder</span> <span class="id">entails</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">entails_refl</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">entails_trans</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">gentails_refl</span> : <span class="kwd">forall</span> <span class="id">n</span>, <span class="id">Reflexive</span> (<span class="id">gentails</span> <span class="id">n</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Reflexive</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">n</span>. <span class="id">induction</span> <span class="id">n</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;- <span class="id">applys</span> <span class="id">ge_base</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;- <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span> <span class="id">ge_shift</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exs</span>. <span class="id">splits</span>*.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">gentails_trans</span> : <span class="kwd">forall</span> <span class="id">n</span>, <span class="id">Transitive</span> (<span class="id">gentails</span> <span class="id">n</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Transitive</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">n</span>. <span class="id">induction</span> <span class="id">n</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;- <span class="id">inverts</span> <span class="id">H</span>. <span class="id">inverts</span> <span class="id">H0</span>. <span class="id">applys</span> <span class="id">ge_base</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eauto</span>.<br/>
&nbsp;&nbsp;- <span class="id">applys</span> <span class="id">ge_shift</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">specializes</span> <span class="id">H</span> <span class="id">H1</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">specializes</span> <span class="id">H0</span> <span class="id">H2</span>. <span class="id">destr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exs</span>. <span class="id">splits</span>*.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">gentails_preorder</span> : <span class="kwd">forall</span> <span class="id">n</span>, <span class="id">PreOrder</span> (<span class="id">gentails</span> <span class="id">n</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">gentails_refl</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">gentails_trans</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">gentails_under_refl</span> : <span class="kwd">forall</span> <span class="id">n</span> <span class="id">env</span>, <span class="id">Reflexive</span> (<span class="id">gentails_under</span> <span class="id">env</span> <span class="id">n</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Reflexive</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">n</span>. <span class="id">induction</span> <span class="id">n</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;- <span class="id">applys</span> <span class="id">geu_base</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;- <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span> <span class="id">geu_shift</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exs</span>. <span class="id">splits</span>*.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">gentails_under_trans</span> : <span class="kwd">forall</span> <span class="id">n</span> <span class="id">env</span>, <span class="id">Transitive</span> (<span class="id">gentails_under</span> <span class="id">env</span> <span class="id">n</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Transitive</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">n</span>. <span class="id">induction</span> <span class="id">n</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;- <span class="id">inverts</span> <span class="id">H</span>. <span class="id">inverts</span> <span class="id">H0</span>. <span class="id">applys</span> <span class="id">geu_base</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eauto</span>.<br/>
&nbsp;&nbsp;- <span class="id">applys</span> <span class="id">geu_shift</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">specializes</span> <span class="id">H</span> <span class="id">H1</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">specializes</span> <span class="id">H0</span> <span class="id">H2</span>. <span class="id">destr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exs</span>. <span class="id">splits</span>*.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">gentails_under_preorder</span> : <span class="kwd">forall</span> <span class="id">n</span> <span class="id">env</span>, <span class="id">PreOrder</span> (<span class="id">gentails_under</span> <span class="id">env</span> <span class="id">n</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">gentails_under_refl</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">gentails_under_trans</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">entails_under_refl</span> : <span class="kwd">forall</span> <span class="id">env</span>, <span class="id">Reflexive</span> (<span class="id">entails_under</span> <span class="id">env</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Reflexive</span>, <span class="id">entails_under</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">eauto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">entails_under_trans</span> : <span class="kwd">forall</span> <span class="id">env</span>, <span class="id">Transitive</span> (<span class="id">entails_under</span> <span class="id">env</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Transitive</span>, <span class="id">entails_under</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">entails_under_preorder</span> : <span class="kwd">forall</span> <span class="id">env</span>, <span class="id">PreOrder</span> (<span class="id">entails_under</span> <span class="id">env</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">entails_under_refl</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">entails_under_trans</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">bientails_equiv</span> : <span class="id">Equivalence</span> <span class="id">bientails</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;- <span class="id">unfold</span> <span class="id">Reflexive</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="id">unfold</span> <span class="id">Symmetric</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">symmetry</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">auto</span>.<br/>
&nbsp;&nbsp;- <span class="id">unfold</span> <span class="id">Transitive</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id">intros</span>. <span class="id">apply</span> <span class="id">H0</span>. <span class="id">apply</span> <span class="id">H</span>. <span class="id">easy</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id">intros</span>. <span class="id">apply</span> <span class="id">H</span>. <span class="id">apply</span> <span class="id">H0</span>. <span class="id">easy</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Definition</span> <span class="id">flow_res</span> (<span class="id">f</span>:<span class="id">flow</span>) (<span class="id">v</span>:<span class="id">val</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span>, <span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">v</span>) <span class="id">f</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">flow_res1</span> (<span class="id">f</span>:<span class="id">flow</span>) (<span class="id">v1</span>:<span class="id">val</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">v</span>, <span class="id">satisfies</span> <span class="id">s1</span> <span class="id">s2</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">v</span>) <span class="id">f</span> -&gt; <span class="id">v1</span> = <span class="id">v</span>.<br/>
</span></div>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/xavierleroy/coq2html/">coq2html</a></div>
</body>
</html>
