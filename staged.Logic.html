
<!DOCTYPE html>
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module Logic</title><script src="coq2html.js"></script>
<meta name="description" content="Documentation of Coq module Logic" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
</head>

<body>
<h1 class="title">Module Logic</h1>
<div class="coq">
<div class="doc">A reference formalization of <a href="https://dl.acm.org/doi/10.1007/978-3-031-71162-6_26">Staged Specification Logic for Verifying Higher-Order Imperative Programs</a> (FM 2024). </div>
<span class="kwd">From</span> <span class="id">Stdlib</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id">Classes.RelationClasses</span>.<br/>
<span class="kwd">From</span> <span class="id">Stdlib</span> <span class="kwd">Require</span> <span class="id">Morphisms</span> <span class="id">Program.Basics</span>.<br/>
<br/>
<span class="kwd">Set</span> <span class="id">Warnings</span> <span class="string">"-notation-incompatible-prefix"</span>.<br/>
<span class="kwd">From</span> <span class="id">Staged</span> <span class="kwd">Require</span> <span class="kwd">Export</span> <span class="id">HeapF</span>.<br/>
<span class="kwd">Set</span> <span class="id">Warnings</span> <span class="string">"notation-incompatible-prefix"</span>.<br/>
<span class="kwd">From</span> <span class="id">Staged</span> <span class="kwd">Require</span> <span class="kwd">Export</span> <span class="id">LibFmap</span>.<br/>
<span class="kwd">From</span> <span class="id">Staged</span> <span class="kwd">Require</span> <span class="kwd">Export</span> <span class="id">EvenMoreTactics</span>.<br/>
<br/>
<span class="id">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">string_scope</span>.<br/>
<span class="id">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">Z_scope</span>.<br/>
<span class="id">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">list_scope</span>.<br/>
<br/>
<span class="kwd">Set</span> <span class="kwd">Implicit</span> <span class="kwd">Arguments</span>.<br/>
<br/>
<h1> Programs </h1>
<div class="doc">The representation of programs and the use of substitution are mostly reused from SLF. </div>
<span class="kwd">Definition</span> <span class="id">var</span> : <span class="kwd">Type</span> := <span class="id">string</span>.<br/>
<span class="kwd">Definition</span> <span class="id">var_eq</span> := <span class="id">String.string_dec</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">loc</span> := <span class="id">nat</span>.<br/>
<br/>
<span class="kwd">Inductive</span> <span class="id">val</span> :=<br/>
&nbsp;&nbsp;| <span class="id">vunit</span> : <span class="id">val</span><br/>
&nbsp;&nbsp;| <span class="id">vint</span> : <span class="id">Z</span> -&gt; <span class="id">val</span><br/>
&nbsp;&nbsp;| <span class="id">vfun</span> : <span class="id">var</span> -&gt; <span class="id">expr</span> -&gt; <span class="id">val</span><br/>
&nbsp;&nbsp;| <span class="id">vfix</span> : <span class="id">var</span> -&gt; <span class="id">var</span> -&gt; <span class="id">expr</span> -&gt; <span class="id">val</span><br/>
&nbsp;&nbsp;| <span class="id">vloc</span> : <span class="id">loc</span> -&gt; <span class="id">val</span><br/>
&nbsp;&nbsp;| <span class="id">vtup</span> : <span class="id">val</span> -&gt; <span class="id">val</span> -&gt; <span class="id">val</span><br/>
&nbsp;&nbsp;| <span class="id">vstr</span> : <span class="id">string</span> -&gt; <span class="id">val</span><br/>
&nbsp;&nbsp;| <span class="id">vbool</span> : <span class="id">bool</span> -&gt; <span class="id">val</span><br/>
&nbsp;&nbsp;| <span class="id">vlist</span> : <span class="id">list</span> <span class="id">val</span> -&gt; <span class="id">val</span><br/>
<br/>
<span class="kwd">with</span> <span class="id">expr</span> : <span class="kwd">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id">pvar</span> (<span class="id">x</span>: <span class="id">var</span>)<br/>
&nbsp;&nbsp;| <span class="id">pval</span> (<span class="id">v</span>: <span class="id">val</span>)<br/>
&nbsp;&nbsp;| <span class="id">plet</span> (<span class="id">x</span>: <span class="id">var</span>) (<span class="id">e1</span> <span class="id">e2</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">pfix</span> (<span class="id">f</span>: <span class="id">var</span>) (<span class="id">x</span>: <span class="id">var</span>) (<span class="id">e</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">pfun</span> (<span class="id">x</span>: <span class="id">var</span>) (<span class="id">e</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">padd</span> (<span class="id">x</span> <span class="id">y</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">pfst</span> (<span class="id">t</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">psnd</span> (<span class="id">t</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">pminus</span> (<span class="id">x</span> <span class="id">y</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">passert</span> (<span class="id">b</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">pref</span> (<span class="id">v</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">pderef</span> (<span class="id">v</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">passign</span> (<span class="id">x</span>: <span class="id">expr</span>) (<span class="id">v</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">pif</span> (<span class="id">b</span>: <span class="id">expr</span>) (<span class="id">e1</span>: <span class="id">expr</span>) (<span class="id">e2</span>: <span class="id">expr</span>)<br/>
&nbsp;&nbsp;| <span class="id">papp</span> (<span class="id">x</span>: <span class="id">expr</span>) (<span class="id">a</span>: <span class="id">expr</span>).<br/>
<br/>
#[<span class="id">global</span>]<br/>
<span class="kwd">Instance</span> <span class="id">Inhab_val</span> : <span class="id">Inhab</span> <span class="id">val</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">vunit</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Fixpoint</span> <span class="id">subst</span> (<span class="id">y</span>:<span class="id">var</span>) (<span class="id">w</span>:<span class="id">val</span>) (<span class="id">e</span>:<span class="id">expr</span>) : <span class="id">expr</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">aux</span> <span class="id">t</span> := <span class="id">subst</span> <span class="id">y</span> <span class="id">w</span> <span class="id">t</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">if_y_eq</span> <span class="id">x</span> <span class="id">t1</span> <span class="id">t2</span> := <span class="kwd">if</span> <span class="id">var_eq</span> <span class="id">x</span> <span class="id">y</span> <span class="kwd">then</span> <span class="id">t1</span> <span class="kwd">else</span> <span class="id">t2</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">e</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">pval</span> <span class="id">v</span> =&gt; <span class="id">pval</span> <span class="id">v</span><br/>
&nbsp;&nbsp;| <span class="id">padd</span> <span class="id">x</span> <span class="id">y</span> =&gt; <span class="id">padd</span> (<span class="id">aux</span> <span class="id">x</span>) (<span class="id">aux</span> <span class="id">y</span>)<br/>
&nbsp;&nbsp;| <span class="id">pminus</span> <span class="id">x</span> <span class="id">y</span> =&gt; <span class="id">pminus</span> <span class="id">x</span> <span class="id">y</span><br/>
&nbsp;&nbsp;| <span class="id">pfst</span> <span class="id">x</span> =&gt; <span class="id">pfst</span> <span class="id">x</span><br/>
&nbsp;&nbsp;| <span class="id">psnd</span> <span class="id">x</span> =&gt; <span class="id">psnd</span> <span class="id">x</span><br/>
&nbsp;&nbsp;| <span class="id">pvar</span> <span class="id">x</span> =&gt; <span class="id">if_y_eq</span> <span class="id">x</span> (<span class="id">pval</span> <span class="id">w</span>) <span class="id">e</span><br/>
&nbsp;&nbsp;| <span class="id">passert</span> <span class="id">b</span> =&gt; <span class="id">passert</span> <span class="id">b</span><br/>
&nbsp;&nbsp;| <span class="id">pderef</span> <span class="id">r</span> =&gt; <span class="id">pderef</span> <span class="id">r</span><br/>
&nbsp;&nbsp;| <span class="id">passign</span> <span class="id">x</span> <span class="id">y</span> =&gt; <span class="id">passign</span> (<span class="id">aux</span> <span class="id">x</span>) (<span class="id">aux</span> <span class="id">y</span>)<br/>
&nbsp;&nbsp;| <span class="id">pref</span> <span class="id">v</span> =&gt; <span class="id">pref</span> <span class="id">v</span><br/>
&nbsp;&nbsp;| <span class="id">pfun</span> <span class="id">x</span> <span class="id">t1</span> =&gt; <span class="id">pfun</span> <span class="id">x</span> (<span class="id">if_y_eq</span> <span class="id">x</span> <span class="id">t1</span> (<span class="id">aux</span> <span class="id">t1</span>))<br/>
&nbsp;&nbsp;| <span class="id">pfix</span> <span class="id">f</span> <span class="id">x</span> <span class="id">t1</span> =&gt; <span class="id">pfix</span> <span class="id">f</span> <span class="id">x</span> (<span class="id">if_y_eq</span> <span class="id">f</span> <span class="id">t1</span> (<span class="id">if_y_eq</span> <span class="id">x</span> <span class="id">t1</span> (<span class="id">aux</span> <span class="id">t1</span>)))<br/>
&nbsp;&nbsp;| <span class="id">papp</span> <span class="id">e</span> <span class="id">v</span> =&gt; <span class="id">papp</span> <span class="id">e</span> <span class="id">v</span><br/>
&nbsp;&nbsp;| <span class="id">plet</span> <span class="id">x</span> <span class="id">t1</span> <span class="id">t2</span> =&gt; <span class="id">plet</span> <span class="id">x</span> (<span class="id">aux</span> <span class="id">t1</span>) (<span class="id">if_y_eq</span> <span class="id">x</span> <span class="id">t2</span> (<span class="id">aux</span> <span class="id">t2</span>))<br/>
&nbsp;&nbsp;| <span class="id">pif</span> <span class="id">t0</span> <span class="id">t1</span> <span class="id">t2</span> =&gt; <span class="id">pif</span> <span class="id">t0</span> (<span class="id">aux</span> <span class="id">t1</span>) (<span class="id">aux</span> <span class="id">t2</span>)<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Module</span> <span class="id">Val</span>.<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">value</span> := <span class="id">val</span>.<br/>
<span class="kwd">End</span> <span class="id">Val</span>.<br/>
<br/>
<div class="doc">SLF's heap theory as a functor. </div>
<span class="kwd">Module</span> <span class="kwd">Export</span> <span class="id">Heap</span> := <span class="id">HeapF.HeapSetup</span> <span class="id">Val</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">empty_heap</span> : <span class="id">heap</span> := <span class="id">Fmap.empty</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">precond</span> := <span class="id">hprop</span>.<br/>
<span class="kwd">Definition</span> <span class="id">postcond</span> := <span class="id">val</span> -&gt; <span class="id">hprop</span>.<br/>
<br/>
<span class="kwd">Inductive</span> <span class="id">result</span> : <span class="kwd">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id">norm</span> : <span class="id">val</span> -&gt; <span class="id">result</span>.<br/>
<br/>
<h1> Staged formulae </h1>
<div class="doc">Deeply embedded due to uninterpreted functions, which cannot immediately be given a semantics without an environment. If we make <span class="bracket"><span class="id">flow</span></span> a function of an <span class="bracket"><span class="id">senv</span></span>, the type of <span class="bracket"><span class="id">flow</span></span> will be <span class="bracket"><span class="id">flow</span> : (<span class="id">var</span> -&gt; (<span class="id">val</span> -&gt; <span class="id">val</span> -&gt; <span class="id">flow</span>)) -&gt; ... -&gt; <span class="kwd">Prop</span></span>, which cannot be defined. </div>
<span class="kwd">Inductive</span> <span class="id">flow</span> :=<br/>
&nbsp;&nbsp;| <span class="id">req</span> : <span class="id">precond</span> -&gt; <span class="id">flow</span> -&gt; <span class="id">flow</span><br/>
&nbsp;&nbsp;| <span class="id">ens</span> : <span class="id">postcond</span> -&gt; <span class="id">flow</span><br/>
&nbsp;&nbsp;| <span class="id">seq</span> : <span class="id">flow</span> -&gt; <span class="id">flow</span> -&gt; <span class="id">flow</span><br/>
&nbsp;&nbsp;| <span class="id">fex</span> : <span class="kwd">forall</span> <span class="id">A</span>, (<span class="id">A</span> -&gt; <span class="id">flow</span>) -&gt; <span class="id">flow</span><br/>
&nbsp;&nbsp;| <span class="id">fall</span> : <span class="kwd">forall</span> <span class="id">A</span>, (<span class="id">A</span> -&gt; <span class="id">flow</span>) -&gt; <span class="id">flow</span><br/>
&nbsp;&nbsp;| <span class="id">unk</span> : <span class="id">var</span> -&gt; <span class="id">val</span> -&gt; <span class="id">val</span> -&gt; <span class="id">flow</span><br/>
&nbsp;&nbsp;| <span class="id">intersect</span> : <span class="id">flow</span> -&gt; <span class="id">flow</span> -&gt; <span class="id">flow</span><br/>
&nbsp;&nbsp;| <span class="id">disj</span> : <span class="id">flow</span> -&gt; <span class="id">flow</span> -&gt; <span class="id">flow</span>.<br/>
<br/>
<div class="doc">An <span class="bracket"><span class="id">ens</span></span> which doesn't have a useful return value. This carries more information than <span class="bracket"><span class="id">ens</span> (<span class="kwd">fun</span> _ =&gt; <span class="id">H</span>)</span>, which has an <i>arbitrary</i> return value. </div>
<div class="doc">In practice, it is much easier to use this to talk about results which are universally quantified externally; the result of a staged formula is mainly useful only for defining its semantics and in triples. </div>
<div class="doc">Consequently, key lemmas like <span class="bracket"><span class="id">norm_ens_req_transpose</span></span> are defined using this. This can to some extent be considered an implementation deficiency around the use of HOAS. </div>
<span class="kwd">Definition</span> <span class="id">ens_</span> <span class="id">H</span> := <span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; \[<span class="id">r</span> = <span class="id">vunit</span>] \* <span class="id">H</span>).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">empty</span> := <span class="id">ens_</span> \[<span class="id">True</span>].<br/>
<br/>
<span class="kwd">Notation</span> <span class="id">req_</span> <span class="id">H</span> := (<span class="id">req</span> <span class="id">H</span> <span class="id">empty</span>).<br/>
<br/>
<div class="doc">Function environments, for interpreting unknown functions. <span class="bracket"><span class="id">ufun</span></span> is a HOAS way of substituting into a staged formula, which otherwise doesn't support this due to the shallow embedding that <span class="bracket"><span class="id">hprop</span></span> uses. </div>
<span class="kwd">Definition</span> <span class="id">ufun</span> := <span class="id">val</span> -&gt; <span class="id">val</span> -&gt; <span class="id">flow</span>.<br/>
<br/>
#[<span class="id">global</span>]<br/>
<span class="kwd">Instance</span> <span class="id">Inhab_ufun</span> : <span class="id">Inhab</span> <span class="id">ufun</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="kwd">fun</span> (<span class="id">r</span> <span class="id">v</span>:<span class="id">val</span>) =&gt; <span class="id">ens_</span> \[<span class="id">r</span> = <span class="id">v</span>]).<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Definition</span> <span class="id">senv</span> := <span class="id">Fmap.fmap</span> <span class="id">var</span> <span class="id">ufun</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">empty_env</span> : <span class="id">senv</span> := <span class="id">Fmap.empty</span>.<br/>
<br/>
<span class="id">Declare</span> <span class="kwd">Scope</span> <span class="id">flow_scope</span>.<br/>
<span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">flow_scope</span>.<br/>
<br/>
<span class="kwd">Infix</span> <span class="string">";;"</span> := <span class="id">seq</span> (<span class="kwd">at</span> <span class="id">level</span> 38, <span class="id">right</span> <span class="id">associativity</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<span class="kwd">Notation</span> <span class="string">"'∃' x1 .. xn , H"</span> :=<br/>
&nbsp;&nbsp;(<span class="id">fex</span> (<span class="kwd">fun</span> <span class="id">x1</span> =&gt; .. (<span class="id">fex</span> (<span class="kwd">fun</span> <span class="id">xn</span> =&gt; <span class="id">H</span>)) ..))<br/>
&nbsp;&nbsp;(<span class="kwd">at</span> <span class="id">level</span> 39, <span class="id">x1</span> <span class="id">binder</span>, <span class="id">H</span> <span class="kwd">at</span> <span class="id">level</span> 50, <span class="id">right</span> <span class="id">associativity</span>,<br/>
&nbsp;&nbsp;&nbsp;<span class="id">format</span> <span class="string">"'[' '∃' '/ '  x1  ..  xn , '/ '  H ']'"</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<span class="kwd">Notation</span> <span class="string">"'∀' x1 .. xn , H"</span> :=<br/>
&nbsp;&nbsp;(<span class="id">fall</span> (<span class="kwd">fun</span> <span class="id">x1</span> =&gt; .. (<span class="id">fall</span> (<span class="kwd">fun</span> <span class="id">xn</span> =&gt; <span class="id">H</span>)) ..))<br/>
&nbsp;&nbsp;(<span class="kwd">at</span> <span class="id">level</span> 39, <span class="id">x1</span> <span class="id">binder</span>, <span class="id">H</span> <span class="kwd">at</span> <span class="id">level</span> 50, <span class="id">right</span> <span class="id">associativity</span>,<br/>
&nbsp;&nbsp;&nbsp;<span class="id">format</span> <span class="string">"'[' '∀' '/ '  x1  ..  xn , '/ '  H ']'"</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<span class="kwd">Notation</span> <span class="string">"f '$' '(' x ',' r ')'"</span> := (<span class="id">unk</span> <span class="id">f</span> <span class="id">x</span> <span class="id">r</span>)<br/>
&nbsp;&nbsp;(<span class="kwd">at</span> <span class="id">level</span> 80, <span class="id">format</span> <span class="string">"f '$' '(' x ','  r ')'"</span>, <span class="id">only</span> <span class="id">printing</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<br/>
<span class="kwd">Notation</span> <span class="string">"'ens' r '.' Q"</span> := (<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; <span class="id">Q</span>))<br/>
&nbsp;&nbsp;(<span class="kwd">at</span> <span class="id">level</span> 80, <span class="id">format</span> <span class="string">"'ens'  r '.'  Q"</span> , <span class="id">only</span> <span class="id">printing</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<br/>
<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">s</span> : <span class="id">senv</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">h</span> : <span class="id">heap</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">H</span> : <span class="id">hprop</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">Q</span> : <span class="id">postcond</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">uf</span> <span class="id">fn</span> : <span class="id">ufun</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">c</span> : <span class="id">val</span> -&gt; <span class="id">flow</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">f</span> : <span class="id">flow</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">a</span> <span class="id">v</span> <span class="id">r</span> : <span class="id">val</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">R</span> : <span class="id">result</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">e</span> : <span class="id">expr</span>.<br/>
<br/>
<h1> Interpretation of a staged formula </h1>
<div class="doc">An <span class="bracket"><span class="kwd">Inductive</span></span> definition is used because the rule for unknown functions is not structurally recursive. </div>
<span class="kwd">Inductive</span> <span class="id">satisfies</span> : <span class="id">senv</span> -&gt; <span class="id">heap</span> -&gt; <span class="id">heap</span> -&gt; <span class="id">result</span> -&gt; <span class="id">flow</span> -&gt; <span class="kwd">Prop</span> :=<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_req</span> <span class="id">s</span> <span class="id">p</span> (<span class="id">h1</span> <span class="id">h2</span>:<span class="id">heap</span>) <span class="id">R</span> <span class="id">f</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H</span>: <span class="kwd">forall</span> (<span class="id">hp</span> <span class="id">hr</span>:<span class="id">heap</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">p</span> <span class="id">hp</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h1</span> = <span class="id">Fmap.union</span> <span class="id">hr</span> <span class="id">hp</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Fmap.disjoint</span> <span class="id">hr</span> <span class="id">hp</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">hr</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">req</span> <span class="id">p</span> <span class="id">f</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_ens</span> <span class="id">s</span> <span class="id">q</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H</span>: <span class="kwd">exists</span> <span class="id">v</span> <span class="id">h3</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">R</span> = <span class="id">norm</span> <span class="id">v</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">q</span> <span class="id">v</span> <span class="id">h3</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h2</span> = <span class="id">Fmap.union</span> <span class="id">h1</span> <span class="id">h3</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Fmap.disjoint</span> <span class="id">h1</span> <span class="id">h3</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens</span> <span class="id">q</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_seq</span> <span class="id">h3</span> <span class="id">R1</span> <span class="id">s</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h3</span> <span class="id">R1</span> <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h3</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">seq</span> <span class="id">f1</span> <span class="id">f2</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_fex</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">A</span>:<span class="kwd">Type</span>) (<span class="id">f</span>:<span class="id">A</span>-&gt;<span class="id">flow</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H</span>: <span class="kwd">exists</span> <span class="id">b</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">f</span> <span class="id">b</span>)) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (@<span class="id">fex</span> <span class="id">A</span> <span class="id">f</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_fall</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">A</span>:<span class="kwd">Type</span>) (<span class="id">f</span>:<span class="id">A</span>-&gt;<span class="id">flow</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H</span>: <span class="kwd">forall</span> <span class="id">b</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">f</span> <span class="id">b</span>)) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (@<span class="id">fall</span> <span class="id">A</span> <span class="id">f</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_unk</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">r</span> <span class="id">xf</span> <span class="id">fn</span> <span class="id">a</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">He</span>: <span class="id">Fmap.read</span> <span class="id">s</span> <span class="id">xf</span> = <span class="id">fn</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">Hr</span>: <span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">r</span>) (<span class="id">fn</span> <span class="id">a</span> <span class="id">r</span>)) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">r</span>) (<span class="id">unk</span> <span class="id">xf</span> <span class="id">a</span> <span class="id">r</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_intersect</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span> <span class="id">f2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H1</span>: <span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H2</span>: <span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f2</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">intersect</span> <span class="id">f1</span> <span class="id">f2</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_disj_l</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span> <span class="id">f2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H</span>: <span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">disj</span> <span class="id">f1</span> <span class="id">f2</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">s_disj_r</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span> <span class="id">f2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">H</span>: <span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f2</span>) :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">disj</span> <span class="id">f1</span> <span class="id">f2</span>).<br/>
<br/>
<span class="kwd">Notation</span> <span class="string">"s ','  h1 ','  h2 ','  R  '|=' f"</span> :=<br/>
&nbsp;&nbsp;(<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f</span>) (<span class="kwd">at</span> <span class="id">level</span> 30, <span class="id">only</span> <span class="id">printing</span>).<br/>
<br/>
<div class="doc">The result of a staged formula, written in the paper as <span class="bracket"><span class="id">Φ</span>[<span class="id">r</span>]</span>. Because it relates a formula and a value here (and not a variable, as in the paper), we need a model for the formula to talk about the value. </div>
<span class="kwd">Definition</span> <span class="id">flow_res</span> (<span class="id">f</span>:<span class="id">flow</span>) (<span class="id">v</span>:<span class="id">val</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">env</span> <span class="id">R</span>, <span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f</span> -&gt; <span class="id">R</span> = <span class="id">norm</span> <span class="id">v</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">flow_res_in_env</span> (<span class="id">f</span>:<span class="id">flow</span>) (<span class="id">v</span>:<span class="id">val</span>) <span class="id">env</span> : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">v1</span>, <span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">v1</span>) <span class="id">f</span> -&gt; <span class="id">v1</span> = <span class="id">v</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">has_no_result</span> <span class="id">f</span> :=<br/>
&nbsp;&nbsp;<span class="id">flow_res</span> <span class="id">f</span> <span class="id">vunit</span>.<br/>
<br/>
<h1> Entailment </h1>
<div class="doc">This sequent is useful for (interactive) proofs involving functions. </div>
<span class="kwd">Definition</span> <span class="id">entails_under</span> <span class="id">env</span> <span class="id">f1</span> <span class="id">f2</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span> -&gt; <span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f2</span>.<br/>
<br/>
<br/>
<div class="doc">General entailments which work for arbitrary environments. </div>
<span class="kwd">Definition</span> <span class="id">entails</span> (<span class="id">f1</span> <span class="id">f2</span>:<span class="id">flow</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>, <span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span> -&gt; <span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f2</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">bientails</span> (<span class="id">f1</span> <span class="id">f2</span>:<span class="id">flow</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span> &lt;-&gt; <span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f2</span>.<br/>
<br/>
<span class="kwd">Infix</span> <span class="string">"⊑"</span> := <span class="id">entails</span> (<span class="kwd">at</span> <span class="id">level</span> 90, <span class="id">right</span> <span class="id">associativity</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<span class="kwd">Notation</span> <span class="string">"env '⊢' f1 '⊑' f2"</span> :=<br/>
&nbsp;&nbsp;(<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f1</span> <span class="id">f2</span>) (<span class="kwd">at</span> <span class="id">level</span> 90, <span class="id">only</span> <span class="id">printing</span>) : <span class="id">flow_scope</span>.<br/>
<br/>
<h1> Top and bottom </h1>
<span class="kwd">Definition</span> <span class="id">top</span> := <span class="id">req_</span> \[<span class="id">False</span>].<br/>
<span class="kwd">Definition</span> <span class="id">bot</span> := <span class="id">ens_</span> \[<span class="id">False</span>].<br/>
<span class="kwd">Definition</span> <span class="id">error</span> := <span class="id">req</span> \[<span class="id">False</span>] (<span class="id">ens_</span> \[<span class="id">False</span>]).<br/>
<span class="kwd">Definition</span> <span class="id">post_sat</span> (<span class="id">Q</span>:<span class="id">postcond</span>) := <span class="kwd">exists</span> <span class="id">v</span> <span class="id">h</span>, <span class="id">Q</span> <span class="id">v</span> <span class="id">h</span>.<br/>
<span class="kwd">Definition</span> <span class="id">flow_sat</span> <span class="id">f</span> := <span class="kwd">exists</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>, <span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f</span>.<br/>
<span class="kwd">Definition</span> <span class="id">okay</span> <span class="id">P</span> <span class="id">Q</span> := <span class="id">ens_</span> \[<span class="id">post_sat</span> <span class="id">Q</span>];; <span class="id">req</span> <span class="id">P</span> (<span class="id">ens</span> <span class="id">Q</span>).<br/>
<br/>
<br/>
<h1> Rewriting </h1>
<span class="kwd">Instance</span> <span class="id">entails_refl</span> : <span class="id">Reflexive</span> <span class="id">entails</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Reflexive</span>, <span class="id">entails</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">exact</span> <span class="id">H</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">entails_trans</span> : <span class="id">Transitive</span> <span class="id">entails</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Transitive</span>, <span class="id">entails</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">entails_preorder</span> : <span class="id">PreOrder</span> <span class="id">entails</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">entails_refl</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">entails_trans</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">entails_under_refl</span> : <span class="kwd">forall</span> <span class="id">env</span>, <span class="id">Reflexive</span> (<span class="id">entails_under</span> <span class="id">env</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Reflexive</span>, <span class="id">entails_under</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">exact</span> <span class="id">H</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">entails_under_trans</span> : <span class="kwd">forall</span> <span class="id">env</span>, <span class="id">Transitive</span> (<span class="id">entails_under</span> <span class="id">env</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Transitive</span>, <span class="id">entails_under</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">entails_under_preorder</span> : <span class="kwd">forall</span> <span class="id">env</span>, <span class="id">PreOrder</span> (<span class="id">entails_under</span> <span class="id">env</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">entails_under_refl</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">entails_under_trans</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Instance</span> <span class="id">bientails_equiv</span> : <span class="id">Equivalence</span> <span class="id">bientails</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;- <span class="id">unfold</span> <span class="id">Reflexive</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="id">unfold</span> <span class="id">Symmetric</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">symmetry</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">auto</span>.<br/>
&nbsp;&nbsp;- <span class="id">unfold</span> <span class="id">Transitive</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id">intros</span>. <span class="id">apply</span> <span class="id">H0</span>. <span class="id">apply</span> <span class="id">H</span>. <span class="id">easy</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id">intros</span>. <span class="id">apply</span> <span class="id">H</span>. <span class="id">apply</span> <span class="id">H0</span>. <span class="id">easy</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Infix</span> <span class="string">"====&gt;"</span> := <span class="id">Morphisms.respectful</span> (<span class="kwd">at</span> <span class="id">level</span> 80, <span class="id">right</span> <span class="id">associativity</span>).<br/>
<span class="kwd">Notation</span> <span class="id">Proper</span> := <span class="id">Morphisms.Proper</span>.<br/>
<span class="kwd">Notation</span> <span class="id">respectful</span> := <span class="id">Morphisms.respectful</span>.<br/>
<span class="kwd">Notation</span> <span class="id">impl</span> := <span class="id">Program.Basics.impl</span>.<br/>
<span class="kwd">Notation</span> <span class="id">flip</span> := <span class="id">Basics.flip</span>.<br/>
<br/>
<div class="doc">Incantations for setoid rewriting </div>
<span class="kwd">Section</span> <span class="id">Proprium</span>.<br/>
<br/>
<div class="doc">This reflects how entailment is contravariant in the antecedent and covariant in the consequent </div>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">Proper_entails</span> : <span class="id">Proper</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">flip</span> <span class="id">entails</span> ====&gt; <span class="id">entails</span> ====&gt; <span class="id">impl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">entails</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>, <span class="id">Proper</span>, <span class="id">respectful</span>, <span class="id">impl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">auto</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">Proper_entails_under</span> : <span class="kwd">forall</span> <span class="id">env</span>, <span class="id">Proper</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">flip</span> (<span class="id">entails_under</span> <span class="id">env</span>) ====&gt; <span class="id">entails_under</span> <span class="id">env</span> ====&gt; <span class="id">impl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">entails_under</span> <span class="id">env</span>).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>, <span class="id">Proper</span>, <span class="id">respectful</span>, <span class="id">impl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">auto</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">Proper_bientails</span> : <span class="id">Proper</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">bientails</span> ====&gt; <span class="id">bientails</span> ====&gt; <span class="id">iff</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">entails</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>, <span class="id">entails</span>, <span class="id">Proper</span>, <span class="id">respectful</span>, <span class="id">impl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id">H0</span>. <span class="id">apply</span> <span class="id">H1</span>. <span class="id">apply</span> <span class="id">H</span>. <span class="id">auto</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id">H0</span>. <span class="id">apply</span> <span class="id">H1</span>. <span class="id">apply</span> <span class="id">H</span>. <span class="id">auto</span>. }<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
<div class="doc">entails is proper wrt satisfies </div>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">Proper_satisfies</span> : <span class="id">Proper</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">eq</span> ====&gt; <span class="id">eq</span> ====&gt; <span class="id">eq</span> ====&gt; <span class="id">eq</span> ====&gt; <span class="id">entails</span> ====&gt; <span class="id">impl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>, <span class="id">Proper</span>, <span class="id">respectful</span>, <span class="id">impl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">auto</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">Proper_satisfies_bi</span> : <span class="id">Proper</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">eq</span> ====&gt; <span class="id">eq</span> ====&gt; <span class="id">eq</span> ====&gt; <span class="id">eq</span> ====&gt; <span class="id">bientails</span> ====&gt; <span class="id">impl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>, <span class="id">entails</span>, <span class="id">Proper</span>, <span class="id">respectful</span>, <span class="id">impl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">auto</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">Proper_satisfies_under</span> : <span class="kwd">forall</span> <span class="id">env</span>, <span class="id">Proper</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">eq</span> ====&gt; <span class="id">eq</span> ====&gt; <span class="id">eq</span> ====&gt; <span class="id">entails_under</span> <span class="id">env</span> ====&gt; <span class="id">impl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">satisfies</span> <span class="id">env</span>).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>, <span class="id">Proper</span>, <span class="id">respectful</span>, <span class="id">impl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">auto</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">Proper_seq</span> : <span class="id">Proper</span> (<span class="id">entails</span> ====&gt; <span class="id">entails</span> ====&gt; <span class="id">entails</span>) <span class="id">seq</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Proper</span>, <span class="id">entails</span>, <span class="id">respectful</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H1</span> <span class="kwd">as</span> <span class="id">H1</span>; <span class="id">destr</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span>* <span class="id">s_seq</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">Proper_seq_entails_under</span> : <span class="kwd">forall</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Proper</span> (<span class="id">entails_under</span> <span class="id">env</span> ====&gt; <span class="id">entails_under</span> <span class="id">env</span> ====&gt; <span class="id">entails_under</span> <span class="id">env</span>) <span class="id">seq</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Proper</span>, <span class="id">entails_under</span>, <span class="id">respectful</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H1</span> <span class="kwd">as</span> <span class="id">H1</span>; <span class="id">destr</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span>* <span class="id">s_seq</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">fex_entails_under_morphism</span> (<span class="id">A</span> : <span class="kwd">Type</span>) : <span class="kwd">forall</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Proper</span> (<span class="id">Morphisms.pointwise_relation</span> <span class="id">A</span> (<span class="id">entails_under</span> <span class="id">env</span>) ====&gt; <span class="id">entails_under</span> <span class="id">env</span>) (@<span class="id">fex</span> <span class="id">A</span>).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Proper</span>, <span class="id">respectful</span>, <span class="id">Morphisms.pointwise_relation</span>, <span class="id">entails_under</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">b</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">entails_entails_under</span> : <span class="kwd">forall</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Proper</span> (<span class="id">flip</span> <span class="id">entails</span> ====&gt; <span class="id">entails</span> ====&gt; <span class="id">impl</span>) (<span class="id">entails_under</span> <span class="id">env</span>).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Proper</span>, <span class="id">respectful</span>, <span class="id">entails_under</span>, <span class="id">entails</span>, <span class="id">flip</span>, <span class="id">impl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eauto</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">entails_entails_under_flip</span> : <span class="kwd">forall</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Proper</span> (<span class="id">entails</span> ====&gt; <span class="id">flip</span> <span class="id">entails</span> ====&gt; <span class="id">flip</span> <span class="id">impl</span>) (<span class="id">entails_under</span> <span class="id">env</span>).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Proper</span>, <span class="id">respectful</span>, <span class="id">entails_under</span>, <span class="id">entails</span>, <span class="id">flip</span>, <span class="id">impl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eauto</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">bientails_entails_under</span> : <span class="kwd">forall</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Proper</span> (<span class="id">bientails</span> ====&gt; <span class="id">bientails</span> ====&gt; <span class="id">iff</span>) (<span class="id">entails_under</span> <span class="id">env</span>).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Proper</span>, <span class="id">respectful</span>, <span class="id">entails_under</span>, <span class="id">bientails</span>, <span class="id">impl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">Proper_seq_bi</span> : <span class="id">Proper</span> (<span class="id">bientails</span> ====&gt; <span class="id">bientails</span> ====&gt; <span class="id">bientails</span>) <span class="id">seq</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Proper</span>, <span class="id">bientails</span>, <span class="id">respectful</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H1</span> <span class="kwd">as</span> <span class="id">H1</span>; <span class="id">destr</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">econstructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">H0</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H1</span> <span class="kwd">as</span> <span class="id">H1</span>; <span class="id">destr</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">econstructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">H0</span>. }<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">Proper_req_entails</span> : <span class="id">Proper</span> (<span class="id">eq</span> ====&gt; <span class="id">entails</span> ====&gt; <span class="id">entails</span>) <span class="id">req</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Proper</span>, <span class="id">entails</span>, <span class="id">respectful</span>, <span class="id">flip</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">H</span> <span class="kwd">in</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H1</span> <span class="kwd">as</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H1</span> <span class="id">H3</span> <span class="id">___</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">Proper_req_bi</span> : <span class="id">Proper</span> (<span class="id">eq</span> ====&gt; <span class="id">bientails</span> ====&gt; <span class="id">bientails</span>) <span class="id">req</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Proper</span>, <span class="id">bientails</span>, <span class="id">respectful</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>; <span class="id">intros</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">constructor</span>. <span class="id">intros</span> <span class="id">hp</span> <span class="id">hr</span> <span class="id">H2</span> <span class="id">H3</span> <span class="id">H4</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">H</span> <span class="kwd">in</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H1</span> <span class="kwd">as</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H1</span> <span class="id">H3</span> <span class="id">___</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H0</span>. <span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">constructor</span>. <span class="id">intros</span> <span class="id">hp</span> <span class="id">hr</span> <span class="id">H2</span> <span class="id">H3</span> <span class="id">H4</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H</span> <span class="kwd">in</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H1</span> <span class="kwd">as</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H1</span> <span class="id">H3</span> <span class="id">___</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H0</span>. <span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
<span class="kwd">End</span> <span class="id">Proprium</span>.<br/>
<br/>
<h1> Inversion/introduction lemmas </h1>
<span class="kwd">Lemma</span> <span class="id">flow_res_inv</span>: <span class="kwd">forall</span> <span class="id">v</span> <span class="id">v1</span> <span class="id">f</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">v</span>) <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">flow_res</span> <span class="id">f</span> <span class="id">v1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">v</span> = <span class="id">v1</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">flow_res</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H0</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">injects</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">reflexivity</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ens_ret_inv</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">H</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> <span class="id">H</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">R</span> = <span class="id">norm</span> <span class="id">vunit</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_hpure_l</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="id">destruct</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">congruence</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ens_void_pure_inv</span> : <span class="kwd">forall</span> <span class="id">P</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> \[<span class="id">P</span>]) -&gt; <span class="id">P</span> /\ <span class="id">h1</span> = <span class="id">h2</span> /\ <span class="id">R</span> = <span class="id">norm</span> <span class="id">vunit</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_hpure_l</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hpure_inv</span> <span class="kwd">in</span> <span class="id">H4</span>. <span class="id">destr</span> <span class="id">H4</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">empty_inv</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">empty</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">h1</span> = <span class="id">h2</span> /\ <span class="id">R</span> = <span class="id">norm</span> <span class="id">vunit</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">empty</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ens_void_pure_inv</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">empty_intro</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h1</span> (<span class="id">norm</span> <span class="id">vunit</span>) <span class="id">empty</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">empty</span>, <span class="id">ens_</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">vunit</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">empty_heap</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_hpure_l</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hpure_intro</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">top_intro</span> : <span class="kwd">forall</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">top</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">top</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_req</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">hinv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">false</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">bot_inv</span> : <span class="kwd">forall</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">bot</span> -&gt; <span class="id">False</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>. <span class="id">hinv</span> <span class="id">H</span>. <span class="id">hinv</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;<span class="id">false</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">req_empty_inv</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">req</span> \[] <span class="id">f</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">specializes</span> <span class="id">H</span> <span class="id">empty_heap</span> <span class="id">h1</span> <span class="id">___</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hempty_intro</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">req_empty_intro</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">req</span> \[] <span class="id">f</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_req</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">hinv</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span>. <span class="id">rew_fmap</span> *.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">req_void_empty_inv</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">req_</span> \[]) -&gt;<br/>
&nbsp;&nbsp;<span class="id">h1</span> = <span class="id">h2</span> /\ <span class="id">R</span> = <span class="id">norm</span> <span class="id">vunit</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">specializes</span> <span class="id">H</span> <span class="id">empty_heap</span> <span class="id">h1</span> <span class="id">___</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hempty_intro</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">empty_inv</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ens_empty_inv</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; \[])) -&gt; <span class="id">h1</span> = <span class="id">h2</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hempty_inv</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">fmap_eq</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ens_empty_intro</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h1</span> <span class="id">R</span> (<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; \[])).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_ens</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">R</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">v</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">empty_heap</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span> <span class="id">fmap_eq</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ens_void_empty_intro</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h1</span> (<span class="id">norm</span> <span class="id">vunit</span>) (<span class="id">ens_</span> \[]).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="id">exs</span>.<br/>
&nbsp;&nbsp;<span class="id">splits</span>*.<br/>
&nbsp;&nbsp;<span class="id">hintro</span>.<br/>
&nbsp;&nbsp;<span class="id">splits</span>*.<br/>
&nbsp;&nbsp;<span class="id">hintro</span>.<br/>
&nbsp;&nbsp;<span class="id">rew_fmap</span>.<br/>
&nbsp;&nbsp;<span class="id">reflexivity</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ens_void_empty_inv</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> \[]) -&gt;<br/>
&nbsp;&nbsp;<span class="id">h1</span> = <span class="id">h2</span> /\ <span class="id">R</span> = <span class="id">norm</span> <span class="id">vunit</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>. <span class="id">hinv</span> <span class="id">H</span>. <span class="id">hinv</span> <span class="id">H</span>. <span class="id">hinv</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span>. <span class="id">rew_fmap</span> *.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ens_pure_inv</span> : <span class="kwd">forall</span> <span class="id">P</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">v</span>) (<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">a</span> =&gt; \[<span class="id">P</span> <span class="id">a</span>])) -&gt;<br/>
&nbsp;&nbsp;<span class="id">P</span> <span class="id">v</span> /\ <span class="id">h1</span> = <span class="id">h2</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;<span class="id">injects</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ens_pure_intro</span> : <span class="kwd">forall</span> <span class="id">P</span> <span class="id">env</span> <span class="id">h</span> <span class="id">r</span>,<br/>
&nbsp;&nbsp;<span class="id">P</span> <span class="id">r</span> -&gt; <span class="id">satisfies</span> <span class="id">env</span> <span class="id">h</span> <span class="id">h</span> (<span class="id">norm</span> <span class="id">r</span>) (<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; \[<span class="id">P</span> <span class="id">v</span>])).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">r</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">empty_heap</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hpure_intro</span>. <span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ens_void_inv</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">H</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> <span class="id">H</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">R</span> = <span class="id">norm</span> <span class="id">vunit</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">empty</span>, <span class="id">ens_</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_hpure_l</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">f_equal</span>. <span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ens_void_pure_intro</span> : <span class="kwd">forall</span> <span class="id">P</span> <span class="id">env</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;<span class="id">P</span> -&gt; <span class="id">satisfies</span> <span class="id">env</span> <span class="id">h</span> <span class="id">h</span> (<span class="id">norm</span> <span class="id">vunit</span>) (<span class="id">ens_</span> \[<span class="id">P</span>]).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">ens_</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">vunit</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">empty_heap</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_hpure_r</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hpure_intro</span>.<br/>
&nbsp;&nbsp;<span class="id">reflexivity</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">req_void_pure_intro</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">P</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h1</span> (<span class="id">norm</span> <span class="id">vunit</span>) (<span class="id">req_</span> \[<span class="id">P</span>]).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hpure_inv</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">destruct</span> <span class="id">H</span>. <span class="id">subst</span>. <span class="id">rew_fmap</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">empty_intro</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">req_pure_intro</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">P</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;(<span class="id">P</span> -&gt; <span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">req</span> \[<span class="id">P</span>] <span class="id">f</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_req</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">hinv</span> <span class="id">H0</span>. <span class="id">subst</span>. <span class="id">rew_fmap</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">H</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">req_void_pure_inv</span>: <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">P</span>,<br/>
&nbsp;&nbsp;<span class="id">P</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">req_</span> \[<span class="id">P</span>]) -&gt;<br/>
&nbsp;&nbsp;<span class="id">h1</span> = <span class="id">h2</span> /\ <span class="id">R</span> = <span class="id">norm</span> <span class="id">vunit</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">r</span> <span class="id">P</span> <span class="id">HP</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">empty_inv</span> <span class="kwd">with</span> (<span class="id">env</span> := <span class="id">env</span>).<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">specialize</span> (<span class="id">H</span> <span class="id">empty_heap</span> <span class="id">h1</span>). <span class="id">apply</span>* <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hpure_intro</span>. <span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">req_pure_inv</span>: <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">P</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">P</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">req</span> \[<span class="id">P</span>] <span class="id">f</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H0</span> <span class="id">empty_heap</span> <span class="id">h1</span>). <span class="id">apply</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">hintro</span>. <span class="id">assumption</span>. <span class="id">fmap_eq</span>. <span class="id">fmap_disjoint</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ens_req_inv</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">H</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> <span class="id">H</span>;; <span class="id">req</span> <span class="id">H</span> <span class="id">f</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>. <span class="id">hinv</span> <span class="id">H0</span>. <span class="id">hinv</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H7</span> <span class="kwd">as</span> <span class="id">H7</span>.<br/>
&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H7</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span>. <span class="id">rew_fmap</span> *.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">req_ens_intro</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">H</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">req</span> <span class="id">H</span> (<span class="id">ens_</span> <span class="id">H</span>;; <span class="id">f</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_req</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">s_seq</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_ens</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">vunit</span> <span class="id">hp</span>.<br/>
&nbsp;&nbsp;<span class="id">splits</span>*.<br/>
&nbsp;&nbsp;<span class="id">hintro</span>. <span class="id">splits</span>*.<br/>
&nbsp;&nbsp;<span class="id">subst</span>. <span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">seq_ens_pure_inv</span> : <span class="kwd">forall</span> <span class="id">P</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">v</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">v</span>) (<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">a</span> =&gt; \[<span class="id">P</span> <span class="id">a</span>]);; <span class="id">f</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">v1</span>, <span class="id">P</span> <span class="id">v1</span> /\ <span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">v</span>) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">R1</span>.<br/>
&nbsp;&nbsp;<span class="id">lets</span> <span class="id">H2</span>: <span class="id">ens_pure_inv</span> <span class="id">P</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">v0</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">seq_ens_void_pure_inv</span> : <span class="kwd">forall</span> <span class="id">P</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> \[<span class="id">P</span>];; <span class="id">f</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">P</span> /\ <span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ens_void_pure_inv</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ens_no_result</span> : <span class="kwd">forall</span> <span class="id">H</span>,<br/>
&nbsp;&nbsp;<span class="id">has_no_result</span> (<span class="id">ens_</span> <span class="id">H</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">has_no_result</span>, <span class="id">flow_res</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ens_void_inv</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">congruence</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">unk_inv</span> : <span class="kwd">forall</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">xf</span> <span class="id">a</span> <span class="id">v</span> <span class="id">fn</span>,<br/>
&nbsp;&nbsp;<span class="id">Fmap.read</span> <span class="id">s</span> <span class="id">xf</span> = <span class="id">fn</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">unk</span> <span class="id">xf</span> <span class="id">a</span> <span class="id">v</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">fn</span> <span class="id">a</span> <span class="id">v</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">unk_inv_bi</span> : <span class="kwd">forall</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">r</span> <span class="id">a</span> <span class="id">fn</span> <span class="id">xf</span>,<br/>
&nbsp;&nbsp;<span class="id">Fmap.read</span> <span class="id">s</span> <span class="id">xf</span> = <span class="id">fn</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">r</span>) (<span class="id">unk</span> <span class="id">xf</span> <span class="id">a</span> <span class="id">r</span>) &lt;-&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">r</span>) (<span class="id">fn</span> <span class="id">a</span> <span class="id">r</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">pose</span> <span class="id">proof</span> <span class="id">s_unk</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lets</span>: <span class="id">s_unk</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">r</span> <span class="id">xf</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H2</span> <span class="id">fn</span> <span class="id">a</span> <span class="id">H</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">unk_res_inv</span> : <span class="kwd">forall</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">r</span> <span class="id">a</span> <span class="id">fn</span> <span class="id">xf</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">Fmap.read</span> <span class="id">s</span> <span class="id">xf</span> = <span class="id">fn</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">unk</span> <span class="id">xf</span> <span class="id">a</span> <span class="id">r</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">R</span> = <span class="id">norm</span> <span class="id">r</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">reflexivity</span>.<br/>
Qed.</div></details>
<br/>
<h1> Some tactics </h1>
<br/>
<span class="kwd">Ltac</span> <span class="id">heaps</span> :=<br/>
&nbsp;&nbsp;<span class="id">lazymatch</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">H</span>: <span class="kwd">exists</span> _, _ |- _ =&gt; <span class="id">destr</span> <span class="id">H</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| <span class="id">H</span>: _ /\ _ |- _ =&gt; <span class="id">destr</span> <span class="id">H</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| <span class="id">H</span>: <span class="id">norm</span> _ = <span class="id">norm</span> _ |- _ =&gt; <span class="id">injects</span> <span class="id">H</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| <span class="id">H</span>: (_ ~~&gt; _) _ |- _ =&gt; <span class="id">hinv</span> <span class="id">H</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| <span class="id">H</span>: \[_] _ |- _ =&gt; <span class="id">hinv</span> <span class="id">H</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| <span class="id">H</span>: (_ \* _) _ |- _ =&gt; <span class="id">hinv</span> <span class="id">H</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| <span class="id">H</span>: <span class="id">hexists</span> (_) _ |- _ =&gt; <span class="id">hinv</span> <span class="id">H</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| |- (_ ~~&gt; _) _ =&gt; <span class="id">hintro</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| |- (_ \* _) _ =&gt; <span class="id">hintro</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| |- \[_] _ =&gt; <span class="id">hintro</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| |- _ /\ _ =&gt; <span class="id">splits</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| |- <span class="kwd">exists</span> _, _ =&gt; <span class="id">eexists</span>; <span class="id">heaps</span><br/>
&nbsp;&nbsp;| _ =&gt; <span class="id">subst</span>; <span class="id">rew_fmap</span> *<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Ltac</span> <span class="id">fdestr_rec</span> <span class="id">H</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">type</span> <span class="id">of</span> <span class="id">H</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">satisfies</span> _ _ _ _ (<span class="id">fex</span> (<span class="kwd">fun</span> _ =&gt; _)) =&gt; <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>; <span class="id">destr</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| <span class="id">satisfies</span> _ _ _ _ (_ ;; _) =&gt; <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>; <span class="id">destr</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| <span class="id">satisfies</span> _ _ _ _ (<span class="id">ens_</span> \[_]) =&gt; <span class="id">apply</span> <span class="id">ens_void_pure_inv</span> <span class="kwd">in</span> <span class="id">H</span>; <span class="id">destr</span> <span class="id">H</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Ltac</span> <span class="id">fdestr_pat</span> <span class="id">H</span> <span class="id">pat</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">type</span> <span class="id">of</span> <span class="id">H</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">satisfies</span> _ _ _ _ (<span class="id">fex</span> (<span class="kwd">fun</span> _ =&gt; _)) =&gt; <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>; <span class="id">destruct</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">pat</span><br/>
&nbsp;&nbsp;| <span class="id">satisfies</span> _ _ _ _ (_ ;; _) =&gt; <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>; <span class="id">destruct</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">pat</span><br/>
&nbsp;&nbsp;| <span class="id">satisfies</span> _ _ _ _ (<span class="id">ens_</span> \[_]) =&gt; <span class="id">apply</span> <span class="id">ens_void_pure_inv</span> <span class="kwd">in</span> <span class="id">H</span>; <span class="id">destruct</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">pat</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<div class="doc">Use these on product-like things like sequencing, existentials, and ens </div>
<span class="kwd">Tactic</span> <span class="kwd">Notation</span> <span class="string">"fdestr"</span> <span class="id">constr</span>(<span class="id">H</span>) := <span class="id">fdestr_rec</span> <span class="id">H</span>.<br/>
<span class="kwd">Tactic</span> <span class="kwd">Notation</span> <span class="string">"fdestr"</span> <span class="id">constr</span>(<span class="id">H</span>) <span class="string">"as"</span> <span class="id">simple_intropattern</span>(<span class="id">pat</span>) := <span class="id">fdestr_pat</span> <span class="id">H</span> <span class="id">pat</span>.<br/>
<br/>
<span class="kwd">Ltac</span> <span class="id">finv0</span> <span class="id">H</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">type</span> <span class="id">of</span> <span class="id">H</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">satisfies</span> _ _ _ _ <span class="id">empty</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">v</span> := <span class="id">fresh</span> <span class="string">"v"</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">hp</span> := <span class="id">fresh</span> <span class="string">"hp"</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">H1</span> := <span class="id">fresh</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">H2</span> := <span class="id">fresh</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">H3</span> := <span class="id">fresh</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">H4</span> := <span class="id">fresh</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> (<span class="id">v</span>&amp;<span class="id">hp</span>&amp;<span class="id">H1</span>&amp;<span class="id">H2</span>&amp;<span class="id">H3</span>&amp;<span class="id">H4</span>); <span class="id">hinv</span> <span class="id">H2</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Ltac</span> <span class="id">finv</span> <span class="id">H</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">type</span> <span class="id">of</span> <span class="id">H</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id">satisfies</span> _ _ _ _ (<span class="id">fex</span> (<span class="kwd">fun</span> _ =&gt; _)) =&gt; <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>; <span class="id">destr</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| <span class="id">satisfies</span> _ _ _ _ (_ ;; _) =&gt; <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>; <span class="id">destr</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| <span class="id">satisfies</span> _ _ _ _ (<span class="id">ens_</span> \[_]) =&gt; <span class="id">apply</span> <span class="id">ens_void_pure_inv</span> <span class="kwd">in</span> <span class="id">H</span>; <span class="id">destr</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| <span class="id">satisfies</span> _ _ _ _ (<span class="id">ens_</span> \[]) =&gt; <span class="id">apply</span> <span class="id">ens_void_empty_inv</span> <span class="kwd">in</span> <span class="id">H</span>; <span class="id">destr</span> <span class="id">H</span>; <span class="id">subst</span><br/>
&nbsp;&nbsp;| <span class="id">satisfies</span> _ _ _ _ (<span class="id">ens_</span> _) =&gt; <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>; <span class="id">destr</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| <span class="id">satisfies</span> _ _ _ _ (<span class="id">req</span> \[_] _) =&gt; <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| <span class="id">satisfies</span> _ _ _ _ (<span class="id">req</span> _ _) =&gt; <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| <span class="id">satisfies</span> _ _ _ _ (<span class="id">intersect</span> _ _) =&gt; <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span><br/>
&nbsp;&nbsp;| <span class="id">satisfies</span> _ _ _ _ (<span class="id">disj</span> _ _) =&gt; <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Ltac</span> <span class="id">fintro</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">goal</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| |- <span class="id">satisfies</span> _ _ _ _ (_ ;; _) =&gt; <span class="id">eapply</span> <span class="id">s_seq</span><br/>
&nbsp;&nbsp;| |- <span class="id">satisfies</span> _ _ _ _ (<span class="id">ens_</span> \[_]) =&gt; <span class="id">apply</span> <span class="id">ens_void_pure_intro</span><br/>
&nbsp;&nbsp;| |- <span class="id">satisfies</span> _ _ _ _ (<span class="id">ens_</span> \[]) =&gt; <span class="id">apply</span> <span class="id">ens_void_empty_intro</span><br/>
&nbsp;&nbsp;| |- <span class="id">satisfies</span> _ _ _ _ (<span class="id">ens_</span> _) =&gt; <span class="id">apply</span> <span class="id">s_ens</span>; <span class="kwd">exists</span> <span class="id">vunit</span><br/>
&nbsp;&nbsp;| |- <span class="id">satisfies</span> _ _ _ _ (<span class="id">ens_</span> _) =&gt; <span class="id">apply</span> <span class="id">s_ens</span><br/>
&nbsp;&nbsp;| |- <span class="id">satisfies</span> _ _ _ _ (<span class="id">req</span> \[_] _) =&gt; <span class="id">apply</span> <span class="id">req_pure_intro</span><br/>
&nbsp;&nbsp;| |- <span class="id">satisfies</span> _ _ _ _ (<span class="id">req</span> _ _) =&gt; <span class="id">apply</span> <span class="id">s_req</span>; <span class="id">intros</span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<h1> Entailment and normalization rules </h1>
<span class="kwd">Lemma</span> <span class="id">entails_bot</span>: <span class="kwd">forall</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">bot</span> <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">bot_inv</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">false</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">entails_top</span>: <span class="kwd">forall</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f</span> <span class="id">top</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">top_intro</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">disentails_okay_error</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">okay</span> <span class="id">P</span> <span class="id">Q</span>) <span class="id">error</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">error</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="id">intros</span>. <span class="id">hinv</span> <span class="id">H0</span>. <span class="id">false</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">disentails_error_okay</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">error</span> (<span class="id">okay</span> <span class="id">P</span> <span class="id">Q</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">applys</span> <span class="id">s_seq</span> <span class="id">h1</span> (<span class="id">norm</span> <span class="id">vunit</span>).<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;we&nbsp;need&nbsp;to&nbsp;prove&nbsp;Q,&nbsp;but&nbsp;error&nbsp;is&nbsp;useless&nbsp;for&nbsp;this&nbsp;*)</span><br/>
Abort.</div></details>
<br/>
<div class="doc">Covariance of ens </div>
<span class="kwd">Lemma</span> <span class="id">entails_ens</span> : <span class="kwd">forall</span> <span class="id">Q1</span> <span class="id">Q2</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">v</span>, <span class="id">Q1</span> <span class="id">v</span> ==&gt; <span class="id">Q2</span> <span class="id">v</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">ens</span> <span class="id">Q1</span>) (<span class="id">ens</span> <span class="id">Q2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H3</span> <span class="kwd">as</span> (<span class="id">v</span>&amp;<span class="id">h3</span>&amp;?&amp;?&amp;?&amp;?).<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">v</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">h3</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">easy</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">satisfies_ens_void</span> : <span class="kwd">forall</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">H1</span> ==&gt; <span class="id">H2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> <span class="id">H1</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> <span class="id">H2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H3</span>. <span class="id">destruct</span> <span class="id">H3</span> <span class="kwd">as</span> (<span class="id">v</span>&amp;<span class="id">h3</span>&amp;?&amp;?&amp;?&amp;?).<br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">v</span>. <span class="kwd">exists</span> <span class="id">h3</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_hpure_l</span> <span class="kwd">in</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_hpure_l</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">entails_ens_void</span> : <span class="kwd">forall</span> <span class="id">H1</span> <span class="id">H2</span>,<br/>
&nbsp;&nbsp;<span class="id">H1</span> ==&gt; <span class="id">H2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">ens_</span> <span class="id">H1</span>) (<span class="id">ens_</span> <span class="id">H2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> (<span class="id">satisfies_ens_void</span> <span class="id">H</span>).<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">Contravariance of req </div>
<span class="kwd">Lemma</span> <span class="id">entails_req</span> : <span class="kwd">forall</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;(<span class="id">H2</span> ==&gt; <span class="id">H1</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f1</span> <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">req</span> <span class="id">H1</span> <span class="id">f1</span>) (<span class="id">req</span> <span class="id">H2</span> <span class="id">f2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_req</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span> <span class="kwd">in</span> <span class="id">H4</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H3</span> <span class="kwd">as</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H3</span> <span class="id">hr</span> <span class="id">H4</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">Reassociating req </div>
<span class="kwd">Lemma</span> <span class="id">norm_reassoc</span> : <span class="kwd">forall</span> <span class="id">H</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">req</span> <span class="id">H</span> <span class="id">f1</span>;; <span class="id">f2</span>) (<span class="id">req</span> <span class="id">H</span> (<span class="id">f1</span>;; <span class="id">f2</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;find&nbsp;out&nbsp;about&nbsp;req&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="id">intros</span> <span class="id">hp</span> <span class="id">hr</span>. <span class="id">intros</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;prove&nbsp;the&nbsp;req&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H0</span> <span class="id">hp</span> <span class="id">hr</span> <span class="id">H1</span> <span class="id">___</span>.<br/>
&nbsp;&nbsp;<span class="id">applys</span>~ <span class="id">s_seq</span> <span class="id">h3</span> <span class="id">R1</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">Properties of disjunction </div>
<span class="kwd">Lemma</span> <span class="id">disj_comm</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">disj</span> <span class="id">f2</span> <span class="id">f1</span>) (<span class="id">disj</span> <span class="id">f1</span> <span class="id">f2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_disj_r</span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_disj_l</span>. <span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_disj_r</span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_disj_l</span>. <span class="id">assumption</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">disj_assoc</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">f3</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">disj</span> <span class="id">f1</span> (<span class="id">disj</span> <span class="id">f2</span> <span class="id">f3</span>)) (<span class="id">disj</span> (<span class="id">disj</span> <span class="id">f1</span> <span class="id">f2</span>) <span class="id">f3</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_disj_l</span>. <span class="id">apply</span>* <span class="id">s_disj_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_disj_l</span>. <span class="id">apply</span>* <span class="id">s_disj_r</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">s_disj_r</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">s_disj_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_disj_r</span>. <span class="id">apply</span>* <span class="id">s_disj_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_disj_r</span>. <span class="id">apply</span>* <span class="id">s_disj_r</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">disj_idem</span> : <span class="kwd">forall</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">disj</span> <span class="id">f</span> <span class="id">f</span>) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>; <span class="id">auto</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">apply</span>* <span class="id">s_disj_l</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">disj_unit</span> : <span class="kwd">forall</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">disj</span> <span class="id">f</span> <span class="id">bot</span>) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>; <span class="id">auto</span>. <span class="id">apply</span> <span class="id">bot_inv</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">false</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">apply</span>* <span class="id">s_disj_l</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">disj_dom</span> : <span class="kwd">forall</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">disj</span> <span class="id">f</span> <span class="id">top</span>) <span class="id">top</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id">top_intro</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">apply</span>* <span class="id">s_disj_r</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">conj_comm</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">intersect</span> <span class="id">f2</span> <span class="id">f1</span>) (<span class="id">intersect</span> <span class="id">f1</span> <span class="id">f2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>. <span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">s_intersect</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">s_intersect</span>. }<br/>
Qed.</div></details>
<br/>
<div class="doc">Properties of conjunction </div>
<span class="kwd">Lemma</span> <span class="id">conj_assoc</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">f3</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">intersect</span> <span class="id">f1</span> (<span class="id">intersect</span> <span class="id">f2</span> <span class="id">f3</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">intersect</span> (<span class="id">intersect</span> <span class="id">f1</span> <span class="id">f2</span>) <span class="id">f3</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H6</span> <span class="kwd">as</span> <span class="id">H6</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">s_intersect</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">s_intersect</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">s_intersect</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">s_intersect</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">conj_idem</span> : <span class="kwd">forall</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">intersect</span> <span class="id">f</span> <span class="id">f</span>) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">finv</span> <span class="id">H</span>. <span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">apply</span>* <span class="id">s_intersect</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">conj_unit</span> : <span class="kwd">forall</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">intersect</span> <span class="id">f</span> <span class="id">top</span>) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">finv</span> <span class="id">H</span>. <span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">apply</span>* <span class="id">s_intersect</span>. <span class="id">apply</span> <span class="id">top_intro</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">conj_dom</span> : <span class="kwd">forall</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">intersect</span> <span class="id">f</span> <span class="id">bot</span>) <span class="id">bot</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">finv</span> <span class="id">H</span>. <span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">apply</span>* <span class="id">s_intersect</span>. <span class="id">apply</span> <span class="id">bot_inv</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">false</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">seq_disj_distr</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">f3</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> ((<span class="id">disj</span> <span class="id">f1</span> <span class="id">f2</span>) ;; <span class="id">f3</span>) (<span class="id">disj</span> (<span class="id">f1</span>;; <span class="id">f3</span>) (<span class="id">f2</span>;; <span class="id">f3</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">finv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">finv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">s_disj_l</span>. <span class="id">econstructor</span>; <span class="id">jauto</span>.<br/>
&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">s_disj_r</span>. <span class="id">econstructor</span>; <span class="id">jauto</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">finv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">finv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">s_seq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">s_disj_l</span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">finv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">s_seq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">s_disj_r</span>. <span class="id">assumption</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">seq_assoc</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">f3</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">f1</span>;; <span class="id">f2</span>;; <span class="id">f3</span>) &lt;-&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> ((<span class="id">f1</span>;; <span class="id">f2</span>);; <span class="id">f3</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>; <span class="id">intros</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">finv</span> <span class="id">H</span>. <span class="id">finv</span> <span class="id">H6</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="id">jauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="id">jauto</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">finv</span> <span class="id">H</span>. <span class="id">finv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="id">jauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="id">jauto</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_seq_assoc</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">f3</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">f1</span>;; <span class="id">f2</span>;; <span class="id">f3</span>) ((<span class="id">f1</span>;; <span class="id">f2</span>);; <span class="id">f3</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>; <span class="id">intros</span>; <span class="id">now</span> <span class="id">apply</span> <span class="id">seq_assoc</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">Compaction rule 1 from the paper </div>
<span class="kwd">Lemma</span> <span class="id">norm_ens_false_l</span> : <span class="kwd">forall</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">ens_</span> \[<span class="id">False</span>]) (<span class="id">ens_</span> \[<span class="id">False</span>];; <span class="id">f</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id">ens_void_pure_inv</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>. <span class="id">false</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">finv</span> <span class="id">H</span>. <span class="id">apply</span> <span class="id">ens_void_pure_inv</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">false</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_ens_false</span> : <span class="kwd">forall</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">ens_</span> \[<span class="id">False</span>]) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">entails_bot</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_req_false</span> : <span class="kwd">forall</span> <span class="id">f</span> <span class="id">f1</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f</span> (<span class="id">req</span> \[<span class="id">False</span>] <span class="id">f1</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">req_pure_intro</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">false</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_req_pure_l</span> : <span class="kwd">forall</span> <span class="id">P</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">P</span> -&gt; <span class="id">bientails</span> (<span class="id">req</span> \[<span class="id">P</span>] <span class="id">f</span>) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id">req_pure_inv</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id">req_pure_intro</span>. <span class="id">auto</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_ens_pure_r</span> : <span class="kwd">forall</span> <span class="id">P</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">P</span> -&gt; <span class="id">bientails</span> <span class="id">empty</span> (<span class="id">ens_</span> \[<span class="id">P</span>]).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id">empty_inv</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ens_void_pure_intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id">ens_void_pure_inv</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">empty_intro</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_ens_pure_seq_r</span> : <span class="kwd">forall</span> <span class="id">P</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">P</span> -&gt; <span class="id">bientails</span> <span class="id">f</span> (<span class="id">ens_</span> \[<span class="id">P</span>];; <span class="id">f</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;{ <span class="id">eapply</span> <span class="id">s_seq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ens_void_pure_intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">fdestr</span> <span class="id">H0</span>. <span class="id">fdestr</span> <span class="id">H0</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_req_ens_empty</span> : <span class="kwd">forall</span> <span class="id">P</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">empty</span> (<span class="id">req</span> \[<span class="id">P</span>] (<span class="id">ens_</span> \[<span class="id">P</span>])).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">empty_inv</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">req_pure_intro</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">ens_void_pure_intro</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">The converse is not true as the result would change </div>
<span class="kwd">Lemma</span> <span class="id">norm_seq_ens_empty</span> : <span class="kwd">forall</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">ens_</span> \[];; <span class="id">f</span>) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">finv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">finv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">fintro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fintro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
Qed.</div></details>
<br/>
<div class="doc">Compaction rule 2 from the paper </div>
<span class="kwd">Lemma</span> <span class="id">norm_empty_l</span> : <span class="kwd">forall</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">empty</span>;; <span class="id">f</span>) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>, <span class="id">empty</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">finv</span> <span class="id">H</span>. <span class="id">finv</span> <span class="id">H</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">applys</span> <span class="id">s_seq</span> <span class="id">h1</span> (<span class="id">norm</span> <span class="id">vunit</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ens_void_pure_intro</span>; <span class="id">constructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_ens_no_result_r</span> : <span class="kwd">forall</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">has_no_result</span> <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">f</span>;; <span class="id">empty</span>) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;{ <span class="id">finv</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">has_no_result</span>, <span class="id">flow_res</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H</span> <span class="id">H1</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">empty_inv</span> <span class="kwd">in</span> <span class="id">H7</span>. <span class="id">destr</span> <span class="id">H7</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">specializes</span> <span class="id">H</span> <span class="id">H1</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span> <span class="id">s_seq</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">vunit</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">empty_intro</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_ens_empty_r</span> : <span class="kwd">forall</span> <span class="id">H</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">ens_</span> <span class="id">H</span>;; <span class="id">empty</span>) (<span class="id">ens_</span> <span class="id">H</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> (@<span class="id">norm_ens_no_result_r</span> (<span class="id">ens_</span> <span class="id">H</span>)).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ens_no_result</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">Compaction rule 3 from the paper. Stated this way to ensure <span class="bracket"><span class="id">f</span></span> has no meaningful result. See <span class="bracket"><span class="id">norm_ens_empty_r</span></span> for a better statement. </div>
<span class="kwd">Lemma</span> <span class="id">norm_empty_r</span> : <span class="kwd">forall</span> <span class="id">f</span> <span class="id">H</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">f</span>;; <span class="id">ens_</span> <span class="id">H</span>;; <span class="id">empty</span>) (<span class="id">f</span>;; <span class="id">ens_</span> <span class="id">H</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>, <span class="id">empty</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;{ <span class="id">rewrite</span> <span class="id">norm_ens_empty_r</span> <span class="kwd">in</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">rewrite</span> <span class="id">norm_ens_empty_r</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_seq_req_emp</span> : <span class="kwd">forall</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">req</span> \[] <span class="id">f</span>) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">split</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id">req_empty_inv</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id">req_empty_intro</span>. <span class="id">assumption</span>. }<br/>
Qed.</div></details>
<br/>
<div class="doc">Splitting and combining <span class="bracket"><span class="id">req</span></span>s </div>
<span class="kwd">Lemma</span> <span class="id">norm_req_sep_combine</span> : <span class="kwd">forall</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">req</span> <span class="id">H1</span> (<span class="id">req</span> <span class="id">H2</span> <span class="id">f</span>)) (<span class="id">req</span> (<span class="id">H1</span> \* <span class="id">H2</span>) <span class="id">f</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;contravariance&nbsp;means&nbsp;we&nbsp;start&nbsp;reasoning&nbsp;from&nbsp;the&nbsp;assumptions&nbsp;in&nbsp;the&nbsp;goal&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_req</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">hb</span> <span class="id">hr</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hstar_inv</span> <span class="kwd">in</span> <span class="id">H0</span> <span class="kwd">as</span> (<span class="id">hH1</span>&amp;<span class="id">hH2</span>&amp;?&amp;?&amp;?&amp;?).<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;start&nbsp;reasoning&nbsp;forward&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">forwards</span>: (<span class="id">H</span> <span class="id">hH1</span> (<span class="id">hr</span> \<span class="id">u</span> <span class="id">hH2</span>) <span class="id">H0</span>).<br/>
&nbsp;&nbsp;<span class="id">fmap_eq</span>.<br/>
&nbsp;&nbsp;<span class="id">fmap_disjoint</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H8</span> <span class="kwd">as</span> <span class="id">H8</span>.<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H8</span> _ <span class="id">hr</span> <span class="id">H5</span>).<br/>
&nbsp;&nbsp;<span class="id">forward</span> <span class="id">H8</span>. <span class="id">fmap_eq</span>.<br/>
&nbsp;&nbsp;<span class="id">forward</span> <span class="id">H8</span>. <span class="id">fmap_disjoint</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_req_sep_split</span> : <span class="kwd">forall</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">req</span> (<span class="id">H1</span> \* <span class="id">H2</span>) <span class="id">f</span>) (<span class="id">req</span> <span class="id">H1</span> (<span class="id">req</span> <span class="id">H2</span> <span class="id">f</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_req</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">hH1</span> <span class="id">hH2r</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_req</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">hH2</span> <span class="id">hr</span>. <span class="id">intros</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H</span> (<span class="id">hH1</span> \<span class="id">u</span> <span class="id">hH2</span>) <span class="id">hr</span> <span class="id">ltac</span>:(<span class="id">apply</span> <span class="id">hstar_intro</span>; <span class="id">auto</span>)).<br/>
&nbsp;&nbsp;<span class="id">forward</span> <span class="id">H</span>. <span class="id">fmap_eq</span>.<br/>
&nbsp;&nbsp;<span class="id">forward</span> <span class="id">H</span>. <span class="id">fmap_disjoint</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">Compaction rule 4 from the paper </div>
<span class="kwd">Lemma</span> <span class="id">norm_req_req</span> : <span class="kwd">forall</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">req</span> (<span class="id">H1</span> \* <span class="id">H2</span>) <span class="id">f</span>) (<span class="id">req</span> <span class="id">H1</span> (<span class="id">req</span> <span class="id">H2</span> <span class="id">f</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>.<br/>
&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">norm_req_sep_split</span>.<br/>
&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">norm_req_sep_combine</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">Splitting and combining <span class="bracket"><span class="id">ens_</span></span>s </div>
<span class="kwd">Lemma</span> <span class="id">satisfies_ens_ens_void_split</span> : <span class="kwd">forall</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> (<span class="id">H1</span> \* <span class="id">H2</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> <span class="id">H1</span>;; <span class="id">ens_</span> <span class="id">H2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">destruct</span> <span class="id">H</span> <span class="kwd">as</span> (<span class="id">v</span>&amp;<span class="id">h3</span>&amp;<span class="id">H3</span>&amp;<span class="id">H4</span>&amp;<span class="id">H5</span>&amp;<span class="id">H6</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_hpure_l</span> <span class="kwd">in</span> <span class="id">H4</span>. <span class="id">destruct</span> <span class="id">H4</span> <span class="kwd">as</span> (<span class="id">H4</span>&amp;<span class="id">H7</span>).<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;h3&nbsp;is&nbsp;the&nbsp;heap&nbsp;that&nbsp;H1&nbsp;and&nbsp;H2&nbsp;together&nbsp;add&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;find&nbsp;the&nbsp;intermediate&nbsp;heap&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hstar_inv</span> <span class="kwd">in</span> <span class="id">H7</span>. <span class="id">destruct</span> <span class="id">H7</span> <span class="kwd">as</span> (<span class="id">h0</span>&amp;<span class="id">h4</span>&amp;<span class="id">H8</span>&amp;<span class="id">H9</span>&amp;<span class="id">H10</span>&amp;<span class="id">H11</span>).<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;H1&nbsp;h0,&nbsp;H2&nbsp;h4&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">applys</span> <span class="id">s_seq</span> (<span class="id">h1</span> \<span class="id">u</span> <span class="id">h0</span>) (<span class="id">norm</span> <span class="id">vunit</span>).<br/>
&nbsp;&nbsp;{ <span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">vunit</span>. <span class="kwd">exists</span> <span class="id">h0</span>. <span class="id">intuition</span>. <span class="id">rewrite</span> <span class="id">hstar_hpure_l</span>. <span class="id">intuition</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">v</span>. <span class="kwd">exists</span> <span class="id">h4</span>. <span class="id">intuition</span>. <span class="id">rewrite</span> <span class="id">hstar_hpure_l</span>. <span class="id">intuition</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">satisfies_ens_ens_void_combine</span> : <span class="kwd">forall</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> <span class="id">H1</span>;; <span class="id">ens_</span> <span class="id">H2</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> (<span class="id">H1</span> \* <span class="id">H2</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;give&nbsp;up&nbsp;on&nbsp;careful&nbsp;reasoning&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H8</span> <span class="kwd">as</span> <span class="id">H8</span>. <span class="id">destr</span> <span class="id">H8</span>.<br/>
&nbsp;&nbsp;<span class="id">hinv</span> <span class="id">H</span>. <span class="id">hinv</span> <span class="id">H</span>. <span class="id">hinv</span> <span class="id">H6</span>. <span class="id">hinv</span> <span class="id">H6</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">v0</span>. <span class="kwd">exists</span> (<span class="id">h0</span> \<span class="id">u</span> <span class="id">h4</span>).<br/>
&nbsp;&nbsp;<span class="id">splits</span>*.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">hstar_assoc</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span>. <span class="id">rew_fmap</span> *.<br/>
&nbsp;&nbsp;<span class="id">hintro</span>; <span class="id">jauto</span>.<br/>
&nbsp;&nbsp;<span class="id">hintro</span>; <span class="id">jauto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">satisfies_ens_ens_void</span> : <span class="kwd">forall</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> <span class="id">H1</span>;; <span class="id">ens_</span> <span class="id">H2</span>) &lt;-&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> (<span class="id">H1</span> \* <span class="id">H2</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">split</span>.<br/>
&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">satisfies_ens_ens_void_combine</span>.<br/>
&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">satisfies_ens_ens_void_split</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_ens_ens_void_split</span> : <span class="kwd">forall</span> <span class="id">H1</span> <span class="id">H2</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">ens_</span> (<span class="id">H1</span> \* <span class="id">H2</span>)) (<span class="id">ens_</span> <span class="id">H1</span>;; <span class="id">ens_</span> <span class="id">H2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">apply</span> <span class="id">satisfies_ens_ens_void_split</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_ens_ens_void_combine</span> : <span class="kwd">forall</span> <span class="id">H1</span> <span class="id">H2</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">ens_</span> <span class="id">H1</span>;; <span class="id">ens_</span> <span class="id">H2</span>) (<span class="id">ens_</span> (<span class="id">H1</span> \* <span class="id">H2</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>; <span class="id">apply</span> <span class="id">satisfies_ens_ens_void_combine</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_ens_ens_void</span> : <span class="kwd">forall</span> <span class="id">H1</span> <span class="id">H2</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">ens_</span> (<span class="id">H1</span> \* <span class="id">H2</span>)) (<span class="id">ens_</span> <span class="id">H1</span>;; <span class="id">ens_</span> <span class="id">H2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>; <span class="id">split</span>.<br/>
&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">norm_ens_ens_void_split</span>.<br/>
&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">norm_ens_ens_void_combine</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">Compaction rule 5 from the paper </div>
<span class="kwd">Lemma</span> <span class="id">norm_ens_ens_void_l</span> : <span class="kwd">forall</span> <span class="id">H</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">ens_</span> <span class="id">H</span>;; <span class="id">ens</span> <span class="id">Q</span>) (<span class="id">ens</span> (<span class="id">Q</span> \*+ <span class="id">H</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H7</span> <span class="kwd">as</span> <span class="id">H7</span>. <span class="id">destr</span> <span class="id">H7</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hinv</span> <span class="id">H0</span>. <span class="id">hinv</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">v0</span>. <span class="kwd">exists</span> (<span class="id">h0</span> \<span class="id">u</span> <span class="id">h4</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">splits</span>*.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_comm</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hintro</span>; <span class="id">jauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rew_fmap</span> *. }<br/>
&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hinv</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span> <span class="id">s_seq</span> (<span class="id">h1</span> \<span class="id">u</span> <span class="id">x0</span>) (<span class="id">norm</span> <span class="id">vunit</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">vunit</span>. <span class="kwd">exists</span> <span class="id">x0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">splits</span>*.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hintro</span>; <span class="id">jauto</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">v</span>. <span class="kwd">exists</span> <span class="id">x</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">jauto</span>. } }<br/>
Qed.</div></details>
<br/>
<div class="doc">Splitting and combining <span class="bracket"><span class="id">ens</span></span> with results is more complex, and there does not seem to be a single equivalence. </div>
<span class="kwd">Lemma</span> <span class="id">satisfies_ens_sep_combine</span> : <span class="kwd">forall</span> <span class="id">Q1</span> <span class="id">Q2</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens</span> <span class="id">Q1</span>;; <span class="id">ens</span> <span class="id">Q2</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">r0</span> : <span class="id">val</span> =&gt; \<span class="kwd">exists</span> <span class="id">r1</span> : <span class="id">val</span>, <span class="id">Q1</span> <span class="id">r1</span> \* <span class="id">Q2</span> <span class="id">r0</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">fdestr</span> <span class="id">H</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="id">destruct</span> <span class="id">R</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">v</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H6</span> <span class="kwd">as</span> <span class="id">H6</span>. <span class="id">destr</span> <span class="id">H6</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id">h0</span> \<span class="id">u</span> <span class="id">h4</span>).<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hexists_intro</span> <span class="kwd">with</span> (<span class="id">x</span> := <span class="id">v0</span>).<br/>
<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hstar_intro</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span>. <span class="id">injects</span> <span class="id">H2</span>. <span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_ens_ens_combine</span> : <span class="kwd">forall</span> <span class="id">Q1</span> <span class="id">Q2</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">ens</span> <span class="id">Q1</span>;; <span class="id">ens</span> <span class="id">Q2</span>) (<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; \<span class="kwd">exists</span> <span class="id">r1</span>, <span class="id">Q1</span> <span class="id">r1</span> \* <span class="id">Q2</span> <span class="id">r</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">satisfies_ens_sep_combine</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">satisfies_ens_sep_split</span> : <span class="kwd">forall</span> <span class="id">H</span> <span class="id">Q</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens</span> (<span class="id">Q</span> \*+ <span class="id">H</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens</span> (<span class="kwd">fun</span> _ : <span class="id">val</span> =&gt; <span class="id">H</span>);; <span class="id">ens</span> <span class="id">Q</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H0</span> <span class="kwd">as</span> (<span class="id">v</span> &amp; <span class="id">h3</span> &amp; <span class="id">H1</span> &amp; <span class="id">H2</span> &amp; <span class="id">H3</span> &amp; <span class="id">H4</span>).<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;h3&nbsp;is&nbsp;the&nbsp;part&nbsp;satisfying&nbsp;both&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hstar_inv</span> <span class="kwd">in</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H2</span> <span class="kwd">as</span> (<span class="id">h0</span> &amp; <span class="id">h4</span> &amp; ? &amp; ? &amp; ? &amp; ?).<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;h0&nbsp;is&nbsp;the&nbsp;part&nbsp;satisfying&nbsp;Q,&nbsp;h4&nbsp;H&nbsp;*)</span><br/>
<br/>
&nbsp;&nbsp;<span class="id">applys</span> <span class="id">s_seq</span> (<span class="id">h1</span> \<span class="id">u</span> <span class="id">h4</span>) (<span class="id">norm</span> <span class="id">v</span>). <span class="comment">(*&nbsp;anything?&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="id">jauto</span>.<br/>
&nbsp;&nbsp;<span class="id">econstructor</span>; <span class="id">jauto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_ens_split</span> : <span class="kwd">forall</span> <span class="id">H</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">ens</span> (<span class="id">Q</span> \*+ <span class="id">H</span>)) (<span class="id">ens</span> (<span class="kwd">fun</span> _ =&gt; <span class="id">H</span>);; <span class="id">ens</span> <span class="id">Q</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">satisfies_ens_sep_split</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_ens_ens_void_comm</span> : <span class="kwd">forall</span> <span class="id">H1</span> <span class="id">H2</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">ens_</span> <span class="id">H1</span>;; <span class="id">ens_</span> <span class="id">H2</span>) (<span class="id">ens_</span> <span class="id">H2</span>;; <span class="id">ens_</span> <span class="id">H1</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">rewrite</span> &lt;- <span class="id">norm_ens_ens_void</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">norm_ens_ens_void</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_comm</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">rewrite</span> &lt;- <span class="id">norm_ens_ens_void</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">norm_ens_ens_void</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_comm</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_req_req_comm</span> : <span class="kwd">forall</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">req</span> <span class="id">H1</span> (<span class="id">req</span> <span class="id">H2</span> <span class="id">f</span>)) (<span class="id">req</span> <span class="id">H2</span> (<span class="id">req</span> <span class="id">H1</span> <span class="id">f</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">rewrite</span> &lt;- <span class="id">norm_req_req</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">norm_req_req</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_comm</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">rewrite</span> &lt;- <span class="id">norm_req_req</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">norm_req_req</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_comm</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_seq_forall_distr_r</span>: <span class="kwd">forall</span> (<span class="id">A</span>:<span class="kwd">Type</span>) (<span class="id">f</span>:<span class="id">A</span>-&gt;<span class="id">flow</span>) <span class="id">f1</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> ((<span class="id">∀</span> <span class="id">x</span>:<span class="id">A</span>, <span class="id">f</span> <span class="id">x</span>);; <span class="id">f1</span>) (<span class="id">∀</span> <span class="id">x</span>:<span class="id">A</span>, <span class="id">f</span> <span class="id">x</span>;; <span class="id">f1</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="id">intros</span> <span class="id">v</span>.<br/>
&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H</span> <span class="id">v</span>.<br/>
&nbsp;&nbsp;<span class="id">applys</span>* <span class="id">s_seq</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_seq_forall_distr_l</span>: <span class="kwd">forall</span> (<span class="id">A</span>:<span class="kwd">Type</span>) (<span class="id">f</span>:<span class="id">A</span>-&gt;<span class="id">flow</span>) <span class="id">f1</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">f1</span>;; (<span class="id">∀</span> <span class="id">x</span>:<span class="id">A</span>, <span class="id">f</span> <span class="id">x</span>)) (<span class="id">∀</span> <span class="id">x</span>:<span class="id">A</span>, <span class="id">f1</span>;; <span class="id">f</span> <span class="id">x</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H6</span> <span class="kwd">as</span> <span class="id">H6</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="id">intros</span> <span class="id">v</span>.<br/>
&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">H6</span> <span class="id">v</span>).<br/>
&nbsp;&nbsp;<span class="id">applys</span>* <span class="id">s_seq</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_seq_exists_distr_l</span>: <span class="kwd">forall</span> <span class="id">A</span> (<span class="id">f</span>:<span class="id">A</span>-&gt;<span class="id">flow</span>) <span class="id">f1</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">f1</span>;; (<span class="id">∃</span> <span class="id">x</span> : <span class="id">A</span>, <span class="id">f</span> <span class="id">x</span>)) (<span class="id">∃</span> <span class="id">x</span> : <span class="id">A</span>, <span class="id">f1</span>;; <span class="id">f</span> <span class="id">x</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">split</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H6</span> <span class="kwd">as</span> <span class="id">H6</span>. <span class="id">destr</span> <span class="id">H6</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">b</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span>~ <span class="id">s_seq</span> <span class="id">h3</span> <span class="id">R1</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span>~ <span class="id">s_seq</span> <span class="id">h3</span> <span class="id">R1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>. <span class="id">now</span> <span class="kwd">exists</span> <span class="id">b</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_seq_exists_distr_r</span> : <span class="kwd">forall</span> <span class="id">A</span> <span class="id">p</span> <span class="id">f1</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">fex</span> (<span class="kwd">fun</span> (<span class="id">x</span>:<span class="id">A</span>) =&gt; <span class="id">p</span> <span class="id">x</span>);; <span class="id">f1</span>) (<span class="id">fex</span> (<span class="kwd">fun</span> (<span class="id">x</span>:<span class="id">A</span>) =&gt; <span class="id">p</span> <span class="id">x</span>;; <span class="id">f1</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">split</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;{ <span class="id">fdestr</span> <span class="id">H</span>. <span class="id">fdestr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">b</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span>~ <span class="id">s_seq</span> <span class="id">h3</span> <span class="id">R1</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">fdestr</span> <span class="id">H</span>. <span class="id">fdestr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span>~ <span class="id">s_seq</span> <span class="id">h3</span> <span class="id">R1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">b</span>. <span class="id">assumption</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_ens_ens_pure_comm</span>: <span class="kwd">forall</span> <span class="id">H</span> <span class="id">P</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">ens_</span> <span class="id">H</span>;; <span class="id">ens_</span> \[<span class="id">P</span>]) (<span class="id">ens_</span> \[<span class="id">P</span>];; <span class="id">ens_</span> <span class="id">H</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">norm_ens_ens_void_comm</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">Rule EntEns from the paper </div>
<span class="kwd">Lemma</span> <span class="id">entails_ens_seq</span> : <span class="kwd">forall</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;<span class="id">H1</span> ==&gt; <span class="id">H2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f1</span> <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">ens_</span> <span class="id">H1</span>;; <span class="id">f1</span>) (<span class="id">ens_</span> <span class="id">H2</span>;; <span class="id">f2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H3</span> <span class="kwd">as</span> <span class="id">H3</span>. <span class="id">destr</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;eapply&nbsp;s_seq.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">apply</span> (<span class="id">satisfies_ens_void</span> <span class="id">H</span>) <span class="kwd">in</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;<span class="id">applys</span>* <span class="id">s_seq</span> <span class="id">h3</span> <span class="id">R1</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">Rule EntReq from the paper </div>
<span class="kwd">Lemma</span> <span class="id">entails_req_seq</span> : <span class="kwd">forall</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;<span class="id">H2</span> ==&gt; <span class="id">H1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f1</span> <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">req</span> <span class="id">H1</span> <span class="id">f1</span>) (<span class="id">req</span> <span class="id">H2</span> <span class="id">f2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">applys</span> <span class="id">entails_req</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">Rule DisjLeft from the paper </div>
<span class="kwd">Lemma</span> <span class="id">entails_disj_left</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">f3</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f1</span> <span class="id">f3</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f2</span> <span class="id">f3</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">disj</span> <span class="id">f1</span> <span class="id">f2</span>) <span class="id">f3</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H1</span> <span class="kwd">as</span> <span class="id">H1</span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">Half of DisjRight from the paper </div>
<span class="kwd">Lemma</span> <span class="id">entails_disj_right_l</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">f3</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f3</span> <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f3</span> (<span class="id">disj</span> <span class="id">f1</span> <span class="id">f2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_disj_l</span>.<br/>
&nbsp;&nbsp;<span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">The other half of DisjRight from the paper </div>
<span class="kwd">Lemma</span> <span class="id">entails_disj_right_r</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">f3</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f3</span> <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f3</span> (<span class="id">disj</span> <span class="id">f1</span> <span class="id">f2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_disj_r</span>.<br/>
&nbsp;&nbsp;<span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">EntFunc </div>
<span class="kwd">Lemma</span> <span class="id">entails_func</span> : <span class="kwd">forall</span> <span class="id">xf</span> <span class="id">a</span> <span class="id">r</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">unk</span> <span class="id">xf</span> <span class="id">a</span> <span class="id">r</span>) (<span class="id">unk</span> <span class="id">xf</span> <span class="id">a</span> <span class="id">r</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">entails_refl</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ens_match</span> : <span class="kwd">forall</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">H</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> <span class="id">H</span>;; <span class="id">f1</span>) -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>, <span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f1</span> -&gt; <span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">f2</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> <span class="id">H</span>;; <span class="id">f2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">finv</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">fintro</span>.<br/>
&nbsp;&nbsp;<span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_ens_req</span> : <span class="kwd">forall</span> <span class="id">H</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">ens_</span> <span class="id">H</span>;; <span class="id">req</span> <span class="id">H</span> <span class="id">f</span>) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">finv</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">finv</span> <span class="id">H0</span>. <span class="id">hinv</span> <span class="id">H0</span>. <span class="id">hinv</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H7</span> <span class="kwd">as</span> <span class="id">H7</span>.<br/>
&nbsp;&nbsp;<span class="id">forwards</span>: <span class="id">H7</span> <span class="id">x0</span> <span class="id">h1</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;<span class="id">fmap_eq</span>.<br/>
&nbsp;&nbsp;<span class="id">fmap_disjoint</span>.<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_req_assumption</span> : <span class="kwd">forall</span> <span class="id">H</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">ens_</span> <span class="id">H</span>;; <span class="id">f2</span>) <span class="id">f1</span> &lt;-&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f2</span> (<span class="id">req</span> <span class="id">H</span> <span class="id">f1</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H0</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;{ <span class="id">fintro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fintro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_ens</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">vunit</span> <span class="id">hp</span>. <span class="id">splits</span>*. <span class="id">hintro</span>. <span class="id">splits</span>*.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">finv</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">finv</span> <span class="id">H1</span>. <span class="id">hinv</span> <span class="id">H1</span>. <span class="id">hinv</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H0</span> <span class="kwd">in</span> <span class="id">H8</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H8</span> <span class="kwd">as</span> <span class="id">H8</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H8</span> <span class="id">x0</span> (<span class="id">h1</span> \<span class="id">u</span> <span class="id">x</span>) <span class="id">H4</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forwards</span>: <span class="id">H8</span>. <span class="id">fmap_eq</span>. <span class="id">fmap_disjoint</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span>. <span class="id">rew_fmap</span>*. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Definition</span> <span class="id">heap_inhab</span> <span class="id">H</span> := <span class="kwd">exists</span> <span class="id">h</span>, <span class="id">H</span> <span class="id">h</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id">precise</span> <span class="id">H</span> := <span class="kwd">forall</span> <span class="id">h1</span> <span class="id">h2</span>,<br/>
&nbsp;&nbsp;<span class="id">H</span> <span class="id">h1</span> -&gt; <span class="id">H</span> <span class="id">h2</span> -&gt; <span class="id">h1</span> = <span class="id">h2</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">ens_req_cancel</span> : <span class="kwd">forall</span> <span class="id">f</span> <span class="id">H</span>,<br/>
&nbsp;&nbsp;<span class="id">heap_inhab</span> <span class="id">H</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">precise</span> <span class="id">H</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f</span> (<span class="id">ens_</span> <span class="id">H</span>;; <span class="id">req</span> <span class="id">H</span> <span class="id">f</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">heap_inhab</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">Fmap.disjoint</span> <span class="id">h1</span> <span class="id">h</span>) <span class="kwd">as</span> ?. <span class="id">admit</span>.<br/>
&nbsp;&nbsp;<span class="id">fintro</span>.<br/>
&nbsp;&nbsp;<span class="id">fintro</span>. <span class="kwd">exists</span> <span class="id">h</span>.<br/>
&nbsp;&nbsp;<span class="id">splits</span>*.<br/>
&nbsp;&nbsp;<span class="id">hintro</span>. <span class="id">splits</span>*.<br/>
&nbsp;&nbsp;<span class="id">fintro</span>.<br/>
&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H1</span> <span class="id">H3</span> <span class="id">H4</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">lets</span>: <span class="id">union_eq_inv_of_disjoint</span> <span class="id">H5</span>.<br/>
&nbsp;&nbsp;<span class="id">fmap_disjoint</span>. <span class="id">fmap_disjoint</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Abort.</div></details>
<br/>
<h1> Biabduction </h1>
<div class="doc">Simplified definition following <a href="http://www0.cs.ucl.ac.uk/staff/p.ohearn/papers/popl09.pdf">Compositional Shape Analysis by means of Bi-Abduction</a> (Fig 1). </div>
<span class="kwd">Inductive</span> <span class="id">biab</span> : <span class="id">hprop</span> -&gt; <span class="id">hprop</span> -&gt; <span class="id">hprop</span> -&gt; <span class="id">hprop</span> -&gt; <span class="kwd">Prop</span> :=<br/>
<br/>
&nbsp;&nbsp;| <span class="id">b_trivial</span> : <span class="kwd">forall</span> <span class="id">H</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">biab</span> \[] <span class="id">H</span> <span class="id">H</span> \[]<br/>
<br/>
&nbsp;&nbsp;| <span class="id">b_base_empty</span> : <span class="kwd">forall</span> <span class="id">Hf</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">biab</span> \[] <span class="id">Hf</span> \[] <span class="id">Hf</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">b_pts_match</span> : <span class="kwd">forall</span> <span class="id">a</span> <span class="id">b</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">Ha</span> <span class="id">Hf</span> <span class="id">x</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">biab</span> <span class="id">Ha</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">Hf</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">biab</span> (\[<span class="id">a</span>=<span class="id">b</span>] \* <span class="id">Ha</span>) (<span class="id">x</span>~~&gt;<span class="id">a</span> \* <span class="id">H1</span>) (<span class="id">x</span>~~&gt;<span class="id">b</span> \* <span class="id">H2</span>) <span class="id">Hf</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">b_any_match</span> : <span class="kwd">forall</span> <span class="id">H</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">Ha</span> <span class="id">Hf</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">biab</span> <span class="id">Ha</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">Hf</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">biab</span> <span class="id">Ha</span> (<span class="id">H</span> \* <span class="id">H1</span>) (<span class="id">H</span> \* <span class="id">H2</span>) <span class="id">Hf</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">b_pts_diff</span> : <span class="kwd">forall</span> <span class="id">a</span> <span class="id">b</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">Ha</span> <span class="id">Hf</span> <span class="id">x</span> <span class="id">y</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">biab</span> <span class="id">Ha</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">Hf</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">biab</span> (<span class="id">y</span>~~&gt;<span class="id">b</span> \* <span class="id">Ha</span>) (<span class="id">x</span>~~&gt;<span class="id">a</span> \* <span class="id">H1</span>) (<span class="id">y</span>~~&gt;<span class="id">b</span> \* <span class="id">H2</span>) (<span class="id">x</span>~~&gt;<span class="id">a</span> \* <span class="id">Hf</span>).<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id">b_pts_single</span> : <span class="kwd">forall</span> <span class="id">x</span> <span class="id">a</span> <span class="id">b</span>,<br/>
&nbsp;&nbsp;<span class="id">biab</span> \[<span class="id">a</span>=<span class="id">b</span>] (<span class="id">x</span>~~&gt;<span class="id">a</span>) (<span class="id">x</span>~~&gt;<span class="id">b</span>) \[].<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- (<span class="id">hstar_hempty_r</span> (<span class="id">x</span>~~&gt;<span class="id">a</span>)).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- (<span class="id">hstar_hempty_r</span> (<span class="id">x</span>~~&gt;<span class="id">b</span>)).<br/>
&nbsp;&nbsp;<span class="id">applys_eq</span> <span class="id">b_pts_match</span>.<br/>
&nbsp;&nbsp;<span class="id">instantiate</span> (1 := \[]).<br/>
&nbsp;&nbsp;<span class="id">xsimpl</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">b_base_empty</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">b_pts_diff_single</span> : <span class="kwd">forall</span> <span class="id">x</span> <span class="id">y</span> <span class="id">a</span> <span class="id">b</span>,<br/>
&nbsp;&nbsp;<span class="id">biab</span> (<span class="id">y</span>~~&gt;<span class="id">b</span>) (<span class="id">x</span>~~&gt;<span class="id">a</span>) (<span class="id">y</span>~~&gt;<span class="id">b</span>) (<span class="id">x</span>~~&gt;<span class="id">a</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- (<span class="id">hstar_hempty_r</span> (<span class="id">x</span>~~&gt;<span class="id">a</span>)).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- (<span class="id">hstar_hempty_r</span> (<span class="id">y</span>~~&gt;<span class="id">b</span>)).<br/>
&nbsp;&nbsp;<span class="id">applys_eq</span> <span class="id">b_pts_diff</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">b_base_empty</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">biab_sound</span> : <span class="kwd">forall</span> <span class="id">Ha</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">Hf</span>,<br/>
&nbsp;&nbsp;<span class="id">biab</span> <span class="id">Ha</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">Hf</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Ha</span> \* <span class="id">H1</span> ==&gt; <span class="id">H2</span> \* <span class="id">Hf</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">xsimpl</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">xsimpl</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">xsimpl</span>; <span class="id">auto</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">xsimpl</span>. <span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">xsimpl</span>. <span class="id">assumption</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">biab_single_h_conv</span> : <span class="kwd">forall</span> <span class="id">H</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> <span class="id">H1</span>;; <span class="id">req</span> <span class="id">H2</span> <span class="id">f</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> (<span class="id">H</span> \* <span class="id">H1</span>);; <span class="id">req</span> (<span class="id">H</span> \* <span class="id">H2</span>) <span class="id">f</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">hstar_comm</span> <span class="id">H</span> <span class="id">H1</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">norm_ens_ens_void</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">seq_assoc</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> (<span class="id">ens_match</span> <span class="id">H0</span>). <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">norm_req_req</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;apply&nbsp;ens_req_cancel.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;assumption.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">admit</span>.<br/>
Abort.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">biab_single_h</span> : <span class="kwd">forall</span> <span class="id">H</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> (<span class="id">H</span> \* <span class="id">H1</span>);; <span class="id">req</span> (<span class="id">H</span> \* <span class="id">H2</span>) <span class="id">f</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> <span class="id">H1</span>;; <span class="id">req</span> <span class="id">H2</span> <span class="id">f</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;ens&nbsp;adds&nbsp;a&nbsp;location&nbsp;to&nbsp;the&nbsp;heap&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;use&nbsp;that&nbsp;to&nbsp;figure&nbsp;out&nbsp;what&nbsp;is&nbsp;in&nbsp;h3&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">destr</span> <span class="id">H0</span>. <span class="id">hinv</span> <span class="id">H0</span>. <span class="id">hinv</span> <span class="id">H0</span>. <span class="id">hinv</span> <span class="id">H5</span>. <span class="id">subst</span> <span class="id">h0</span> <span class="id">h3</span> <span class="id">x0</span> <span class="id">x</span>. <span class="id">rew_fmap</span> *.<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;prove&nbsp;just&nbsp;the&nbsp;first&nbsp;part&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">norm_req_req</span> <span class="kwd">in</span> <span class="id">H9</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H9</span> <span class="kwd">as</span> <span class="id">H9</span>. <span class="id">specializes</span> <span class="id">H9</span> <span class="id">x1</span> (<span class="id">h1</span> \<span class="id">u</span> <span class="id">x2</span>) <span class="id">___</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">applys</span> <span class="id">s_seq</span> (<span class="id">h1</span> \<span class="id">u</span> <span class="id">x2</span>) (<span class="id">norm</span> <span class="id">vunit</span>).<br/>
&nbsp;&nbsp;{ <span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">vunit</span>. <span class="kwd">exists</span> <span class="id">x2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">splits</span>*. <span class="id">hintro</span>; <span class="id">jauto</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">assumption</span>. }<br/>
Qed.</div></details>
<br/>
<div class="doc">Biabduction for a single location. </div>
<span class="kwd">Lemma</span> <span class="id">biab_single</span> : <span class="kwd">forall</span> <span class="id">x</span> <span class="id">a</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> (<span class="id">x</span>~~&gt;<span class="id">a</span> \* <span class="id">H1</span>);; <span class="id">req</span> (<span class="id">x</span>~~&gt;<span class="id">a</span> \* <span class="id">H2</span>) <span class="id">f</span>)-&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span> (<span class="id">ens_</span> <span class="id">H1</span>;; <span class="id">req</span> <span class="id">H2</span> <span class="id">f</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">applys</span>* <span class="id">biab_single_h</span> (<span class="id">x</span>~~&gt;<span class="id">a</span>).<br/>
Qed.</div></details>
<br/>
<div class="doc">We can remove a framing heap <span class="bracket"><span class="id">hf</span></span> from both sides of a <span class="bracket"><span class="id">satisfies</span></span> if it is disjoint from the part of the heap satisfying <span class="bracket"><span class="id">ens_</span> <span class="id">H</span></span>. </div>
<span class="kwd">Lemma</span> <span class="id">ens_reduce_frame</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h</span> <span class="id">hf</span> <span class="id">R</span> <span class="id">H</span>,<br/>
&nbsp;&nbsp;<span class="id">H</span> <span class="id">h</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">Fmap.disjoint</span> <span class="id">h</span> (<span class="id">hf</span> \<span class="id">u</span> <span class="id">h1</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> (<span class="id">hf</span> \<span class="id">u</span> <span class="id">h1</span>) (<span class="id">hf</span> \<span class="id">u</span> <span class="id">h1</span> \<span class="id">u</span> <span class="id">h</span>) <span class="id">R</span> (<span class="id">ens_</span> <span class="id">H</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> (<span class="id">h1</span> \<span class="id">u</span> <span class="id">h</span>) <span class="id">R</span> (<span class="id">ens_</span> <span class="id">H</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">introv</span> <span class="id">H0</span> <span class="id">Hd</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H1</span> <span class="kwd">as</span> <span class="id">H1</span>. <span class="id">destr</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_hpure_l</span> <span class="kwd">in</span> <span class="id">H1</span>. <span class="id">destr</span> <span class="id">H1</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">v</span>. <span class="kwd">exists</span> <span class="id">h3</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_hpure_l</span>. <span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">fmap_eq</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">forwards</span>: <span class="id">Fmap.union_eq_inv_of_disjoint</span> (<span class="id">hf</span> \<span class="id">u</span> <span class="id">h1</span>) <span class="id">h</span> <span class="id">h3</span>.<br/>
&nbsp;&nbsp;<span class="id">fmap_disjoint</span>.<br/>
&nbsp;&nbsp;<span class="id">fmap_disjoint</span>.<br/>
&nbsp;&nbsp;{ <span class="id">asserts_rewrite</span> (<span class="id">h</span> \<span class="id">u</span> <span class="id">hf</span> \<span class="id">u</span> <span class="id">h1</span> = <span class="id">hf</span> \<span class="id">u</span> <span class="id">h1</span> \<span class="id">u</span> <span class="id">h</span>). <span class="id">fmap_eq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">asserts_rewrite</span> (<span class="id">h3</span> \<span class="id">u</span> <span class="id">hf</span> \<span class="id">u</span> <span class="id">h1</span> = (<span class="id">hf</span> \<span class="id">u</span> <span class="id">h1</span>) \<span class="id">u</span> <span class="id">h3</span>). <span class="id">fmap_eq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">transpose_pts_diff</span> : <span class="kwd">forall</span> <span class="id">Ha</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">Hf</span> <span class="id">f</span> <span class="id">x</span> <span class="id">y</span> <span class="id">a</span> <span class="id">b</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">ens_</span> <span class="id">H1</span>;; <span class="id">req</span> <span class="id">H2</span> <span class="id">f</span>) (<span class="id">req</span> <span class="id">Ha</span> (<span class="id">ens_</span> <span class="id">Hf</span>;; <span class="id">f</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ens_</span> (<span class="id">x</span> ~~&gt; <span class="id">a</span> \* <span class="id">H1</span>);; <span class="id">req</span> (<span class="id">y</span> ~~&gt; <span class="id">b</span> \* <span class="id">H2</span>) <span class="id">f</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">req</span> (<span class="id">y</span> ~~&gt; <span class="id">b</span> \* <span class="id">Ha</span>) (<span class="id">ens_</span> (<span class="id">x</span> ~~&gt; <span class="id">a</span> \* <span class="id">Hf</span>);; <span class="id">f</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="comment">(*&nbsp;the&nbsp;idea&nbsp;of&nbsp;this&nbsp;proof&nbsp;is&nbsp;to&nbsp;demonstrate&nbsp;that&nbsp;we&nbsp;can&nbsp;commute&nbsp;adding&nbsp;x~~&gt;a&nbsp;and&nbsp;removing&nbsp;y~~&gt;b,&nbsp;by&nbsp;showing&nbsp;that:&nbsp;we&nbsp;can&nbsp;start&nbsp;from&nbsp;a&nbsp;heap&nbsp;without&nbsp;x~~&gt;a&nbsp;(using&nbsp;the&nbsp;lemma&nbsp;ens_reduce_frame),&nbsp;perform&nbsp;the&nbsp;operations,&nbsp;and&nbsp;arrive&nbsp;at&nbsp;the&nbsp;same&nbsp;result.&nbsp;*)</span><br/>
<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">finv</span> <span class="id">H0</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;extract&nbsp;everything&nbsp;we&nbsp;can&nbsp;first.&nbsp;start&nbsp;with&nbsp;x-&gt;a&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">norm_ens_ens_void</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="id">finv</span> <span class="id">H0</span>. <span class="id">finv</span> <span class="id">H0</span>. <span class="id">hinv</span> <span class="id">H0</span>. <span class="id">hinv</span> <span class="id">H0</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;and&nbsp;y-&gt;b&nbsp;and&nbsp;Ha&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">norm_req_req</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_req</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_req</span>. <span class="id">intros</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;now,&nbsp;start&nbsp;supplying&nbsp;stuff.&nbsp;x-&gt;a&nbsp;is&nbsp;easy&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">norm_ens_ens_void</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id">norm_seq_assoc</span>.<br/>
&nbsp;&nbsp;<span class="id">applys</span> <span class="id">s_seq</span> (<span class="id">hr0</span> \<span class="id">u</span> <span class="id">x1</span>) (<span class="id">norm</span> <span class="id">vunit</span>).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_ens</span>. <span class="kwd">exists</span> <span class="id">vunit</span> <span class="id">x1</span>. <span class="id">splits</span>*. <span class="id">hintro</span>. <span class="id">jauto</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;supply&nbsp;y-&gt;b.&nbsp;to&nbsp;do&nbsp;this,&nbsp;we&nbsp;need&nbsp;to&nbsp;find&nbsp;h3-h(y-&gt;b).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;h3&nbsp;=&nbsp;h(H1)&nbsp;+&nbsp;h0<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;h(H1)&nbsp;+&nbsp;h(x-&gt;a)&nbsp;+&nbsp;h1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;h(H1)&nbsp;+&nbsp;h(x-&gt;a)&nbsp;+&nbsp;hr&nbsp;+&nbsp;h(y-&gt;b)<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;h3&nbsp;-&nbsp;h(y-&gt;b)&nbsp;=&nbsp;h(H1)&nbsp;+&nbsp;h(x-&gt;a)&nbsp;+&nbsp;hr<br/>
&nbsp;&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> <span class="id">H10</span>. <span class="id">finv</span> <span class="id">H18</span>. <span class="id">hinv</span> <span class="id">H18</span>. <span class="id">hinv</span> <span class="id">H18</span>. <span class="comment">(*&nbsp;find&nbsp;out&nbsp;h(H1)&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">norm_req_req</span> <span class="kwd">in</span> <span class="id">H9</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H9</span> <span class="kwd">as</span> <span class="id">H9</span>. <span class="id">specializes</span> <span class="id">H9</span> <span class="id">hp</span> (<span class="id">x1</span> \<span class="id">u</span> <span class="id">hr</span> \<span class="id">u</span> <span class="id">x3</span>) <span class="id">H12</span>.<br/>
&nbsp;&nbsp;<span class="id">forward</span> <span class="id">H9</span> <span class="kwd">by</span> <span class="id">fmap_eq</span>. <span class="id">forward</span> <span class="id">H9</span> <span class="kwd">by</span> <span class="id">fmap_disjoint</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;now&nbsp;we&nbsp;are&nbsp;trying&nbsp;to&nbsp;supply&nbsp;the&nbsp;premise&nbsp;of&nbsp;H.&nbsp;to&nbsp;do&nbsp;this<br/>
&nbsp;&nbsp;&nbsp;&nbsp;we&nbsp;need&nbsp;to&nbsp;remove&nbsp;h(y-&gt;2)&nbsp;from&nbsp;both&nbsp;sides&nbsp;of&nbsp;H10.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">h0</span> <span class="id">h3</span> <span class="id">h1</span>.<br/>
&nbsp;&nbsp;<span class="id">lets</span>: <span class="id">ens_reduce_frame</span> (<span class="id">hr</span> \<span class="id">u</span> <span class="id">h4</span>) <span class="id">x3</span> <span class="id">hp</span> <span class="id">H21</span>.<br/>
&nbsp;&nbsp;<span class="id">forward</span> <span class="id">H4</span> <span class="kwd">by</span> <span class="id">fmap_disjoint</span>.<br/>
&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H4</span>. <span class="id">applys_eq</span> <span class="id">H10</span>. <span class="id">fmap_eq</span>. <span class="id">fmap_eq</span>.<br/>
&nbsp;&nbsp;<span class="id">clear</span> <span class="id">H10</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;finally,&nbsp;we&nbsp;can&nbsp;use&nbsp;H.&nbsp;build&nbsp;a&nbsp;seq&nbsp;to&nbsp;do&nbsp;that&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">lets</span>: <span class="id">s_seq</span> <span class="id">H4</span>. <span class="id">specializes</span> <span class="id">H10</span>. <span class="id">applys_eq</span> <span class="id">H9</span>. <span class="id">fmap_eq</span>. <span class="id">clear</span> <span class="id">H4</span> <span class="id">H9</span>.<br/>
&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H</span> <span class="id">H10</span>. <span class="id">clear</span> <span class="id">H10</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Ha&nbsp;is&nbsp;in&nbsp;the&nbsp;way,&nbsp;but&nbsp;otherwise&nbsp;we&nbsp;are&nbsp;done&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">subst</span>. <span class="id">rew_fmap</span> *.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H</span> <span class="id">hp0</span> <span class="id">H15</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">The <span class="bracket"><span class="id">Float</span> <span class="id">Pre</span></span> rule (compaction 6) from the paper. </div>
<span class="kwd">Lemma</span> <span class="id">norm_ens_req_transpose</span> : <span class="kwd">forall</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">Ha</span> <span class="id">Hf</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">biab</span> <span class="id">Ha</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">Hf</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">ens_</span> <span class="id">H1</span>;; <span class="id">req</span> <span class="id">H2</span> <span class="id">f</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">req</span> <span class="id">Ha</span> (<span class="id">ens_</span> <span class="id">Hf</span>;; <span class="id">f</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>.<br/>
&nbsp;&nbsp;<span class="id">introv</span> <span class="id">Hbi</span>.<br/>
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">Hbi</span>.<br/>
<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;trivial&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">introv</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ens_req_inv</span> <span class="kwd">in</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">norm_seq_req_emp</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">norm_seq_ens_empty</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;base&nbsp;case&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">introv</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">norm_seq_req_emp</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">norm_seq_req_emp</span> <span class="kwd">in</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;b_pts_match&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;use&nbsp;the&nbsp;req&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">norm_req_req</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>. <span class="id">intros</span>. <span class="id">hinv</span> <span class="id">H0</span>. <span class="id">subst</span>. <span class="id">rew_fmap</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> (<span class="id">IHHbi</span> <span class="id">env</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> (<span class="id">biab_single</span> <span class="id">H</span>). }<br/>
<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;b_any_match&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">IHHbi</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span>* <span class="id">biab_single_h</span> <span class="id">H</span>. }<br/>
<br/>
&nbsp;&nbsp;{ <span class="comment">(*&nbsp;b_pts_diff&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">introv</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> <span class="id">transpose_pts_diff</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H</span> <span class="id">IHHbi</span> <span class="id">H3</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Module</span> <span class="id">BiabductionExamples</span>.<br/>
<br/>
<div class="doc"><span class="bracket">(<span class="id">a</span>=3) * <span class="id">x</span>-&gt;<span class="id">a</span>*<span class="id">y</span>-&gt;<span class="id">b</span> |- <span class="id">x</span>-&gt;3 * (<span class="id">y</span>-&gt;<span class="id">b</span>)</span> </div>
&nbsp;&nbsp;<span class="kwd">Example</span> <span class="id">ex1_biab</span> : <span class="kwd">forall</span> <span class="id">x</span> <span class="id">y</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">Ha</span> <span class="id">Hf</span> <span class="id">i</span>, <span class="id">biab</span> <span class="id">Ha</span> (<span class="id">x</span>~~&gt;<span class="id">vint</span> <span class="id">i</span> \* <span class="id">y</span>~~&gt;<span class="id">vint</span> 2) (<span class="id">x</span>~~&gt;<span class="id">vint</span> 3) <span class="id">Hf</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eexists</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eexists</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eexists</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- (<span class="id">hstar_hempty_r</span> (<span class="id">x</span> ~~&gt; <span class="id">vint</span> 3)) <span class="kwd">at</span> 2.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">b_pts_match</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">b_base_empty</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Example</span> <span class="id">ex2_biab</span> : <span class="kwd">forall</span> <span class="id">x</span> <span class="id">y</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">Ha</span> <span class="id">Hf</span>, <span class="id">biab</span> <span class="id">Ha</span> (<span class="id">x</span>~~&gt;<span class="id">vint</span> 2) (<span class="id">y</span>~~&gt;<span class="id">vint</span> 3) <span class="id">Hf</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eexists</span>. <span class="id">eexists</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- (<span class="id">hstar_hempty_r</span> (<span class="id">x</span> ~~&gt; <span class="id">vint</span> 2)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- (<span class="id">hstar_hempty_r</span> (<span class="id">y</span> ~~&gt; <span class="id">vint</span> 3)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lets</span> <span class="id">H1</span>: <span class="id">b_pts_diff</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">b_base_empty</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
<br/>
<div class="doc">Example from Appendex D of the paper </div>
&nbsp;&nbsp;<span class="kwd">Example</span> <span class="id">ex3_intersection</span> : <span class="kwd">forall</span> <span class="id">x</span> <span class="id">y</span> <span class="id">a</span> <span class="id">b</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">ens_</span> (<span class="id">x</span>~~&gt;<span class="id">a</span>);; <span class="id">req_</span> (<span class="id">y</span>~~&gt;<span class="id">b</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">intersect</span> (<span class="id">req_</span> \[<span class="id">x</span>=<span class="id">y</span> /\ <span class="id">a</span>=<span class="id">b</span>])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">req</span> (<span class="id">y</span>~~&gt;<span class="id">b</span>) (<span class="id">ens_</span> (<span class="id">x</span>~~&gt;<span class="id">a</span>)))).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">constructor</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hpure_inv</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>. <span class="id">subst</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">norm_ens_req_transpose</span> <span class="kwd">in</span> <span class="id">H</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">only</span> 2: <span class="id">apply</span> <span class="id">b_pts_single</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">simpl</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">specializes</span> <span class="id">H</span> <span class="id">empty_heap</span> <span class="id">hr</span> <span class="id">___</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hpure_intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fmap_eq</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">norm_seq_ens_empty</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">rewrite</span> <span class="id">norm_ens_req_transpose</span> <span class="kwd">in</span> <span class="id">H</span>; <span class="id">only</span> 2: <span class="id">apply</span> <span class="id">b_pts_diff_single</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id">norm_ens_empty_r</span> (<span class="id">x</span>~~&gt;<span class="id">a</span>)) .<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">norm_ens_empty_r</span> (<span class="id">x</span>~~&gt;<span class="id">a</span>)) <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
<span class="kwd">End</span> <span class="id">BiabductionExamples</span>.<br/>
<br/>
<h1> Lemmas about pure fact simplification </h1>
<div class="doc">This section provides a few lemmas showing that once a pure predicate has
    been proven/ensured, it can be used again later down the specification. This
    can be useful when it comes to simplification of the spec. </div>
<span class="kwd">Lemma</span> <span class="id">req_generates_info</span>: <span class="kwd">forall</span>  <span class="id">P</span> <span class="id">p</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">original_flow</span> := <span class="id">req</span> (<span class="id">p</span> \* \[<span class="id">P</span>]) <span class="id">f</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">new_flow</span> := <span class="id">req</span> (<span class="id">p</span> \* \[<span class="id">P</span>]) (<span class="id">ens_</span> \[<span class="id">P</span>] ;; <span class="id">f</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">original_flow</span> <span class="id">new_flow</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">unfold</span> <span class="id">original_flow</span>, <span class="id">new_flow</span>, <span class="id">entails</span>. <span class="id">clear</span> <span class="id">original_flow</span> <span class="id">new_flow</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">r</span> <span class="id">H</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Remove&nbsp;prefix&nbsp;req&nbsp;p&nbsp;from&nbsp;both&nbsp;the&nbsp;goal&nbsp;and&nbsp;the&nbsp;hypothesis&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">norm_req_req</span>. <span class="id">apply</span> <span class="id">s_req</span>. <span class="id">intros</span> <span class="id">hp</span> <span class="id">hr</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">norm_req_req</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">specialize</span> (<span class="id">H</span> <span class="id">hp</span> <span class="id">hr</span>). <span class="id">specialize</span>(<span class="id">H</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">H3</span>).<br/>
&nbsp;&nbsp;<span class="id">subst</span>. <span class="id">clear</span> <span class="id">H1</span> <span class="id">H3</span> <span class="id">p</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Remove&nbsp;req&nbsp;\[P]&nbsp;from&nbsp;goal&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_req</span>. <span class="id">intros</span> <span class="id">hp'</span> <span class="id">hr'</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">H3</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">HP</span>: <span class="id">hp'</span> = <span class="id">empty_heap</span>). <span class="comment">(*&nbsp;and&nbsp;thus&nbsp;hr&nbsp;=&nbsp;hr'&nbsp;*)</span><br/>
&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H1</span>. <span class="id">inverts</span> <span class="id">H0</span>. <span class="id">reflexivity</span>. }<br/>
<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">specialize</span> (<span class="id">H</span> <span class="id">hp'</span> <span class="id">hr'</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">H3</span>). <span class="id">subst</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">s_seq</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ens_void_pure_intro</span>. <span class="id">destruct</span> <span class="id">H1</span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">req_generates_info_bientails</span>: <span class="kwd">forall</span>  <span class="id">P</span> <span class="id">p</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">original_flow</span> := <span class="id">req</span> (<span class="id">p</span> \* \[<span class="id">P</span>]) <span class="id">f</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">new_flow</span> := <span class="id">req</span> (<span class="id">p</span> \* \[<span class="id">P</span>]) (<span class="id">ens_</span> \[<span class="id">P</span>] ;; <span class="id">f</span>) <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="id">bientails</span> <span class="id">original_flow</span> <span class="id">new_flow</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">unfold</span> <span class="id">original_flow</span>, <span class="id">new_flow</span>, <span class="id">entails</span>. <span class="id">clear</span> <span class="id">original_flow</span> <span class="id">new_flow</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">req_generates_info</span>.<br/>
&nbsp;&nbsp;- <span class="id">intros</span> <span class="id">H</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Remove&nbsp;req&nbsp;p&nbsp;\*&nbsp;\[P]&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_req</span>. <span class="id">intros</span> <span class="id">hp</span> <span class="id">hr</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">specialize</span> (<span class="id">H</span> <span class="id">hp</span> <span class="id">hr</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">H3</span>).<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Just&nbsp;prove&nbsp;the&nbsp;ens_&nbsp;f&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">seq_ens_void_pure_inv</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">destruct</span> <span class="id">H</span>. <span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ens_generates_info</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">q</span> <span class="id">f</span> <span class="id">g</span>,<br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">original_flow</span> := <span class="id">ens_</span> (<span class="id">q</span> \* \[<span class="id">P</span>]) ;; <span class="id">f</span> ;; <span class="id">g</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">new_flow</span>      := <span class="id">ens_</span> (<span class="id">q</span> \* \[<span class="id">P</span>]) ;; <span class="id">f</span> ;; <span class="id">req_</span> \[<span class="id">P</span>] ;; <span class="id">g</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">original_flow</span> <span class="id">new_flow</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">unfold</span> <span class="id">original_flow</span>, <span class="id">new_flow</span>, <span class="id">entails</span>. <span class="id">clear</span> <span class="id">original_flow</span> <span class="id">new_flow</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">r</span> <span class="id">H</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">fdestr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">s_seq</span>. <span class="id">eassumption</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">fdestr</span> <span class="id">H6</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">s_seq</span>.<br/>
&nbsp;&nbsp;<span class="id">eassumption</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">s_seq</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">req_void_pure_intro</span>.<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ens_generates_info_bientails</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">q</span> <span class="id">f</span> <span class="id">g</span>,<br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">original_flow</span> := <span class="id">ens_</span> (<span class="id">q</span> \* \[<span class="id">P</span>]) ;; <span class="id">f</span> ;; <span class="id">g</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="kwd">let</span> <span class="id">new_flow</span>      := <span class="id">ens_</span> (<span class="id">q</span> \* \[<span class="id">P</span>]) ;; <span class="id">f</span> ;; <span class="id">req_</span> \[<span class="id">P</span>] ;; <span class="id">g</span> <span class="kwd">in</span><br/>
&nbsp;&nbsp;<span class="id">bientails</span> <span class="id">original_flow</span> <span class="id">new_flow</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">unfold</span> <span class="id">original_flow</span>, <span class="id">new_flow</span>, <span class="id">entails</span>. <span class="id">clear</span> <span class="id">original_flow</span> <span class="id">new_flow</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">ens_generates_info</span>.<br/>
&nbsp;&nbsp;- <span class="id">intro</span> <span class="id">H</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Remove&nbsp;the&nbsp;ens_&nbsp;q&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fdestr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">s_seq</span>. <span class="id">eassumption</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Extract&nbsp;proof&nbsp;of&nbsp;P.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_comm</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">norm_ens_ens_void</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">fdestr</span> <span class="id">H</span>. <span class="id">fdestr</span> <span class="id">H</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Proving&nbsp;env,&nbsp;h3,&nbsp;h2,&nbsp;r&nbsp;|=&nbsp;(f;;&nbsp;g)&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fdestr</span> <span class="id">H6</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">s_seq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eassumption</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fdestr</span> <span class="id">H10</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">req_void_pure_inv</span> <span class="kwd">in</span> <span class="id">H10</span>. <span class="id">destr</span> <span class="id">H10</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<div class="doc">In ens_generates_info, the final flow g is not within the context of
    req_ \<span class="bracket"><span class="id">P</span></span> (i.e. req \<span class="bracket"><span class="id">P</span></span> g). This is inconsequential as we can bring g in
    and out of the context of the req.
    This is important for the normalized form of a specification. </div>
<span class="kwd">Lemma</span> <span class="id">move_seq_into_req</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">req_</span> <span class="id">P</span> ;; <span class="id">f</span>) (<span class="id">req</span> <span class="id">P</span> <span class="id">f</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">bientails</span> (<span class="id">req</span> <span class="id">P</span> <span class="id">f</span>) (<span class="id">req</span> <span class="id">P</span> (<span class="id">empty</span> ;; <span class="id">f</span>))) <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">rewrite</span>  (<span class="id">norm_empty_l</span> <span class="id">f</span>). <span class="id">reflexivity</span>. }<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">norm_reassoc</span> <span class="kwd">with</span> (<span class="id">H</span> := <span class="id">P</span>) (<span class="id">f1</span> := <span class="id">empty</span>) (<span class="id">f2</span> := <span class="id">f</span>).<br/>
Qed.</div></details>
<br/>
<div class="doc">The converse is true if P is pure and P holds. </div>
<span class="kwd">Lemma</span> <span class="id">move_seq_out_of_req_pure</span>: <span class="kwd">forall</span> <span class="id">P</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">P</span> -&gt; <span class="id">entails</span> (<span class="id">req</span> \[<span class="id">P</span>] <span class="id">f</span>) (<span class="id">req_</span> \[<span class="id">P</span>] ;; <span class="id">f</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">P</span> <span class="id">f</span> <span class="id">HP</span>. <span class="id">unfold</span> <span class="id">entails</span>. <span class="id">intros</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">r</span> <span class="id">H</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">s_seq</span>.<br/>
&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">req_void_pure_intro</span>.<br/>
&nbsp;&nbsp;- <span class="id">apply</span> (<span class="id">req_pure_inv</span> <span class="id">HP</span>) <span class="kwd">in</span> <span class="id">H</span>. <span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_disj_ens_distr</span>: <span class="kwd">forall</span> <span class="id">P1</span> <span class="id">P2</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">bientails</span> (<span class="id">ens_</span> \[<span class="id">P1</span> \/ <span class="id">P2</span>]) (<span class="id">disj</span> (<span class="id">ens_</span> \[<span class="id">P1</span>]) (<span class="id">ens_</span> \[<span class="id">P2</span>])).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">bientails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;{ <span class="id">fdestr</span> <span class="id">H</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id">s_disj_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">ens_void_pure_intro</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id">s_disj_r</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">ens_void_pure_intro</span>. } }<br/>
&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">fdestr</span> <span class="id">H</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">ens_void_pure_intro</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">fdestr</span> <span class="id">H</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span>* <span class="id">ens_void_pure_intro</span>. } }<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_disj_req_distr</span>: <span class="kwd">forall</span> <span class="id">P1</span> <span class="id">P2</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">disj</span> (<span class="id">req</span> \[<span class="id">P1</span>] <span class="id">f</span>) (<span class="id">req</span> \[<span class="id">P2</span>] <span class="id">f</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">req</span> \[<span class="id">P1</span> /\ <span class="id">P2</span>] <span class="id">f</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">req_pure_intro</span>. <span class="id">intros</span> [? ?].<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;- <span class="id">apply</span> (<span class="id">req_pure_inv</span> <span class="id">H0</span>) <span class="kwd">in</span> <span class="id">H</span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;- <span class="id">apply</span> (<span class="id">req_pure_inv</span> <span class="id">H1</span>) <span class="kwd">in</span> <span class="id">H</span>. <span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">norm_req_disj_distr</span>: <span class="kwd">forall</span> <span class="id">P1</span> <span class="id">P2</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">req</span> \[<span class="id">P1</span> \/ <span class="id">P2</span>] <span class="id">f</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">disj</span> (<span class="id">req</span> \[<span class="id">P1</span>] <span class="id">f</span>) (<span class="id">req</span> \[<span class="id">P2</span>] <span class="id">f</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_disj_l</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">req_pure_intro</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">req_pure_inv</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;- <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;- <span class="id">left</span>. <span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<h1> Lemmas about entailment sequents </h1>
<span class="kwd">Lemma</span> <span class="id">entails_ent</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f1</span> <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f1</span> <span class="id">f2</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>, <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_entails</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">env</span>, <span class="id">entails_under</span> <span class="id">env</span> <span class="id">f1</span> <span class="id">f2</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f1</span> <span class="id">f2</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>, <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_entails_1</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">f3</span> <span class="id">f4</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">env</span>, <span class="id">entails_under</span> <span class="id">env</span> <span class="id">f1</span> <span class="id">f2</span> -&gt; <span class="id">entails_under</span> <span class="id">env</span> <span class="id">f3</span> <span class="id">f4</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f1</span> <span class="id">f2</span> -&gt; <span class="id">entails</span> <span class="id">f3</span> <span class="id">f4</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ent_entails</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">entails_ent</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H0</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_all_r</span> : <span class="kwd">forall</span> <span class="id">f</span> <span class="id">A</span> (<span class="id">fctx</span>:<span class="id">A</span> -&gt; <span class="id">flow</span>) <span class="id">env</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">b</span>, <span class="id">entails_under</span> <span class="id">env</span> <span class="id">f</span> (<span class="id">fctx</span> <span class="id">b</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f</span> (<span class="id">fall</span> (<span class="kwd">fun</span> <span class="id">b</span> =&gt; <span class="id">fctx</span> <span class="id">b</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="id">intros</span> <span class="id">b</span>.<br/>
&nbsp;&nbsp;<span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_all_l</span> : <span class="kwd">forall</span> <span class="id">f</span> <span class="id">A</span> (<span class="id">fctx</span>:<span class="id">A</span> -&gt; <span class="id">flow</span>) <span class="id">env</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">exists</span> <span class="id">b</span>, <span class="id">entails_under</span> <span class="id">env</span> (<span class="id">fctx</span> <span class="id">b</span>) <span class="id">f</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">fall</span> (<span class="kwd">fun</span> <span class="id">b</span> =&gt; <span class="id">fctx</span> <span class="id">b</span>)) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">specializes</span> <span class="id">H0</span> <span class="id">b</span>.<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_seq_all_l</span> : <span class="kwd">forall</span> <span class="id">f</span> <span class="id">f1</span> <span class="id">A</span> (<span class="id">fctx</span>:<span class="id">A</span> -&gt; <span class="id">flow</span>) <span class="id">env</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">exists</span> <span class="id">x</span>, <span class="id">entails_under</span> <span class="id">env</span> (<span class="id">fctx</span> <span class="id">x</span>;; <span class="id">f1</span>) <span class="id">f</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">fall</span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id">fctx</span> <span class="id">x</span>);; <span class="id">f1</span>) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">specializes</span> <span class="id">H0</span> <span class="id">x</span>.<br/>
&nbsp;&nbsp;<span class="id">applys</span>* <span class="id">s_seq</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_req_r0</span> : <span class="kwd">forall</span> <span class="id">f</span> <span class="id">f1</span> <span class="id">H</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">ens_</span> <span class="id">H</span>;; <span class="id">f</span>) <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f</span> (<span class="id">req</span> <span class="id">H</span> <span class="id">f1</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_req</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">applys</span> <span class="id">s_seq</span> (<span class="id">hr</span> \+ <span class="id">hp</span>) (<span class="id">norm</span> <span class="id">vunit</span>).<br/>
&nbsp;&nbsp;{ <span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">vunit</span>. <span class="kwd">exists</span> <span class="id">hp</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_hpure_l</span>. <span class="id">intuition</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">rewrite</span> &lt;- <span class="id">H3</span>. <span class="id">assumption</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_req_r</span> : <span class="kwd">forall</span> <span class="id">f</span> <span class="id">f1</span> <span class="id">H</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">ens_</span> <span class="id">H</span>;; <span class="id">f</span>) <span class="id">f1</span> &lt;-&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f</span> (<span class="id">req</span> <span class="id">H</span> <span class="id">f1</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>.<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id">ent_req_r0</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">finv</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H0</span> <span class="id">H8</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">finv</span> <span class="id">H1</span>. <span class="id">hinv</span> <span class="id">H1</span>. <span class="id">hinv</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span>. <span class="id">rew_fmap</span> *.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">finv</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H0</span> <span class="id">H4</span>. <span class="id">forwards</span>: <span class="id">H0</span>. <span class="id">reflexivity</span>. <span class="id">fmap_disjoint</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_req_r1</span> : <span class="kwd">forall</span> <span class="id">f</span> <span class="id">f1</span> <span class="id">H</span>,<br/>
&nbsp;&nbsp;<span class="id">entails</span> (<span class="id">ens_</span> <span class="id">H</span>;; <span class="id">f</span>) <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f</span> (<span class="id">req</span> <span class="id">H</span> <span class="id">f1</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span> ? ? ?.<br/>
&nbsp;&nbsp;<span class="id">applys</span> <span class="id">ent_entails_1</span> <span class="id">ent_req_r0</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_req_req</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">H1</span> <span class="id">H2</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;<span class="id">H2</span> ==&gt; <span class="id">H1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f1</span> <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">req</span> <span class="id">H1</span> <span class="id">f1</span>) (<span class="id">req</span> <span class="id">H2</span> <span class="id">f2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H3</span> <span class="kwd">as</span> <span class="id">H3</span>. <span class="id">specializes</span> <span class="id">H3</span> <span class="id">H6</span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_req_l</span> : <span class="kwd">forall</span> <span class="id">f</span> <span class="id">f1</span> <span class="id">P</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;<span class="id">P</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f1</span> <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">req</span> \[<span class="id">P</span>] <span class="id">f1</span>) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H1</span> <span class="kwd">as</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H1</span> <span class="id">empty_heap</span> <span class="id">h1</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="id">hintro</span>.<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id">fmap_eq</span>.<br/>
&nbsp;&nbsp;<span class="id">fmap_disjoint</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_ens_l</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">f</span> <span class="id">P</span>,<br/>
&nbsp;&nbsp;(<span class="id">P</span> -&gt; <span class="id">entails_under</span> <span class="id">env</span> <span class="id">empty</span> <span class="id">f</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">ens_</span> \[<span class="id">P</span>]) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">fdestr</span> <span class="id">H0</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">empty_intro</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_ens_r</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">f</span> <span class="id">P</span>,<br/>
&nbsp;&nbsp;<span class="id">P</span> -&gt; <span class="id">entails_under</span> <span class="id">env</span> <span class="id">f</span> <span class="id">empty</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f</span> (<span class="id">ens_</span> \[<span class="id">P</span>]).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H0</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">empty_inv</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ens_void_pure_intro</span>.<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_seq_ens_l</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">f</span> <span class="id">f1</span> <span class="id">P</span>,<br/>
&nbsp;&nbsp;(<span class="id">P</span> -&gt; <span class="id">entails_under</span> <span class="id">env</span> <span class="id">f1</span> <span class="id">f</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">ens_</span> \[<span class="id">P</span>];; <span class="id">f1</span>) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">fdestr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">fdestr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span>.<br/>
&nbsp;&nbsp;<span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_seq_ens_req</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">f</span> <span class="id">f1</span> <span class="id">H</span>,<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">ens_</span> <span class="id">H</span>;; <span class="id">f1</span>) <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f1</span> (<span class="id">req</span> <span class="id">H</span> <span class="id">f</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_req</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">s_seq</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_ens</span>. <span class="kwd">exists</span> <span class="id">vunit</span> <span class="id">hp</span>.<br/>
&nbsp;&nbsp;<span class="id">splits</span>*.<br/>
&nbsp;&nbsp;<span class="id">hintro</span>; <span class="id">jauto</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span>. <span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_seq_ens_r</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">f</span> <span class="id">f1</span> <span class="id">P</span>,<br/>
&nbsp;&nbsp;<span class="id">P</span> -&gt; <span class="id">entails_under</span> <span class="id">env</span> <span class="id">f</span> <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f</span> (<span class="id">ens_</span> \[<span class="id">P</span>];; <span class="id">f1</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">applys</span> <span class="id">s_seq</span> <span class="id">h1</span> (<span class="id">norm</span> <span class="id">vunit</span>).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ens_void_pure_intro</span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H0</span>. <span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_ens_single_pure</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">P</span> <span class="id">P1</span>,<br/>
&nbsp;&nbsp;(<span class="id">P1</span> -&gt; <span class="id">P</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">ens_</span> \[<span class="id">P1</span>]) (<span class="id">ens_</span> \[<span class="id">P</span>]).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">fdestr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">vunit</span>. <span class="kwd">exists</span> <span class="id">empty_heap</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span> <span class="kwd">in</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">hintro</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">hintro</span>.<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_ens_single</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">H</span> <span class="id">H1</span>,<br/>
&nbsp;&nbsp;(<span class="id">H1</span> ==&gt; <span class="id">H</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">ens_</span> <span class="id">H1</span>) (<span class="id">ens_</span> <span class="id">H</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H2</span> <span class="kwd">as</span> <span class="id">H2</span>. <span class="id">destr</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_hpure_l</span> <span class="kwd">in</span> <span class="id">H2</span>. <span class="id">destruct</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H0</span> <span class="kwd">in</span> <span class="id">H5</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">v</span>. <span class="kwd">exists</span> <span class="id">h3</span>.<br/>
&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_hpure_l</span>. <span class="id">intuition</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_unk_single</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">xf</span> <span class="id">x</span> <span class="id">r</span>,<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">unk</span> <span class="id">xf</span> <span class="id">x</span> <span class="id">r</span>) (<span class="id">unk</span> <span class="id">xf</span> <span class="id">x</span> <span class="id">r</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">apply</span> <span class="id">entails_under_refl</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_unk</span> : <span class="kwd">forall</span> <span class="id">s</span> <span class="id">xf</span> <span class="id">x</span> <span class="id">v</span> <span class="id">fn</span>,<br/>
&nbsp;&nbsp;<span class="id">Fmap.read</span> <span class="id">s</span> <span class="id">xf</span> = <span class="id">fn</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">s</span> (<span class="id">unk</span> <span class="id">xf</span> <span class="id">x</span> <span class="id">v</span>) (<span class="id">fn</span> <span class="id">x</span> <span class="id">v</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">unk_inv</span>.<br/>
&nbsp;&nbsp;<span class="id">exact</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_unk_conv</span> : <span class="kwd">forall</span> <span class="id">s</span> <span class="id">v</span> <span class="id">fn</span> <span class="id">xf</span> <span class="id">x</span>,<br/>
&nbsp;&nbsp;<span class="id">Fmap.read</span> <span class="id">s</span> <span class="id">xf</span> = <span class="id">fn</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">s</span> (<span class="id">fn</span> <span class="id">x</span> <span class="id">v</span>) (<span class="id">unk</span> <span class="id">xf</span> <span class="id">x</span> <span class="id">v</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;the&nbsp;converse&nbsp;is&nbsp;not&nbsp;possible&nbsp;to&nbsp;prove&nbsp;because&nbsp;reduction&nbsp;of&nbsp;a&nbsp;ufun<br/>
&nbsp;&nbsp;&nbsp;&nbsp;returns&nbsp;an&nbsp;arbitrary&nbsp;flow,&nbsp;which&nbsp;isn't&nbsp;guaranteed&nbsp;to&nbsp;have&nbsp;the&nbsp;same<br/>
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;as&nbsp;[unk&nbsp;xf].&nbsp;the&nbsp;other&nbsp;direction&nbsp;is&nbsp;fine&nbsp;because&nbsp;of&nbsp;the&nbsp;semantics<br/>
&nbsp;&nbsp;&nbsp;&nbsp;of&nbsp;unk.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;note&nbsp;that&nbsp;this&nbsp;is&nbsp;an&nbsp;implementation&nbsp;issue&nbsp;due&nbsp;to&nbsp;the&nbsp;use&nbsp;of&nbsp;hoas&nbsp;for&nbsp;ufuns;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;conceptually&nbsp;this&nbsp;is&nbsp;an&nbsp;equivalence.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;the&nbsp;level&nbsp;of&nbsp;[satisfies],&nbsp;however,&nbsp;it&nbsp;is&nbsp;possible&nbsp;to&nbsp;go<br/>
&nbsp;&nbsp;&nbsp;&nbsp;backwards&nbsp;if&nbsp;we&nbsp;constrain&nbsp;the&nbsp;result;&nbsp;see&nbsp;[unk_inv_bi].&nbsp;this&nbsp;is&nbsp;also<br/>
&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;reason&nbsp;we&nbsp;don't&nbsp;have&nbsp;bientails_under,&nbsp;as&nbsp;this&nbsp;is&nbsp;the&nbsp;only&nbsp;rule<br/>
&nbsp;&nbsp;&nbsp;&nbsp;which&nbsp;uses&nbsp;it,&nbsp;and&nbsp;it&nbsp;would&nbsp;have&nbsp;to&nbsp;talk&nbsp;about&nbsp;the&nbsp;result.&nbsp;*)</span><br/>
Abort.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_seq_unk</span> : <span class="kwd">forall</span> <span class="id">xf</span> <span class="id">fn</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">s</span> <span class="id">x</span> <span class="id">r</span>,<br/>
&nbsp;&nbsp;<span class="id">Fmap.read</span> <span class="id">s</span> <span class="id">xf</span> = <span class="id">fn</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">s</span> (<span class="id">fn</span> <span class="id">x</span> <span class="id">r</span>;; <span class="id">f1</span>) <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">s</span> (<span class="id">unk</span> <span class="id">xf</span> <span class="id">x</span> <span class="id">r</span>;; <span class="id">f1</span>) <span class="id">f2</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrites</span> (&gt;&gt; <span class="id">ent_unk</span> <span class="id">s</span>); [ <span class="id">apply</span> <span class="id">H</span> | ].<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_unk_ex</span> : <span class="kwd">forall</span> <span class="id">s</span> <span class="id">xf</span> <span class="id">x</span> <span class="id">A</span> (<span class="id">vv</span>:<span class="id">A</span>-&gt;<span class="id">val</span>) <span class="id">fn</span>,<br/>
&nbsp;&nbsp;<span class="id">Fmap.read</span> <span class="id">s</span> <span class="id">xf</span> = <span class="id">fn</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">s</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">fex</span> (<span class="kwd">fun</span> (<span class="id">v</span>:<span class="id">A</span>) =&gt; <span class="id">unk</span> <span class="id">xf</span> <span class="id">x</span> (<span class="id">vv</span> <span class="id">v</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">fex</span> (<span class="kwd">fun</span> (<span class="id">v</span>:<span class="id">A</span>) =&gt; <span class="id">fn</span> <span class="id">x</span> (<span class="id">vv</span> <span class="id">v</span>))).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">b</span>.<br/>
&nbsp;&nbsp;<span class="id">lets</span> <span class="id">H0</span>: <span class="id">unk_inv</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">R</span>.<br/>
&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H0</span> <span class="id">xf</span> <span class="id">x</span> (<span class="id">vv</span> <span class="id">b</span>) <span class="id">fn</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_ex_seq_unk</span> : <span class="kwd">forall</span> <span class="id">s</span> <span class="id">xf</span> <span class="id">x</span> <span class="id">A</span> (<span class="id">vv</span>:<span class="id">A</span>-&gt;<span class="id">val</span>) <span class="id">fn</span> <span class="id">ctx</span>,<br/>
&nbsp;&nbsp;<span class="id">Fmap.read</span> <span class="id">s</span> <span class="id">xf</span> = <span class="id">fn</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">s</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">fex</span> (<span class="kwd">fun</span> (<span class="id">b</span>:<span class="id">A</span>) =&gt; <span class="id">unk</span> <span class="id">xf</span> <span class="id">x</span> (<span class="id">vv</span> <span class="id">b</span>);; <span class="id">ctx</span> <span class="id">b</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">fex</span> (<span class="kwd">fun</span> (<span class="id">b</span>:<span class="id">A</span>) =&gt; <span class="id">fn</span> <span class="id">x</span> (<span class="id">vv</span> <span class="id">b</span>);; <span class="id">ctx</span> <span class="id">b</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H1</span> <span class="kwd">as</span> <span class="id">H1</span>. <span class="id">destr</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">b</span>.<br/>
&nbsp;&nbsp;<span class="id">applys</span> <span class="id">s_seq</span> <span class="id">h3</span> <span class="id">R1</span>.<br/>
&nbsp;&nbsp;<span class="id">lets</span> <span class="id">H2</span>: <span class="id">unk_inv</span> <span class="id">s</span> <span class="id">h1</span> <span class="id">h3</span> <span class="id">R1</span>.<br/>
&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H2</span> <span class="id">xf</span> <span class="id">x</span> (<span class="id">vv</span> <span class="id">b</span>) <span class="id">fn</span>.<br/>
&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_disj_l</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">f3</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f1</span> <span class="id">f3</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f2</span> <span class="id">f3</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">disj</span> <span class="id">f1</span> <span class="id">f2</span>) <span class="id">f3</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H1</span> <span class="kwd">as</span> <span class="id">H1</span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_disj_r_l</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">f3</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f3</span> <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f3</span> (<span class="id">disj</span> <span class="id">f1</span> <span class="id">f2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_disj_l</span>.<br/>
&nbsp;&nbsp;<span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_disj_r_r</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">f3</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f3</span> <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f3</span> (<span class="id">disj</span> <span class="id">f1</span> <span class="id">f2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_disj_r</span>.<br/>
&nbsp;&nbsp;<span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_seq_disj_l</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">f3</span> <span class="id">f4</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">f1</span>;; <span class="id">f3</span>) <span class="id">f4</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">f2</span>;; <span class="id">f3</span>) <span class="id">f4</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">disj</span> <span class="id">f1</span> <span class="id">f2</span>;; <span class="id">f3</span>) <span class="id">f4</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">fdestr</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H1</span> <span class="kwd">as</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id">H</span>. <span class="id">applys</span>* <span class="id">s_seq</span>. }<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id">H0</span>. <span class="id">applys</span>* <span class="id">s_seq</span>. }<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_seq_ex_l</span> : <span class="kwd">forall</span> <span class="id">A</span> (<span class="id">f1</span>: <span class="id">A</span> -&gt; <span class="id">flow</span>) <span class="id">f2</span> <span class="id">f3</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">b</span>, <span class="id">entails_under</span> <span class="id">env</span> (<span class="id">f1</span> <span class="id">b</span>;; <span class="id">f2</span>) <span class="id">f3</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">fex</span> (<span class="kwd">fun</span> <span class="id">b</span> =&gt; <span class="id">f1</span> <span class="id">b</span>);; <span class="id">f2</span>) <span class="id">f3</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">fdestr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">fdestr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">applys</span> <span class="id">H</span> <span class="id">b</span>.<br/>
&nbsp;&nbsp;<span class="id">applys</span>* <span class="id">s_seq</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_ex_l</span> : <span class="kwd">forall</span> <span class="id">f</span> <span class="id">A</span> (<span class="id">fctx</span>:<span class="id">A</span> -&gt; <span class="id">flow</span>) <span class="id">env</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">b</span>, <span class="id">entails_under</span> <span class="id">env</span> (<span class="id">fctx</span> <span class="id">b</span>) <span class="id">f</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">fex</span> (<span class="kwd">fun</span> <span class="id">b</span> =&gt; <span class="id">fctx</span> <span class="id">b</span>)) <span class="id">f</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">fdestr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;<span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_ex_r</span> : <span class="kwd">forall</span> <span class="id">f</span> <span class="id">A</span> (<span class="id">fctx</span>:<span class="id">A</span> -&gt; <span class="id">flow</span>) <span class="id">env</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">exists</span> <span class="id">b</span>, <span class="id">entails_under</span> <span class="id">env</span> <span class="id">f</span> (<span class="id">fctx</span> <span class="id">b</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f</span> (<span class="id">fex</span> (<span class="kwd">fun</span> <span class="id">b</span> =&gt; <span class="id">fctx</span> <span class="id">b</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">b</span>.<br/>
&nbsp;&nbsp;<span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_ex</span> : <span class="kwd">forall</span> <span class="id">A</span> (<span class="id">fctx</span> <span class="id">fctx1</span>:<span class="id">A</span> -&gt; <span class="id">flow</span>) <span class="id">env</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">b</span>, <span class="id">entails_under</span> <span class="id">env</span> (<span class="id">fctx</span> <span class="id">b</span>) (<span class="id">fctx1</span> <span class="id">b</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">fex</span> (<span class="kwd">fun</span> <span class="id">b</span> =&gt; <span class="id">fctx</span> <span class="id">b</span>)) (<span class="id">fex</span> (<span class="kwd">fun</span> <span class="id">y</span> =&gt; <span class="id">fctx1</span> <span class="id">y</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">fdestr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">b</span>.<br/>
&nbsp;&nbsp;<span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_seq_ens_sl_ex</span>: <span class="kwd">forall</span> <span class="id">env</span> <span class="id">A</span> (<span class="id">c</span>:<span class="id">A</span>-&gt;<span class="id">hprop</span>) <span class="id">f</span>,<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">ens_</span> (\<span class="kwd">exists</span> <span class="id">x</span>, <span class="id">c</span> <span class="id">x</span>);; <span class="id">f</span>)<br/>
&nbsp;&nbsp;(<span class="id">∃</span> <span class="id">x</span>, <span class="id">ens_</span> (<span class="id">c</span> <span class="id">x</span>);; <span class="id">f</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">fdestr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H</span> <span class="kwd">as</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">hstar_hpure_l</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">destr</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hexists_inv</span> <span class="kwd">in</span> <span class="id">H4</span>.<br/>
&nbsp;&nbsp;<span class="id">destr</span> <span class="id">H4</span>. <span class="comment">(*&nbsp;get&nbsp;x&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">x</span>.<br/>
&nbsp;&nbsp;<span class="id">applys</span> <span class="id">s_seq</span> <span class="id">h3</span> (<span class="id">norm</span> <span class="id">vunit</span>).<br/>
&nbsp;&nbsp;- <span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">vunit</span>. <span class="kwd">exists</span> <span class="id">h0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">splits</span>*.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span>* <span class="id">hstar_hpure_l</span>.<br/>
&nbsp;&nbsp;- <span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id">ent_req_emp_l</span> : <span class="kwd">forall</span> <span class="id">env</span> <span class="id">f</span> <span class="id">f1</span>,<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> <span class="id">f</span> <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">entails_under</span> <span class="id">env</span> (<span class="id">req</span> \[] <span class="id">f</span>) <span class="id">f1</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">specializes</span> <span class="id">H0</span> <span class="id">empty_heap</span> <span class="id">h1</span> <span class="id">___</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hempty_intro</span>.<br/>
Qed.</div></details>
<br/>
<h1> Big-step semantics </h1>
<span class="kwd">Inductive</span> <span class="id">eresult</span> : <span class="kwd">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id">enorm</span> : <span class="id">val</span> -&gt; <span class="id">eresult</span>.<br/>
<br/>
<div class="doc">Program environment </div>
#[<span class="id">global</span>]<br/>
<span class="kwd">Instance</span> <span class="id">Inhab_val_expr</span> : <span class="id">Inhab</span> (<span class="id">val</span> -&gt; <span class="id">expr</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">pval</span> <span class="id">v</span>).<br/>
&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Definition</span> <span class="id">penv</span> := <span class="id">Fmap.fmap</span> <span class="id">var</span> (<span class="id">val</span> -&gt; <span class="id">expr</span>).<br/>
<span class="kwd">Definition</span> <span class="id">empty_penv</span> : <span class="id">penv</span> := <span class="id">Fmap.empty</span>.<br/>
<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">Re</span> : <span class="id">eresult</span>.<br/>
<span class="kwd">Implicit</span> <span class="id">Types</span> <span class="id">penv</span> : <span class="id">penv</span>.<br/>
<br/>
<span class="kwd">Inductive</span> <span class="id">bigstep</span> : <span class="id">penv</span> -&gt; <span class="id">heap</span> -&gt; <span class="id">expr</span> -&gt; <span class="id">heap</span> -&gt; <span class="id">eresult</span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id">eval_pval</span> : <span class="kwd">forall</span> <span class="id">h</span> <span class="id">v</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h</span> (<span class="id">pval</span> <span class="id">v</span>) <span class="id">h</span> (<span class="id">enorm</span> <span class="id">v</span>)<br/>
<br/>
<br/>
&nbsp;&nbsp;| <span class="id">eval_plet</span> : <span class="kwd">forall</span> <span class="id">h1</span> <span class="id">h3</span> <span class="id">h2</span> <span class="id">x</span> <span class="id">e1</span> <span class="id">e2</span> <span class="id">v</span> <span class="id">Re</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">e1</span> <span class="id">h3</span> (<span class="id">enorm</span> <span class="id">v</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h3</span> (<span class="id">subst</span> <span class="id">x</span> <span class="id">v</span> <span class="id">e2</span>) <span class="id">h2</span> <span class="id">Re</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h1</span> (<span class="id">plet</span> <span class="id">x</span> <span class="id">e1</span> <span class="id">e2</span>) <span class="id">h2</span> <span class="id">Re</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">eval_padd</span> : <span class="kwd">forall</span> <span class="id">h</span> <span class="id">x</span> <span class="id">y</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h</span> (<span class="id">padd</span> (<span class="id">pval</span> (<span class="id">vint</span> <span class="id">x</span>)) (<span class="id">pval</span> (<span class="id">vint</span> <span class="id">y</span>))) <span class="id">h</span> (<span class="id">enorm</span> (<span class="id">vint</span> (<span class="id">x</span> + <span class="id">y</span>)))<br/>
<br/>
&nbsp;&nbsp;| <span class="id">eval_pminus</span> : <span class="kwd">forall</span> <span class="id">h</span> <span class="id">x</span> <span class="id">y</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h</span> (<span class="id">pminus</span> (<span class="id">pval</span> (<span class="id">vint</span> <span class="id">x</span>)) (<span class="id">pval</span> (<span class="id">vint</span> <span class="id">y</span>))) <span class="id">h</span> (<span class="id">enorm</span> (<span class="id">vint</span> (<span class="id">x</span> - <span class="id">y</span>)))<br/>
<br/>
&nbsp;&nbsp;| <span class="id">eval_pfun</span> : <span class="kwd">forall</span> <span class="id">h</span> <span class="id">x</span> <span class="id">e</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h</span> (<span class="id">pfun</span> <span class="id">x</span> <span class="id">e</span>) <span class="id">h</span> (<span class="id">enorm</span> (<span class="id">vfun</span> <span class="id">x</span> <span class="id">e</span>))<br/>
<br/>
&nbsp;&nbsp;| <span class="id">eval_pfix</span> : <span class="kwd">forall</span> <span class="id">h</span> <span class="id">x</span> <span class="id">e</span> <span class="id">xf</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h</span> (<span class="id">pfix</span> <span class="id">xf</span> <span class="id">x</span> <span class="id">e</span>) <span class="id">h</span> (<span class="id">enorm</span> (<span class="id">vfix</span> <span class="id">xf</span> <span class="id">x</span> <span class="id">e</span>))<br/>
<br/>
&nbsp;&nbsp;| <span class="id">eval_app_fun</span> : <span class="kwd">forall</span> <span class="id">v1</span> <span class="id">v2</span> <span class="id">h</span> <span class="id">x</span> <span class="id">e</span> <span class="id">Re</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">v1</span> = <span class="id">vfun</span> <span class="id">x</span> <span class="id">e</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h</span> (<span class="id">subst</span> <span class="id">x</span> <span class="id">v2</span> <span class="id">e</span>) <span class="id">h</span> <span class="id">Re</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h</span> (<span class="id">papp</span> (<span class="id">pval</span> <span class="id">v1</span>) (<span class="id">pval</span> <span class="id">v2</span>)) <span class="id">h</span> <span class="id">Re</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">eval_app_fix</span> : <span class="kwd">forall</span> <span class="id">v1</span> <span class="id">v2</span> <span class="id">h</span> <span class="id">x</span> <span class="id">e</span> <span class="id">Re</span> <span class="id">xf</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">v1</span> = <span class="id">vfix</span> <span class="id">xf</span> <span class="id">x</span> <span class="id">e</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h</span> (<span class="id">subst</span> <span class="id">x</span> <span class="id">v2</span> (<span class="id">subst</span> <span class="id">xf</span> <span class="id">v1</span> <span class="id">e</span>)) <span class="id">h</span> <span class="id">Re</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h</span> (<span class="id">papp</span> (<span class="id">pval</span> <span class="id">v1</span>) (<span class="id">pval</span> <span class="id">v2</span>)) <span class="id">h</span> <span class="id">Re</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">eval_app_unk</span> : <span class="kwd">forall</span> <span class="id">va</span> <span class="id">h</span> <span class="id">Re</span> <span class="id">efn</span> <span class="id">xf</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Fmap.read</span> <span class="id">env</span> <span class="id">xf</span> = <span class="id">efn</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h</span> (<span class="id">efn</span> <span class="id">va</span>) <span class="id">h</span> <span class="id">Re</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h</span> (<span class="id">papp</span> (<span class="id">pvar</span> <span class="id">xf</span>) (<span class="id">pval</span> <span class="id">va</span>)) <span class="id">h</span> <span class="id">Re</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">eval_pif_true</span> : <span class="kwd">forall</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">Re</span> <span class="id">e1</span> <span class="id">e2</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">e1</span> <span class="id">h2</span> <span class="id">Re</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h1</span> (<span class="id">pif</span> (<span class="id">pval</span> (<span class="id">vbool</span> <span class="id">true</span>)) <span class="id">e1</span> <span class="id">e2</span>) <span class="id">h2</span> <span class="id">Re</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">eval_pif_false</span> : <span class="kwd">forall</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">Re</span> <span class="id">e1</span> <span class="id">e2</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">e2</span> <span class="id">h2</span> <span class="id">Re</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h1</span> (<span class="id">pif</span> (<span class="id">pval</span> (<span class="id">vbool</span> <span class="id">false</span>)) <span class="id">e1</span> <span class="id">e2</span>) <span class="id">h2</span> <span class="id">Re</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">eval_pref</span> : <span class="kwd">forall</span> <span class="id">h</span> <span class="id">v</span> <span class="id">p</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;~ <span class="id">Fmap.indom</span> <span class="id">h</span> <span class="id">p</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h</span> (<span class="id">pref</span> (<span class="id">pval</span> <span class="id">v</span>)) (<span class="id">Fmap.update</span> <span class="id">h</span> <span class="id">p</span> <span class="id">v</span>) (<span class="id">enorm</span> (<span class="id">vloc</span> <span class="id">p</span>))<br/>
<br/>
&nbsp;&nbsp;| <span class="id">eval_pderef</span> : <span class="kwd">forall</span> <span class="id">h</span> <span class="id">p</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Fmap.indom</span> <span class="id">h</span> <span class="id">p</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h</span> (<span class="id">pderef</span> (<span class="id">pval</span> (<span class="id">vloc</span> <span class="id">p</span>))) <span class="id">h</span> (<span class="id">enorm</span> (<span class="id">Fmap.read</span> <span class="id">h</span> <span class="id">p</span>))<br/>
<br/>
&nbsp;&nbsp;| <span class="id">eval_passign</span> : <span class="kwd">forall</span> <span class="id">h</span> <span class="id">p</span> <span class="id">v</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Fmap.indom</span> <span class="id">h</span> <span class="id">p</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h</span> (<span class="id">passign</span> (<span class="id">pval</span> (<span class="id">vloc</span> <span class="id">p</span>)) (<span class="id">pval</span> <span class="id">v</span>)) (<span class="id">Fmap.update</span> <span class="id">h</span> <span class="id">p</span> <span class="id">v</span>) (<span class="id">enorm</span> <span class="id">vunit</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">eval_passert</span> : <span class="kwd">forall</span> <span class="id">h</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">env</span> <span class="id">h</span> (<span class="id">passert</span> (<span class="id">pval</span> (<span class="id">vbool</span> <span class="id">true</span>))) <span class="id">h</span> (<span class="id">enorm</span> <span class="id">vunit</span>).<br/>
<br/>
<br/>
<h1> Program logic rules </h1>
<span class="kwd">Inductive</span> <span class="id">forward</span> : <span class="id">expr</span> -&gt; <span class="id">flow</span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id">fw_val</span>: <span class="kwd">forall</span> <span class="id">n</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forward</span> (<span class="id">pval</span> <span class="id">n</span>) (<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">res</span> =&gt; \[<span class="id">res</span> = <span class="id">n</span>]))<br/>
<br/>
<br/>
&nbsp;&nbsp;| <span class="id">fw_let</span>: <span class="kwd">forall</span> <span class="id">x</span> <span class="id">e1</span> <span class="id">e2</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forward</span> <span class="id">e1</span> <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">flow_res</span> <span class="id">f1</span> <span class="id">v</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forward</span> (<span class="id">subst</span> <span class="id">x</span> <span class="id">v</span> <span class="id">e2</span>) <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forward</span> (<span class="id">plet</span> <span class="id">x</span> <span class="id">e1</span> <span class="id">e2</span>) (<span class="id">f1</span> ;; <span class="id">f2</span>)<br/>
<br/>
&nbsp;&nbsp;| <span class="id">fw_if</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">e1</span> <span class="id">e2</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forward</span> <span class="id">e1</span> <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forward</span> <span class="id">e2</span> <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forward</span> (<span class="id">pif</span> (<span class="id">pval</span> (<span class="id">vbool</span> <span class="id">b</span>)) <span class="id">e1</span> <span class="id">e2</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">disj</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ens_</span> \[<span class="id">b</span> = <span class="id">true</span>];; <span class="id">f1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ens_</span> \[<span class="id">b</span> = <span class="id">false</span>];; <span class="id">f2</span>))<br/>
<br/>
&nbsp;&nbsp;| <span class="id">fw_deref</span>: <span class="kwd">forall</span> <span class="id">x</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forward</span> (<span class="id">pderef</span> (<span class="id">pval</span> (<span class="id">vloc</span> <span class="id">x</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">fall</span> (<span class="kwd">fun</span> <span class="id">y</span> =&gt; (<span class="id">req</span> (<span class="id">x</span>~~&gt;<span class="id">y</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">res</span> =&gt; \[<span class="id">res</span> = <span class="id">y</span>] \* <span class="id">x</span>~~&gt;<span class="id">y</span>)))))<br/>
<br/>
&nbsp;&nbsp;| <span class="id">fw_ref</span>: <span class="kwd">forall</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forward</span> (<span class="id">pref</span> (<span class="id">pval</span> <span class="id">v</span>)) (<span class="id">fex</span> (<span class="kwd">fun</span> <span class="id">y</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; \[<span class="id">r</span> = <span class="id">vloc</span> <span class="id">y</span>] \* <span class="id">y</span>~~&gt;<span class="id">v</span>))))<br/>
<br/>
&nbsp;&nbsp;| <span class="id">fw_assign</span>: <span class="kwd">forall</span> <span class="id">x</span> <span class="id">y</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forward</span> (<span class="id">passign</span> (<span class="id">pval</span> (<span class="id">vloc</span> <span class="id">x</span>)) (<span class="id">pval</span> <span class="id">y</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">req</span> (<span class="id">x</span>~~&gt;<span class="id">v</span>) (<span class="id">ens_</span> (<span class="id">x</span>~~&gt;<span class="id">y</span>)))<br/>
<br/>
&nbsp;&nbsp;| <span class="id">fw_assert</span>: <span class="kwd">forall</span> <span class="id">b</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forward</span> (<span class="id">passert</span> (<span class="id">pval</span> (<span class="id">vbool</span> <span class="id">b</span>))) (<span class="id">req_</span> \[<span class="id">b</span> = <span class="id">true</span>])<br/>
<br/>
&nbsp;&nbsp;| <span class="id">fw_app_fun</span>: <span class="kwd">forall</span> <span class="id">vf</span> <span class="id">x</span> <span class="id">e</span> <span class="id">va</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">vf</span> = <span class="id">vfun</span> <span class="id">x</span> <span class="id">e</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forward</span> (<span class="id">subst</span> <span class="id">x</span> <span class="id">va</span> <span class="id">e</span>) <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forward</span> (<span class="id">papp</span> (<span class="id">pval</span> <span class="id">vf</span>) (<span class="id">pval</span> <span class="id">va</span>)) <span class="id">f</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">fw_app_fix</span>: <span class="kwd">forall</span> <span class="id">vf</span> <span class="id">x</span> <span class="id">e</span> <span class="id">va</span> <span class="id">f</span> <span class="id">xf</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">vf</span> = <span class="id">vfix</span> <span class="id">xf</span> <span class="id">x</span> <span class="id">e</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forward</span> (<span class="id">subst</span> <span class="id">x</span> <span class="id">va</span> (<span class="id">subst</span> <span class="id">xf</span> <span class="id">vf</span> <span class="id">e</span>)) <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forward</span> (<span class="id">papp</span> (<span class="id">pval</span> <span class="id">vf</span>) (<span class="id">pval</span> <span class="id">va</span>)) <span class="id">f</span><br/>
<br/>
&nbsp;&nbsp;| <span class="id">fw_app_unk</span>: <span class="kwd">forall</span> <span class="id">xf</span> <span class="id">va</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forward</span> (<span class="id">papp</span> (<span class="id">pvar</span> <span class="id">xf</span>) (<span class="id">pval</span> <span class="id">va</span>)) (<span class="id">fex</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; <span class="id">unk</span> <span class="id">xf</span> <span class="id">va</span> <span class="id">r</span>)).<br/>
<br/>
<br/>
<span class="kwd">Module</span> <span class="id">Soundness</span>.<br/>
<br/>
<h1> Specification assertions </h1>
<div class="doc">A <i>specification assertion</i> is our equivalent of a (semantic) Hoare triple: a valid one ensures ensures that the given program satisfies the given specification. </div>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">pair_valid_under</span> <span class="id">penv</span> <span class="id">env</span> <span class="id">e</span> <span class="id">f</span> : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">penv</span> <span class="id">h1</span> <span class="id">e</span> <span class="id">h2</span> (<span class="id">enorm</span> <span class="id">v</span>) -&gt; <span class="id">satisfies</span> <span class="id">env</span> <span class="id">h1</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">v</span>) <span class="id">f</span>.<br/>
<br/>
<div class="doc">Roughly, this says that for every binding in the program environment, we can find a "corresponding" one in the spec environment, where "corresponding" means related by a valid specification assertion. </div>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">env_compatible</span> <span class="id">penv</span> <span class="id">env</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">pfn</span> <span class="id">xf</span> <span class="id">x</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Fmap.read</span> <span class="id">penv</span> <span class="id">xf</span> = <span class="id">pfn</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">sfn</span>, <span class="id">Fmap.read</span> <span class="id">env</span> <span class="id">xf</span> = <span class="id">sfn</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">v</span>, <span class="id">pair_valid_under</span> <span class="id">penv</span> <span class="id">env</span> (<span class="id">pfn</span> <span class="id">x</span>) (<span class="id">sfn</span> <span class="id">x</span> <span class="id">v</span>).<br/>
<br/>
<div class="doc">The full definition requires compatible environments. </div>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">spec_assert</span> (<span class="id">e</span>: <span class="id">expr</span>) (<span class="id">f</span>: <span class="id">flow</span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">penv</span> <span class="id">env</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">env_compatible</span> <span class="id">penv</span> <span class="id">env</span> -&gt; <span class="id">pair_valid_under</span> <span class="id">penv</span> <span class="id">env</span> <span class="id">e</span> <span class="id">f</span>.<br/>
<br/>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">Proper_spec_assert</span> : <span class="id">Proper</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">eq</span> ====&gt; <span class="id">entails</span> ====&gt; <span class="id">impl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>, <span class="id">Proper</span>, <span class="id">respectful</span>, <span class="id">impl</span>, <span class="id">spec_assert</span>, <span class="id">pair_valid_under</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eauto</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
<div class="doc">Structural rules </div>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">sem_consequence</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">e</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f1</span> <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> <span class="id">e</span> <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> <span class="id">e</span> <span class="id">f2</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">introv</span> <span class="id">He</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">He</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eauto</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
<div class="doc">Rules for program constructs </div>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">sem_pval</span>: <span class="kwd">forall</span> <span class="id">n</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> (<span class="id">pval</span> <span class="id">n</span>) (<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">res</span> =&gt; \[<span class="id">res</span> = <span class="id">n</span>])).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span>. <span class="id">introv</span> <span class="id">Hc</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;appeal&nbsp;to&nbsp;how&nbsp;e&nbsp;executes&nbsp;to&nbsp;tell&nbsp;us&nbsp;about&nbsp;the&nbsp;heaps&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">Hb</span> <span class="kwd">as</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;justify&nbsp;that&nbsp;the&nbsp;staged&nbsp;formula&nbsp;describes&nbsp;the&nbsp;heap&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ens_pure_intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">reflexivity</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">sem_plet</span>: <span class="kwd">forall</span> <span class="id">x</span> <span class="id">e1</span> <span class="id">e2</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> <span class="id">e1</span> <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">flow_res</span> <span class="id">f1</span> <span class="id">v</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> (<span class="id">subst</span> <span class="id">x</span> <span class="id">v</span> <span class="id">e2</span>) <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> (<span class="id">plet</span> <span class="id">x</span> <span class="id">e1</span> <span class="id">e2</span>) (<span class="id">f1</span>;; <span class="id">f2</span>).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span>, <span class="id">pair_valid_under</span>. <span class="id">introv</span> <span class="id">Hc</span> <span class="id">Hb</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;reason&nbsp;about&nbsp;how&nbsp;the&nbsp;let&nbsp;executes&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">Hb</span> <span class="kwd">as</span>. <span class="id">introv</span> <span class="id">He1</span> <span class="id">He2</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;use&nbsp;the&nbsp;specification&nbsp;assertion&nbsp;we&nbsp;have&nbsp;about&nbsp;e1&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lets</span> <span class="id">H3</span>: <span class="id">H</span> <span class="id">env</span> <span class="id">He1</span>. <span class="id">exact</span> <span class="id">Hc</span>. <span class="id">clear</span> <span class="id">H</span> <span class="id">He1</span>. <span class="id">sort</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;we&nbsp;need&nbsp;to&nbsp;know&nbsp;that&nbsp;spec&nbsp;value&nbsp;and&nbsp;program&nbsp;value&nbsp;are&nbsp;the&nbsp;same&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H0</span> <span class="id">H3</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">injects</span> <span class="id">H0</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;know&nbsp;about&nbsp;f2&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H1</span> <span class="id">env</span> <span class="id">h3</span> <span class="id">h2</span> <span class="id">v0</span> <span class="id">He2</span>. <span class="id">clear</span> <span class="id">He2</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span>* <span class="id">s_seq</span> <span class="id">h3</span> (<span class="id">norm</span> <span class="id">v</span>).<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">sem_pif</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">e1</span> <span class="id">e2</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> <span class="id">e1</span> <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> <span class="id">e2</span> <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> (<span class="id">pif</span> (<span class="id">pval</span> (<span class="id">vbool</span> <span class="id">b</span>)) <span class="id">e1</span> <span class="id">e2</span>) (<span class="id">disj</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ens_</span> \[<span class="id">b</span> = <span class="id">true</span>];; <span class="id">f1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ens_</span> \[<span class="id">b</span> = <span class="id">false</span>];; <span class="id">f2</span>)).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">introv</span> <span class="id">Ht</span> <span class="id">Hf</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span>. <span class="id">introv</span> <span class="id">Hc</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">Hb</span> <span class="kwd">as</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="comment">(*&nbsp;true&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span> <span class="kwd">in</span> <span class="id">Ht</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">Ht</span> <span class="id">env</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_disj_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">s_seq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ens_void_pure_intro</span>. <span class="id">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="comment">(*&nbsp;false&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span> <span class="kwd">in</span> <span class="id">Hf</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">Hf</span> <span class="id">env</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_disj_r</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">s_seq</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ens_void_pure_intro</span>. <span class="id">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">sem_pif_ignore_cond</span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">e1</span> <span class="id">e2</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> <span class="id">e1</span> <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> <span class="id">e2</span> <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> (<span class="id">pif</span> <span class="id">b</span> <span class="id">e1</span> <span class="id">e2</span>) (<span class="id">disj</span> <span class="id">f1</span> <span class="id">f2</span>).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">introv</span> <span class="id">Ht</span> <span class="id">Hf</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span>. <span class="id">introv</span> <span class="id">Hc</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">Hb</span> <span class="kwd">as</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="comment">(*&nbsp;true&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span> <span class="kwd">in</span> <span class="id">Ht</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">Ht</span> <span class="id">env</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">now</span> <span class="id">apply</span> <span class="id">s_disj_l</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="comment">(*&nbsp;false&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span> <span class="kwd">in</span> <span class="id">Hf</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">Hf</span> <span class="id">env</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">now</span> <span class="id">apply</span> <span class="id">s_disj_r</span>. }<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">sem_pderef</span>: <span class="kwd">forall</span> <span class="id">x</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> (<span class="id">pderef</span> (<span class="id">pval</span> (<span class="id">vloc</span> <span class="id">x</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">fall</span> (<span class="kwd">fun</span> <span class="id">y</span> =&gt; (<span class="id">req</span> (<span class="id">x</span>~~&gt;<span class="id">y</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">res</span> =&gt; \[<span class="id">res</span> = <span class="id">y</span>] \* <span class="id">x</span>~~&gt;<span class="id">y</span>))))).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">unfold</span> <span class="id">spec_assert</span>. <span class="id">introv</span> <span class="id">Hc</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">Hb</span> <span class="kwd">as</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>. <span class="id">intros</span> <span class="id">v</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">v</span>. <span class="kwd">exists</span> <span class="id">hp</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">f_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hsingle_inv</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H</span> <span class="kwd">in</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">Fmap.union_comm_of_disjoint</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">Fmap.read_union_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">Fmap.read_single</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">Fmap.indom_single</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">rewrite</span> <span class="id">hstar_hpure_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intuition</span>. }<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">sem_pref</span>: <span class="kwd">forall</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> (<span class="id">pref</span> (<span class="id">pval</span> <span class="id">v</span>)) (<span class="id">fex</span> (<span class="kwd">fun</span> <span class="id">y</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; \[<span class="id">r</span> = <span class="id">vloc</span> <span class="id">y</span>] \* <span class="id">y</span>~~&gt;<span class="id">v</span>)))).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span>. <span class="id">introv</span> <span class="id">Hc</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">Hb</span> <span class="kwd">as</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> (<span class="id">vloc</span> <span class="id">p</span>). <span class="kwd">exists</span> (<span class="id">Fmap.single</span> <span class="id">p</span> <span class="id">v</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forwards</span> <span class="id">H1</span>: <span class="id">Fmap.disjoint_single_of_not_indom</span> <span class="id">h1</span> <span class="id">p</span> <span class="id">v</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">unfold</span> <span class="id">not</span>. <span class="id">exact</span> <span class="id">Hb</span>. }<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">rewrite</span> <span class="id">hstar_hpure_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hsingle_intro</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">rewrite</span> <span class="id">Fmap.union_comm_of_disjoint</span>; <span class="id">only</span> 2: <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">Fmap.update_eq_union_single</span>. }<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">sem_passign</span>: <span class="kwd">forall</span> <span class="id">x</span> <span class="id">y</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> (<span class="id">passign</span> (<span class="id">pval</span> (<span class="id">vloc</span> <span class="id">x</span>)) (<span class="id">pval</span> <span class="id">y</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">req</span> (<span class="id">x</span>~~&gt;<span class="id">v</span>) (<span class="id">ens_</span> (<span class="id">x</span>~~&gt;<span class="id">y</span>))).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span>. <span class="id">introv</span> <span class="id">Hc</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">Hb</span> <span class="kwd">as</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">vunit</span>. <span class="kwd">exists</span> (<span class="id">Fmap.update</span> <span class="id">hp</span> <span class="id">x</span> <span class="id">y</span>).<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;the&nbsp;heap&nbsp;reasoning&nbsp;is&nbsp;most&nbsp;of&nbsp;this&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intuition</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">rewrite</span> <span class="id">hstar_hpure_l</span>. <span class="id">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hsingle_inv</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">Fmap.update_single</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hsingle_intro</span>. }<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">rewrite</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hsingle_inv</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrites</span>* <span class="id">Fmap.update_union_r</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">rewrite</span> <span class="id">H</span> <span class="kwd">in</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">not</span>; <span class="id">applys</span> <span class="id">Fmap.disjoint_inv_not_indom_both</span> (<span class="id">Fmap.single</span> <span class="id">x</span> <span class="id">v</span>) <span class="id">hr</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">fmap_disjoint</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">Fmap.indom_single</span>. } }<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id">Fmap.disjoint_sym</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span> <span class="id">Fmap.disjoint_update_l</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">fmap_disjoint</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hsingle_inv</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">Fmap.indom_single</span>. }<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">sem_passert</span>: <span class="kwd">forall</span> <span class="id">b</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> (<span class="id">passert</span> (<span class="id">pval</span> (<span class="id">vbool</span> <span class="id">b</span>))) (<span class="id">req_</span> \[<span class="id">b</span> = <span class="id">true</span>]).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span>. <span class="id">introv</span> <span class="id">Hc</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">Hb</span> <span class="kwd">as</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hpure_inv</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">destruct</span> <span class="id">H</span>. <span class="id">rewrite</span> <span class="id">H2</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="id">rew_fmap</span>. <span class="id">rewrite</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">empty_intro</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">sem_papp_fun</span>: <span class="kwd">forall</span> <span class="id">vf</span> <span class="id">x</span> <span class="id">e</span> <span class="id">va</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">vf</span> = <span class="id">vfun</span> <span class="id">x</span> <span class="id">e</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> (<span class="id">subst</span> <span class="id">x</span> <span class="id">va</span> <span class="id">e</span>) <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> (<span class="id">papp</span> (<span class="id">pval</span> <span class="id">vf</span>) (<span class="id">pval</span> <span class="id">va</span>)) <span class="id">f</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span>. <span class="id">introv</span> <span class="id">Hc</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">Hb</span> <span class="kwd">as</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">introv</span> <span class="id">H</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">injection</span> <span class="id">H</span>; <span class="id">intros</span>; <span class="id">subst</span> <span class="id">e0</span> <span class="id">x0</span>; <span class="id">clear</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H0</span> <span class="id">env</span> <span class="id">Hb</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">intros</span>. <span class="id">false</span>. }<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">sem_papp_fix</span>: <span class="kwd">forall</span> <span class="id">vf</span> <span class="id">x</span> <span class="id">e</span> <span class="id">va</span> <span class="id">f</span> <span class="id">xf</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">vf</span> = <span class="id">vfix</span> <span class="id">xf</span> <span class="id">x</span> <span class="id">e</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> (<span class="id">subst</span> <span class="id">x</span> <span class="id">va</span> (<span class="id">subst</span> <span class="id">xf</span> <span class="id">vf</span> <span class="id">e</span>)) <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> (<span class="id">papp</span> (<span class="id">pval</span> <span class="id">vf</span>) (<span class="id">pval</span> <span class="id">va</span>)) <span class="id">f</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span>. <span class="id">introv</span> <span class="id">Hc</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">Hb</span> <span class="kwd">as</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">intros</span>. <span class="id">false</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">introv</span> <span class="id">H</span> <span class="id">Hb</span>. <span class="id">injection</span> <span class="id">H</span>; <span class="id">intros</span>; <span class="id">subst</span> <span class="id">e0</span> <span class="id">x0</span> <span class="id">xf0</span>; <span class="id">clear</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H0</span> <span class="id">env</span> <span class="id">Hb</span>. }<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">sem_papp_unk</span>: <span class="kwd">forall</span> <span class="id">xf</span> <span class="id">va</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> (<span class="id">papp</span> (<span class="id">pvar</span> <span class="id">xf</span>) (<span class="id">pval</span> <span class="id">va</span>)) (<span class="id">fex</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; <span class="id">unk</span> <span class="id">xf</span> <span class="id">va</span> <span class="id">r</span>)).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span>. <span class="id">introv</span> <span class="id">Hc</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">v</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">env_compatible</span> <span class="kwd">in</span> <span class="id">Hc</span>. <span class="id">specializes</span> <span class="id">Hc</span> <span class="id">va</span> <span class="id">___</span>. <span class="id">destr</span> <span class="id">Hc</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">s_unk</span>. { <span class="id">exact</span> <span class="id">H0</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H1</span> <span class="id">v</span> <span class="id">H6</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="id">Local</span> <span class="kwd">Notation</span> <span class="id">derivable</span> := <span class="id">forward</span>.<br/>
&nbsp;&nbsp;<span class="id">Local</span> <span class="kwd">Notation</span> <span class="id">valid</span> := <span class="id">spec_assert</span>.<br/>
<br/>
<h1> Soundness </h1>
&nbsp;&nbsp;<span class="kwd">Theorem</span> <span class="id">soundness</span> : <span class="kwd">forall</span> <span class="id">e</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">derivable</span> <span class="id">e</span> <span class="id">f</span> -&gt; <span class="id">valid</span> <span class="id">e</span> <span class="id">f</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">introv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">induction</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">sem_pval</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">eapply</span> <span class="id">sem_plet</span>; <span class="id">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">sem_pif</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">sem_pderef</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">sem_pref</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">sem_passign</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">sem_passert</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">eapply</span> <span class="id">sem_papp_fun</span>; <span class="id">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">eapply</span> <span class="id">sem_papp_fix</span>; <span class="id">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">eapply</span> <span class="id">sem_papp_unk</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
<span class="kwd">End</span> <span class="id">Soundness</span>.<br/>
<br/>
<span class="kwd">Module</span> <span class="id">HistoryTriples</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Import</span> <span class="id">Soundness</span>.<br/>
<br/>
<h1> History triples </h1>
<div class="doc">A <i>history triple</i> (i.e. not just a "triple", which typically refers to a Hoare triple) also constrains the history of a program. </div>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">hist_triple</span> <span class="id">fh</span> <span class="id">e</span> <span class="id">f</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">penv</span> <span class="id">env</span> <span class="id">h0</span> <span class="id">h1</span> <span class="id">h2</span> <span class="id">v</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h0</span> <span class="id">h1</span> <span class="id">R</span> <span class="id">fh</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">env_compatible</span> <span class="id">penv</span> <span class="id">env</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">bigstep</span> <span class="id">penv</span> <span class="id">h1</span> <span class="id">e</span> <span class="id">h2</span> (<span class="id">enorm</span> <span class="id">v</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">satisfies</span> <span class="id">env</span> <span class="id">h0</span> <span class="id">h2</span> (<span class="id">norm</span> <span class="id">v</span>) <span class="id">f</span>.<br/>
<br/>
<div class="doc">History triples are contravariant in the history. </div>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">Proper_hist_triple</span> : <span class="id">Proper</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">flip</span> <span class="id">entails</span> ====&gt; <span class="id">eq</span> ====&gt; <span class="id">entails</span> ====&gt; <span class="id">impl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>, <span class="id">Proper</span>, <span class="id">respectful</span>, <span class="id">impl</span>, <span class="id">hist_triple</span>, <span class="id">flip</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span> <span class="id">H4</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span> <span class="id">H5</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;#[<span class="id">global</span>]<br/>
&nbsp;&nbsp;<span class="kwd">Instance</span> <span class="id">Proper_hist_triple_bi</span> : <span class="id">Proper</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">bientails</span> ====&gt; <span class="id">eq</span> ====&gt; <span class="id">bientails</span> ====&gt; <span class="id">impl</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">entails</span>, <span class="id">Proper</span>, <span class="id">respectful</span>, <span class="id">impl</span>, <span class="id">hist_triple</span>, <span class="id">flip</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span> <span class="id">H4</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span> <span class="id">H5</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
<div class="doc">Structural rules </div>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">hist_conseq</span> : <span class="kwd">forall</span> <span class="id">f1</span> <span class="id">f2</span> <span class="id">f3</span> <span class="id">f4</span> <span class="id">e</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f1</span> <span class="id">f3</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">entails</span> <span class="id">f4</span> <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">f3</span> <span class="id">e</span> <span class="id">f4</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">f1</span> <span class="id">e</span> <span class="id">f2</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">hist_triple</span>. <span class="id">introv</span> <span class="id">He1</span> <span class="id">He2</span> <span class="id">H</span>. <span class="id">introv</span> <span class="id">Hf1</span> <span class="id">Hc</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">He1</span> <span class="kwd">in</span> <span class="id">Hf1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H</span> <span class="id">Hf1</span> <span class="id">Hc</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">hist_frame</span> : <span class="kwd">forall</span> <span class="id">fh</span> <span class="id">fr</span> <span class="id">f</span> <span class="id">e</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">fh</span> <span class="id">e</span> <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> (<span class="id">fr</span>;; <span class="id">fh</span>) <span class="id">e</span> (<span class="id">fr</span>;; <span class="id">f</span>).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">hist_triple</span>. <span class="id">introv</span> <span class="id">H</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H0</span> <span class="kwd">as</span> <span class="id">H0</span>. <span class="id">destr</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span>* <span class="id">s_seq</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">hist_sem</span> : <span class="kwd">forall</span> <span class="id">f</span> <span class="id">e</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> <span class="id">e</span> <span class="id">f</span> &lt;-&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">empty</span> <span class="id">e</span> <span class="id">f</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">unfold</span> <span class="id">hist_triple</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">empty_inv</span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="id">destruct</span> <span class="id">H0</span>. <span class="id">subst</span> <span class="id">h0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">spec_assert</span>, <span class="id">pair_valid_under</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H</span> <span class="id">H1</span> <span class="id">H2</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">unfold</span> <span class="id">spec_assert</span>, <span class="id">pair_valid_under</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">hist_triple</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">empty_intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
<div class="doc">The (arbitrary) result of the history does not matter, enabling this rewriting. </div>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">hist_pre_result</span> : <span class="kwd">forall</span> <span class="id">fh</span> <span class="id">f</span> <span class="id">e</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> (<span class="id">fh</span>;; <span class="id">empty</span>) <span class="id">e</span> <span class="id">f</span> &lt;-&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">fh</span> <span class="id">e</span> <span class="id">f</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">hist_triple</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">iff</span> <span class="id">H</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">eapply</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">applys</span> <span class="id">s_seq</span>. <span class="id">eassumption</span>. <span class="id">apply</span> <span class="id">empty_intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">eassumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H10</span>. <span class="id">destr</span> <span class="id">H7</span>. <span class="id">hinv</span> <span class="id">H3</span>. <span class="id">hinv</span> <span class="id">H3</span>. <span class="id">hinv</span> <span class="id">H5</span>. <span class="id">subst</span>. <span class="id">rew_fmap</span> *. }<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
<div class="doc">History triples which only append to history can be derived directly from the history-frame rule. </div>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">hist_frame_sem</span>: <span class="kwd">forall</span> <span class="id">fh</span> <span class="id">e</span> <span class="id">f</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">spec_assert</span> <span class="id">e</span> <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">fh</span> <span class="id">e</span> (<span class="id">fh</span>;; <span class="id">f</span>).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">hist_sem</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lets</span> <span class="id">H3</span>: <span class="id">hist_frame</span> <span class="id">fh</span> <span class="id">H</span>. <span class="id">clear</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span>* <span class="id">hist_pre_result</span> <span class="kwd">in</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
<div class="doc">Rules for program constructs </div>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">hist_pval</span>: <span class="kwd">forall</span> <span class="id">n</span> <span class="id">fh</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">fh</span> (<span class="id">pval</span> <span class="id">n</span>) (<span class="id">fh</span>;; <span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">res</span> =&gt; \[<span class="id">res</span> = <span class="id">n</span>])).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">hist_triple</span>. <span class="id">introv</span> <span class="id">Hh</span> <span class="id">Hc</span> <span class="id">Hb</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span> <span class="id">s_seq</span> <span class="id">h1</span> <span class="id">R</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">lets</span> <span class="id">H</span>: <span class="id">sem_pval</span> <span class="id">n</span> <span class="id">Hc</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">pair_valid_under</span>, <span class="id">spec_assert</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Remark</span> <span class="id">hist_pval_via_frame</span>: <span class="kwd">forall</span> <span class="id">n</span> <span class="id">fh</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">fh</span> (<span class="id">pval</span> <span class="id">n</span>) (<span class="id">fh</span>;; <span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">res</span> =&gt; \[<span class="id">res</span> = <span class="id">n</span>])).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span> <span class="id">hist_frame_sem</span> (@<span class="id">sem_pval</span> <span class="id">n</span>).<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">hist_pref</span>: <span class="kwd">forall</span> <span class="id">v</span> <span class="id">fh</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">fh</span> (<span class="id">pref</span> (<span class="id">pval</span> <span class="id">v</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">fh</span>;; <span class="id">fex</span> (<span class="kwd">fun</span> <span class="id">y</span> =&gt;(<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; \[<span class="id">r</span> = <span class="id">vloc</span> <span class="id">y</span>] \* <span class="id">y</span> ~~&gt; <span class="id">v</span>)))).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span> <span class="id">hist_frame_sem</span> (@<span class="id">sem_pref</span> <span class="id">v</span>).<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">hist_pderef</span>: <span class="kwd">forall</span> <span class="id">x</span> <span class="id">fh</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">fh</span> (<span class="id">pderef</span> (<span class="id">pval</span> (<span class="id">vloc</span> <span class="id">x</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">fh</span>;; <span class="id">fall</span> (<span class="kwd">fun</span> <span class="id">y</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">req</span> (<span class="id">x</span> ~~&gt; <span class="id">y</span>) (<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">res</span> =&gt; \[<span class="id">res</span> = <span class="id">y</span>] \* <span class="id">x</span> ~~&gt; <span class="id">y</span>)))).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span> <span class="id">hist_frame_sem</span> (@<span class="id">sem_pderef</span> <span class="id">x</span>).<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">hist_passign</span>: <span class="kwd">forall</span> <span class="id">x</span> <span class="id">y</span> <span class="id">v</span> <span class="id">fh</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">fh</span> (<span class="id">passign</span> (<span class="id">pval</span> (<span class="id">vloc</span> <span class="id">x</span>)) (<span class="id">pval</span> <span class="id">y</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">fh</span>;; <span class="id">req</span> (<span class="id">x</span> ~~&gt; <span class="id">v</span>) (<span class="id">ens_</span> (<span class="id">x</span> ~~&gt; <span class="id">y</span>))).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span> <span class="id">hist_frame_sem</span> (@<span class="id">sem_passign</span> <span class="id">x</span>).<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">hist_passert</span>: <span class="kwd">forall</span> <span class="id">fh</span> <span class="id">b</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">fh</span> (<span class="id">passert</span> (<span class="id">pval</span> (<span class="id">vbool</span> <span class="id">b</span>))) (<span class="id">fh</span>;; <span class="id">req_</span> \[<span class="id">b</span> = <span class="id">true</span>]).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span> <span class="id">hist_frame_sem</span> (@<span class="id">sem_passert</span> <span class="id">b</span>).<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">hist_pif</span>: <span class="kwd">forall</span> <span class="id">fh</span> <span class="id">b</span> <span class="id">e1</span> <span class="id">e2</span> <span class="id">f1</span> <span class="id">f2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> (<span class="id">fh</span>;; <span class="id">ens_</span> \[<span class="id">b</span> = <span class="id">true</span>]) <span class="id">e1</span> <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> (<span class="id">fh</span>;; <span class="id">ens_</span> \[<span class="id">b</span> = <span class="id">false</span>]) <span class="id">e2</span> <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">fh</span> (<span class="id">pif</span> (<span class="id">pval</span> (<span class="id">vbool</span> <span class="id">b</span>)) <span class="id">e1</span> <span class="id">e2</span>) (<span class="id">disj</span> <span class="id">f1</span> <span class="id">f2</span>).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">introv</span> <span class="id">He1</span> <span class="id">He2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">hist_triple</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">b</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">forwards</span>: <span class="id">He1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">applys</span> <span class="id">s_seq</span> <span class="id">h1</span> <span class="id">R</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id">ens_void_pure_intro</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ens_void_pure_intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">reflexivity</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">exact</span> <span class="id">H0</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H1</span> <span class="kwd">as</span> <span class="id">H1</span>. <span class="id">exact</span> <span class="id">H1</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_disj_l</span>. <span class="id">assumption</span>. }<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">forwards</span>: <span class="id">He2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">applys</span> <span class="id">s_seq</span> <span class="id">h1</span> <span class="id">R</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">pose</span> <span class="id">proof</span> (<span class="id">ens_void_pure_intro</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ens_void_pure_intro</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">reflexivity</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">exact</span> <span class="id">H0</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">inverts</span> <span class="id">H1</span> <span class="kwd">as</span> <span class="id">H1</span>. <span class="id">exact</span> <span class="id">H1</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">s_disj_r</span>. <span class="id">assumption</span>. }<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">hist_papp_fun</span>: <span class="kwd">forall</span> <span class="id">vf</span> <span class="id">x</span> <span class="id">e</span> <span class="id">va</span> <span class="id">f</span> <span class="id">fh</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">vf</span> = <span class="id">vfun</span> <span class="id">x</span> <span class="id">e</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">fh</span> (<span class="id">subst</span> <span class="id">x</span> <span class="id">va</span> <span class="id">e</span>) <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">fh</span> (<span class="id">papp</span> (<span class="id">pval</span> <span class="id">vf</span>) (<span class="id">pval</span> <span class="id">va</span>)) <span class="id">f</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">hist_triple</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H2</span> <span class="kwd">as</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">injects</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">hist_triple</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H0</span> <span class="id">H</span> <span class="id">H1</span> <span class="id">H9</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">false</span>. }<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">hist_papp_fix</span>: <span class="kwd">forall</span> <span class="id">vf</span> <span class="id">x</span> <span class="id">e</span> <span class="id">va</span> <span class="id">f</span> <span class="id">xf</span> <span class="id">fh</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">vf</span> = <span class="id">vfix</span> <span class="id">xf</span> <span class="id">x</span> <span class="id">e</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">fh</span> (<span class="id">subst</span> <span class="id">x</span> <span class="id">va</span> (<span class="id">subst</span> <span class="id">xf</span> <span class="id">vf</span> <span class="id">e</span>)) <span class="id">f</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">fh</span> (<span class="id">papp</span> (<span class="id">pval</span> <span class="id">vf</span>) (<span class="id">pval</span> <span class="id">va</span>)) <span class="id">f</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">hist_triple</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">H2</span> <span class="kwd">as</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">false</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">injects</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">hist_triple</span> <span class="kwd">in</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">H0</span> <span class="id">H</span> <span class="id">H1</span> <span class="id">H9</span>. }<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">hist_papp_unk</span>: <span class="kwd">forall</span> <span class="id">xf</span> <span class="id">va</span> <span class="id">fh</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">fh</span> (<span class="id">papp</span> (<span class="id">pvar</span> <span class="id">xf</span>) (<span class="id">pval</span> <span class="id">va</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">fh</span>;; <span class="id">fex</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; <span class="id">unk</span> <span class="id">xf</span> <span class="id">va</span> <span class="id">r</span>)).<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">applys</span> <span class="id">hist_frame_sem</span> <span class="id">fh</span> (@<span class="id">sem_papp_unk</span> <span class="id">xf</span> <span class="id">va</span>).<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
&nbsp;&nbsp;<span class="kwd">Lemma</span> <span class="id">hist_plet</span>: <span class="kwd">forall</span> <span class="id">fh</span> <span class="id">e1</span> <span class="id">f1</span> <span class="id">e2</span> <span class="id">f2</span> <span class="id">v</span> <span class="id">x</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">fh</span> <span class="id">e1</span> <span class="id">f1</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">flow_res</span> <span class="id">f1</span> <span class="id">v</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">f1</span> (<span class="id">subst</span> <span class="id">x</span> <span class="id">v</span> <span class="id">e2</span>) <span class="id">f2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">hist_triple</span> <span class="id">fh</span> (<span class="id">plet</span> <span class="id">x</span> <span class="id">e1</span> <span class="id">e2</span>) <span class="id">f2</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">introv</span> <span class="id">He1</span> <span class="id">Hres</span> <span class="id">He2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">hist_triple</span>. <span class="id">introv</span> <span class="id">Hfh</span> <span class="id">Hc</span> <span class="id">Hb</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;reason&nbsp;about&nbsp;how&nbsp;let&nbsp;executes,&nbsp;as&nbsp;the&nbsp;composition&nbsp;of&nbsp;e1&nbsp;and&nbsp;e2&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">inverts</span> <span class="id">Hb</span> <span class="kwd">as</span>. <span class="id">introv</span> <span class="id">Hb1</span> <span class="id">Hb2</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;reason&nbsp;about&nbsp;the&nbsp;execution&nbsp;of&nbsp;e1&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">hist_triple</span> <span class="kwd">in</span> <span class="id">He1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">He1</span> <span class="id">Hfh</span> <span class="id">Hc</span> <span class="id">Hb1</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;reason&nbsp;about&nbsp;the&nbsp;result&nbsp;of&nbsp;e1&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">Hres</span> <span class="id">He1</span>. <span class="id">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">injects</span> <span class="id">Hres</span>.<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;reason&nbsp;about&nbsp;the&nbsp;execution&nbsp;of&nbsp;e2&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">hist_triple</span> <span class="kwd">in</span> <span class="id">He2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specializes</span> <span class="id">He2</span> <span class="id">He1</span> <span class="id">Hc</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
<span class="kwd">End</span> <span class="id">HistoryTriples</span>.<br/>
<br/>
<span class="kwd">Module</span> <span class="id">ForwardExamples</span>.<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">e1_let</span> := (<span class="id">plet</span> <span class="string">"x"</span> (<span class="id">pval</span> (<span class="id">vint</span> 1)) (<span class="id">pvar</span> <span class="string">"x"</span>)).<br/>
&nbsp;&nbsp;<span class="kwd">Definition</span> <span class="id">f1</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; \[<span class="id">v</span> = <span class="id">vint</span> 1]) ;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">ens</span> (<span class="kwd">fun</span> <span class="id">r</span> =&gt; \[<span class="id">r</span> = <span class="id">vint</span> 1]).<br/>
<br/>
&nbsp;&nbsp;<span class="kwd">Example</span> <span class="id">ex1</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">forward</span> <span class="id">e1_let</span> <span class="id">f1</span>.<br/>
<details>
&nbsp;&nbsp;<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id">fw_let</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">apply</span> <span class="id">fw_val</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">unfold</span> <span class="id">flow_res</span>. <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">R</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">ens_pure_inv</span> <span class="kwd">in</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span>. <span class="id">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">fw_val</span>.<br/>
&nbsp;&nbsp;Qed.</div></details>
<br/>
<span class="kwd">End</span> <span class="id">ForwardExamples</span>.<br/>
<br/>
<h1> Correspondence with the paper </h1>
<h2> Section 2.1. A Simple Example </h2>
<div class="doc">In the file <a href="staged.Hello.html">Hello.v</a>. An additional example, which demonstrates preventing the use of a function argument which captures one of the input pointers, is included. </div>
<h2> Section 2.2. <span class="bracket"><span class="id">foldr</span></span> </h2>
<div class="doc">In the file <a href="staged.Foldr.html">Foldr.v</a>. Entailments <span class="bracket"><span class="id">foldr_sum</span></span> and <span class="bracket"><span class="id">foldr_sum_state</span></span> are both proved, as are those of the three examples which are difficult to handle with the conventional <span class="bracket"><span class="id">foldr</span></span> specification from the introduction. </div>
<div class="doc">The first one does require a separate heap-manipulating definition of <span class="bracket"><span class="id">foldr</span></span>; the others can be adapted to use it as well, at the cost of clarity and brevity of proofs. </div>
<div class="doc">The proof of the third one cannot be finished without a semantics for exceptions, which we do not cover in this paper. </div>
<h2> Section 3.1. Semantics of staged formulae </h2>
<div class="doc">The semantics of staged formulae is given as <a href="&num;satisfies">satisfies</a>. </div>
<div class="doc">There are a number of differences from the paper:
<ul>
<li>
 An environment is added to give interpretations for unknown functions (a similar one is added to the <a href="&num;bigstep">big-step semantics</a>)
</li>
<li>
 Stores are removed to sidestep impredicativity problems, and replaced with substitution
</li>
<li>
 The definition of <span class="bracket"><span class="id">req</span></span> is different, restoring its contravariance
</li>
</ul>
</div>
<h2> Section 3.2. Compaction </h2>
<div class="doc">Compaction is really just <a href="&num;entails">entailment</a>, so soundness (Theorem 1) is ensured by construction. </div>
<div class="doc">The six rules in Fig 7:
<ul>
<li>
 <a href="&num;norm_ens_false_l">norm_ens_false_l</a>
</li>
<li>
 <a href="&num;norm_empty_l">norm_empty_l</a>
</li>
<li>
 <a href="&num;norm_empty_r">norm_empty_r</a>
</li>
<li>
 <a href="&num;norm_req_req">norm_req_req</a>
</li>
<li>
 <a href="&num;norm_ens_ens_void_l">norm_ens_ens_void_l</a>
</li>
<li>
 <a href="&num;norm_ens_req_transpose">norm_ens_req_transpose</a> </li>
</ul>
</div>
<div class="doc">A definition of <a href="&num;biabduction">biabduction</a> is given and proved sound with respect to heap entailment. </div>
<h2> Section 4. Forward rules </h2>
<div class="doc">The reasoning rules for programs are first presented as a more primitive relation <a href="&num;forward">forward</a> between programs and staged formulae, without history. The validity of these rules for each program construct is defined as a collection of <i>specification assertions</i> <a href="&num;spec_assert">spec_assert</a> (analogous to semantic triples), and soundness (Theorem 2) is <a href="&num;soundness">explicitly proved</a>, under a new <a href="&num;env_compatible">env_compatible</a> condition. </div>
<div class="doc"><a href="&num;hist_triple"><i>History triples</i></a> (Fig 8) are then defined. Many of the resulting rules can be derived from specification assertions using the structural <i>history-frame rule</i> <a href="&num;hist_frame">hist_frame</a>. History triples are also defined semantically and are hence sound by construction. </div>
<div class="doc">Other differences from the paper:
<ul>
<li>
 The <a href="&num;sem_passert">assert</a> rule takes a value (or expression, under ANF), not a heap formula. No expressiveness is lost as it's still possible to assert things about the content of heap locations by first reading them.
</li>
<li>
 The <a href="&num;sem_papp_fun">fun</a>/<a href="&num;sem_papp_fun">fix</a> rules require function specifications to be given via triples, instead of via annotations in the syntax. An annotation can still be given by proving a lemma giving the function body a specification beforehand.
</li>
<li>
 The <a href="&num;sem_plet">let</a> rule substitutes (a symbolic value) into the program, instead of quantifying free variables
</li>
<li>
 The value of the location that <a href="&num;sem_pderef">deref</a> retrieves is universally quantified, to match the new definition for <span class="bracket"><span class="id">req</span></span> </li>
</ul>
</div>
<h2> Section 5. Entailment </h2>
<div class="doc"><a href="&num;entails">Entailment</a> is defined semantically, so soundness (Theorem 3) is ensured by construction. </div>
<div class="doc">The two entailment rules in the main paper
<ul>
<li>
 <a href="&num;entails_ens_seq">entails_ens_seq</a>
</li>
<li>
 <a href="&num;entails_req_seq">entails_req_seq</a> </li>
</ul>
</div>
<div class="doc">and the additional rules from Appendix G
<ul>
<li>
 <a href="&num;entails_func">entails_func</a>
</li>
<li>
 <a href="&num;entails_disj_right_l">entails_disj_right_l</a>
</li>
<li>
 <a href="&num;entails_disj_right_r">entails_disj_right_r</a>
</li>
<li>
 <a href="&num;entails_disj_left">entails_disj_left</a> </li>
</ul>
</div>
<div class="doc">are shown to be sound. The separation logic rules are the standard ones from SLF. </div>
<div class="doc">In practice, entailment proofs of interesting (higher-order/recursive) programs involve giving unknown functions specific interpretations using an environment. They thus involve the <a href="&num;entails_under">entails_under</a> sequent and use lemmas with the <span class="bracket"><span class="id">ent_</span></span> prefix instead. Manipulating such sequents neccessitates a significant number of new lemmas. </div>
<h2> Appendix D. Intersection </h2>
<div class="doc">This section is really about the completeness of biabduction. The main paper elides the case where two locations may not be known to be equal. A more complete definition is given as b_pts_diff/<a href="&num;b_pts_diff_single">b_pts_diff_single</a>, which works even without a known disquality between <span class="bracket"><span class="id">x</span></span> and <span class="bracket"><span class="id">y</span></span>. </div>
<div class="doc">Intersection (conjunction lifted to staged formulae) is an orthogonal concern. The example from the paper is proved correct using it in <a href="&num;ex3_intersection">ex3_intersection</a>. </div>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/xavierleroy/coq2html/">coq2html</a></div>
</body>
</html>
